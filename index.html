<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Planning Challenge | SOC-213 Family Sociology Game</title>
    <script src="glossary-data.js"></script>
    <script src="game-data.js"></script>
    <script src="game-engine.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #9b59b6;
            --primary-dark: #8e44ad;
            --secondary: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --navy: #2c3e50;
            --gray-light: #ecf0f1;
            --text-dark: #34495e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--navy) 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.95; }

        .content {
            padding: 40px;
        }

        .welcome-section {
            margin-bottom: 30px;
        }

        .welcome-section h2 {
            color: var(--navy);
            font-size: 2em;
            margin-bottom: 15px;
        }

        .welcome-section p {
            color: var(--text-dark);
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .info-box {
            background: #f0f8ff;
            border-left: 4px solid var(--primary);
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .info-box h3 {
            color: var(--navy);
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: var(--text-dark);
        }

        .info-box li {
            margin: 8px 0;
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .module-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .module-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(155, 89, 182, 0.2);
            transform: translateY(-2px);
        }

        .module-card.completed {
            background: #d4edda;
            border-color: var(--success);
        }

        .module-card.current {
            background: #fff3cd;
            border-color: var(--warning);
        }

        .module-number {
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5em;
            margin: 0 auto 15px auto;
        }

        .module-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 10px;
        }

        .module-status {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* ========== CHOICE CARD SYSTEM ========== */
        .choice-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .choice-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Hide radio inputs accessibly (not display:none which breaks in some browsers) */
        .choice-card input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        .choice-card:hover,
        .choice-card:focus-within {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(155, 89, 182, 0.2);
        }

        /* Keyboard focus indicator */
        .choice-card:focus-within {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }

        .choice-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8f4ff 0%, #fff 100%);
            box-shadow: 0 4px 16px rgba(155, 89, 182, 0.3);
            animation: selectPulse 0.3s ease-out;
        }

        @keyframes selectPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100px); opacity: 0; }
        }

        .choice-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .choice-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
        }

        .choice-label {
            font-weight: 600;
            color: var(--navy);
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .choice-brief {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        /* Profile Summary Styles */
        .profile-summary .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e1e8ed;
        }

        .profile-summary .profile-item:last-child {
            border-bottom: none;
        }

        .profile-summary .profile-label {
            font-weight: 600;
            color: var(--navy);
        }

        .profile-summary .profile-value {
            color: var(--primary);
            font-weight: 500;
        }

        /* High contrast focus for accessibility */
        @media (prefers-contrast: high) {
            .choice-card:focus-within {
                outline: 4px solid #000;
                outline-offset: 4px;
            }

            .choice-card.selected {
                border-width: 4px;
            }
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .choice-card,
            .choice-card:hover,
            .choice-card.selected {
                transition: none;
                animation: none;
            }
        }

        /* ========== CONSEQUENCE REVEAL PANEL ========== */
        .consequence-panel {
            display: none;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid var(--primary);
            border-radius: 0 12px 12px 0;
            padding: 24px;
            margin: 20px 0;
            animation: slideIn 0.4s ease-out;
        }

        .consequence-panel.visible {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .consequence-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .consequence-header .icon {
            font-size: 1.5em;
        }

        .consequence-header h4 {
            color: var(--navy);
            font-size: 1.1em;
            margin: 0;
        }

        .consequence-immediate {
            color: var(--text-dark);
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 1em;
        }

        .consequence-sociology {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .consequence-sociology h5 {
            color: var(--primary);
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .consequence-sociology p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .future-impacts {
            margin-top: 16px;
        }

        .future-impacts h5 {
            color: var(--navy);
            font-size: 0.9em;
            margin-bottom: 12px;
        }

        .future-impacts ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .future-impacts li {
            padding: 8px 0 8px 24px;
            position: relative;
            color: #555;
            font-size: 0.95em;
        }

        .future-impacts li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        /* ========== REFLECTION PROMPT ========== */
        .reflection-prompt {
            background: #fff9e6;
            border: 2px dashed #f0c14b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .reflection-prompt.consequence-reflection {
            background: #f0f7ff;
            border-color: #7eb8da;
            padding: 16px;
            margin-top: 16px;
        }

        .reflection-prompt.consequence-reflection h5 {
            color: #2980b9;
            font-size: 0.9em;
        }

        .reflection-prompt.consequence-reflection h5::before {
            content: 'ðŸ¤”';
        }

        .reflection-prompt.consequence-reflection textarea {
            min-height: 50px;
            font-size: 0.9em;
        }

        /* ========== ADVANTAGE INDICATOR ========== */
        .advantage-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .advantage-indicator.positive {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #28a745;
        }

        .advantage-indicator.negative {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .advantage-indicator.neutral {
            background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
            color: #383d41;
            border: 1px solid #6c757d;
        }

        .reflection-prompt h5 {
            color: #856404;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reflection-prompt h5::before {
            content: 'ðŸ’­';
        }

        .reflection-prompt p {
            color: #555;
            font-size: 0.95em;
            margin-bottom: 12px;
            font-style: italic;
        }

        .reflection-prompt textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
        }

        .reflection-prompt textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .reflection-optional {
            font-size: 0.85em;
            color: #888;
            margin-top: 8px;
        }

        /* ========== SOCIAL COMPARISON BAR ========== */
        .social-comparison {
            background: linear-gradient(135deg, #e8f4fd 0%, #d1e8fa 100%);
            border: 1px solid #7eb8da;
            border-radius: 12px;
            padding: 14px 18px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .social-comparison-icon {
            font-size: 1.5em;
        }

        .social-comparison-text {
            flex: 1;
            font-size: 0.95em;
            color: #2c5282;
        }

        .social-comparison-bar {
            width: 100px;
            height: 8px;
            background: #c3ddf0;
            border-radius: 4px;
            overflow: hidden;
        }

        .social-comparison-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182ce 0%, #2b6cb0 100%);
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        /* ========== TEXTBOOK QUOTE CARD ========== */
        .textbook-quote {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-left: 4px solid #805ad5;
            border-radius: 0 12px 12px 0;
            padding: 16px 20px;
            margin: 16px 0;
            position: relative;
        }

        .textbook-quote::before {
            content: 'ðŸ“–';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 1.5em;
            background: white;
            border-radius: 50%;
            padding: 4px;
        }

        .textbook-quote blockquote {
            margin: 0 0 12px 0;
            font-style: italic;
            color: #553c9a;
            line-height: 1.5;
        }

        .textbook-quote cite {
            font-size: 0.9em;
            color: #6b46c1;
            font-style: normal;
        }

        .textbook-quote .read-more {
            display: inline-block;
            margin-top: 8px;
            color: #805ad5;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
        }

        .textbook-quote .read-more:hover {
            text-decoration: underline;
        }

        /* ========== REFLECTION JOURNAL SIDEBAR ========== */
        .journal-toggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 8px;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: 600;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .journal-toggle:hover {
            padding-right: 12px;
        }

        .journal-sidebar {
            position: fixed;
            right: -360px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .journal-sidebar.open {
            right: 0;
        }

        .journal-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .journal-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .journal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .journal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .journal-entry {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .journal-entry-header {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 8px;
        }

        .journal-entry-text {
            font-size: 0.95em;
            line-height: 1.4;
        }

        .journal-input-area {
            padding: 16px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .journal-input-area textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-family: inherit;
            resize: none;
            margin-bottom: 10px;
        }

        .journal-input-area button {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ========== AUTO-SAVE INDICATOR ========== */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 998;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .save-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .save-indicator.saving {
            border-left: 4px solid #f39c12;
        }

        .save-indicator.saved {
            border-left: 4px solid #27ae60;
        }

        .save-indicator.error {
            border-left: 4px solid #e74c3c;
        }

        .save-indicator-icon {
            font-size: 1.2em;
        }

        .save-indicator-text {
            font-size: 0.9em;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .save-indicator.saving .save-indicator-icon {
            animation: spin 1s linear infinite;
        }

        /* ========== SAVE SLOTS ========== */
        .save-slots-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
        }

        .save-slots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .save-slots-header h3 {
            margin: 0;
            color: var(--navy);
        }

        .save-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .save-slot {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-slot:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .save-slot.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8f4ff 0%, #fff 100%);
        }

        .save-slot.empty {
            border-style: dashed;
            opacity: 0.7;
        }

        .save-slot-name {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .save-slot-info {
            font-size: 0.85em;
            color: #666;
        }

        .save-slot-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .save-slot-actions button {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
        }

        .save-slot-actions .load-btn {
            background: var(--primary);
            color: white;
        }

        .save-slot-actions .delete-btn {
            background: #f8d7da;
            color: #721c24;
        }

        /* ========== INSTRUCTOR DASHBOARD ========== */
        .instructor-dashboard {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 32px;
            color: white;
            margin: 20px 0;
        }

        .instructor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .instructor-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .instructor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .instructor-stat {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .instructor-stat-value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .instructor-stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 4px;
        }

        .choice-distribution {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .choice-distribution h4 {
            margin: 0 0 16px 0;
            font-size: 1.1em;
        }

        .distribution-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .distribution-label {
            width: 140px;
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .distribution-track {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            overflow: hidden;
            margin: 0 12px;
        }

        .distribution-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 0.5s ease-out;
        }

        .distribution-percent {
            width: 50px;
            text-align: right;
            font-weight: 600;
        }

        .discussion-prompts {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
        }

        .discussion-prompts h4 {
            margin: 0 0 16px 0;
        }

        .discussion-prompt-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        /* ========== SAVE PROMPT MODAL ========== */
        .save-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .save-prompt-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .save-prompt-modal {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .save-prompt-overlay.visible .save-prompt-modal {
            transform: scale(1);
        }

        .save-prompt-icon {
            font-size: 3em;
            margin-bottom: 16px;
        }

        .save-prompt-title {
            font-size: 1.4em;
            color: var(--navy);
            margin-bottom: 12px;
        }

        .save-prompt-text {
            color: #666;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .save-prompt-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .save-prompt-buttons button {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .save-prompt-buttons button:hover {
            transform: scale(1.05);
        }

        .save-prompt-buttons .save-btn {
            background: var(--primary);
            color: white;
        }

        .save-prompt-buttons .later-btn {
            background: #e9ecef;
            color: #495057;
        }

        /* ========== ADVANTAGE SCORE INDICATOR ========== */
        .advantage-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .advantage-indicator.positive {
            background: #d4edda;
            color: #155724;
        }

        .advantage-indicator.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .advantage-indicator.neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Advantage score change animation */
        .advantage-indicator.changed {
            animation: scoreChange 0.5s ease-out;
        }

        @keyframes scoreChange {
            0% { transform: scale(1); }
            30% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ========== JOURNEY PROGRESS VISUALIZATION ========== */
        .journey-progress {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            position: relative;
        }

        .journey-path {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 0 20px;
        }

        .journey-path::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 40px;
            right: 40px;
            height: 4px;
            background: #dee2e6;
            transform: translateY(-50%);
            z-index: 0;
        }

        .journey-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .journey-node.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .journey-node.current {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(155, 89, 182, 0.3);
            animation: currentPulse 2s infinite;
        }

        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(155, 89, 182, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(155, 89, 182, 0.1); }
        }

        .journey-node.locked {
            opacity: 0.5;
        }

        .journey-node-label {
            position: absolute;
            top: 48px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            color: #666;
            white-space: nowrap;
        }

        /* ========== MODULE SUMMARY PANEL ========== */
        .module-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 28px;
            margin: 24px 0;
            color: white;
        }

        .module-summary h3 {
            margin: 0 0 20px 0;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-summary-choices {
            display: grid;
            gap: 12px;
        }

        .summary-choice {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
        }

        .summary-choice-label {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .summary-choice-impact {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .summary-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .summary-stat {
            text-align: center;
            flex: 1;
        }

        .summary-stat-value {
            font-size: 2em;
            font-weight: 700;
        }

        .summary-stat-label {
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* ========== WHAT-IF REPLAY MODE ========== */
        .whatif-mode {
            display: none; /* Hidden by default */
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }

        /* Show what-if panels when mode is active */
        body.whatif-active .whatif-mode {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .whatif-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .whatif-header h4 {
            margin: 0;
            color: #8b4513;
        }

        .whatif-toggle {
            background: #8b4513;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .whatif-toggle:hover {
            background: #6b3410;
            transform: scale(1.05);
        }

        .whatif-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .whatif-path {
            background: white;
            border-radius: 12px;
            padding: 16px;
        }

        .whatif-path.original {
            border: 2px solid var(--primary);
        }

        .whatif-path.alternate {
            border: 2px dashed #8b4513;
        }

        .whatif-path h5 {
            margin: 0 0 12px 0;
            font-size: 0.95em;
        }

        /* ========== MOBILE RESPONSIVENESS ========== */
        @media (max-width: 768px) {
            .choice-cards-container {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .choice-card {
                padding: 16px 12px;
            }

            .choice-icon {
                font-size: 2em;
            }

            .choice-label {
                font-size: 0.95em;
            }

            .choice-brief {
                font-size: 0.8em;
            }

            .journey-path {
                flex-wrap: wrap;
                gap: 10px;
            }

            .journey-path::before {
                display: none;
            }

            .journey-node {
                width: 36px;
                height: 36px;
                font-size: 0.8em;
            }

            .whatif-comparison {
                grid-template-columns: 1fr;
            }

            .module-summary h3 {
                font-size: 1.2em;
            }

            .advantage-indicator {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .choice-cards-container {
                grid-template-columns: 1fr;
            }

            .choice-card {
                display: flex;
                align-items: center;
                text-align: left;
                gap: 16px;
                padding: 14px;
            }

            .choice-icon {
                font-size: 1.8em;
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .choice-content {
                flex: 1;
            }

            .summary-stats {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* ========== PRINT STYLES ========== */
        @media print {
            .choice-cards-container {
                display: block;
            }

            .choice-card {
                display: inline-block;
                width: auto;
                padding: 8px 16px;
                margin: 4px;
                border: 1px solid #333;
                box-shadow: none;
            }

            .choice-card:not(.selected) {
                opacity: 0.4;
            }

            .choice-card.selected {
                border: 2px solid #333;
                font-weight: bold;
            }

            .consequence-panel {
                display: block !important;
                background: #f5f5f5;
                border: 1px solid #333;
                page-break-inside: avoid;
            }

            .module-summary {
                background: #f0f0f0 !important;
                color: #333 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .journey-progress {
                page-break-inside: avoid;
            }

            .whatif-mode {
                display: none;
            }

            .advantage-indicator {
                border: 1px solid #333;
                background: white !important;
                color: #333 !important;
            }

            .reflection-prompt textarea {
                border: 1px solid #333;
                min-height: 60px;
            }
        }

        /* ========== SMOOTH SCROLL BEHAVIOR ========== */
        html {
            scroll-behavior: smooth;
        }

        .scroll-highlight {
            animation: highlightFade 1.5s ease-out;
        }

        @keyframes highlightFade {
            0% { background-color: rgba(155, 89, 182, 0.3); }
            100% { background-color: transparent; }
        }

        /* ========== ACHIEVEMENT BADGES ========== */
        .achievement-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #333;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: toastSlide 0.4s ease-out;
            transform: translateX(0);
        }

        .achievement-toast.hiding {
            animation: toastHide 0.3s ease-in forwards;
        }

        @keyframes toastSlide {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastHide {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(120%); opacity: 0; }
        }

        .achievement-icon {
            font-size: 2em;
        }

        .achievement-text h4 {
            margin: 0;
            font-size: 1em;
        }

        .achievement-text p {
            margin: 4px 0 0 0;
            font-size: 0.85em;
            opacity: 0.8;
        }

        .game-section {
            display: none !important;
        }

        .game-section.active {
            display: block !important;
        }

        /* Ensure proper stacking and spacing */
        .content.game-section {
            position: relative;
            z-index: 1;
        }

        .question-group {
            margin: 25px 0;
        }

        .question-group label {
            display: block;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 12px;
            font-size: 1.05em;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--gray-light);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-label:hover {
            background: #e8f4f8;
            border-color: var(--primary);
        }

        .option-label input[type="radio"],
        .option-label input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
        }

        .character-profile {
            background: linear-gradient(135deg, #f8f3ff 0%, #fff 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .profile-item {
            margin: 12px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .profile-label {
            font-weight: 600;
            color: var(--navy);
            display: block;
            margin-bottom: 5px;
        }

        .profile-value {
            color: var(--text-dark);
        }

        .export-section {
            margin: 30px 0;
            padding: 25px;
            background: #f0f8ff;
            border-radius: 12px;
            border: 2px solid var(--primary);
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-print {
            background: #e74c3c;
            color: white;
            font-weight: bold;
        }

        .btn-print:hover {
            background: #c0392b;
        }

        @media print {
            body * { visibility: hidden; }
            #printable, #printable * { visibility: visible; }
            #printable { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #155724;
            color: #155724;
        }

        .footer {
            background: var(--navy);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .content { padding: 25px; }
            .module-grid { grid-template-columns: 1fr; }
        }

        /* GLOSSARY TOOLTIP SYSTEM */
        .glossary-term {
            border-bottom: 1px dotted #9b59b6;
            cursor: help;
            position: relative;
            font-weight: 500;
        }

        .glossary-term:hover {
            color: #8e44ad;
            border-bottom-color: #8e44ad;
        }

        .glossary-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            width: 320px;
            font-size: 0.9em;
            line-height: 1.5;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 8px;
        }

        .glossary-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #2c3e50;
        }

        .glossary-term:hover .glossary-tooltip {
            display: block;
        }

        .glossary-tooltip strong {
            display: block;
            margin-bottom: 6px;
            font-size: 1.1em;
            color: #e8b3ff;
        }

        .glossary-tooltip em {
            display: block;
            margin-top: 8px;
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* MODULE LOCKING STATES */
        .module-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .module-card.locked:hover {
            transform: none;
            box-shadow: none;
            border-color: #e1e8ed;
        }

        .module-card.unlocked {
            border-color: #3498db;
            background: #fff;
        }

        .module-card.completed {
            border-color: #27ae60;
            background: #d4edda;
        }

        .module-status {
            font-size: 0.9em;
            margin-top: 8px;
            font-weight: 600;
        }

        /* PRINT-FRIENDLY PDF STYLES */
        .print-header, .print-signature {
            display: none;
        }

        @media print {
            body, *, .header {
                background: white !important;
                color: black !important;
                border-color: #333 !important;
            }

            .btn, .navigation, .module-select, .export-buttons-secondary {
                display: none !important;
            }

            .module-section {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            h1, h2, h3 {
                page-break-after: avoid;
            }

            .decision-summary {
                page-break-inside: avoid;
                border: 2px solid #333;
                padding: 12px;
                margin: 15px 0;
            }

            table {
                border-collapse: collapse;
                width: 100%;
                margin: 20px 0;
            }

            th, td {
                border: 1px solid #333;
                padding: 8px;
                text-align: left;
            }

            th {
                background: #f0f0f0 !important;
                font-weight: bold;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 2px solid #333;
            }

            .print-signature {
                display: block !important;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #333;
            }

            @page {
                margin: 1in;
                size: letter portrait;
            }
        }

        /* ========== EXERCISE SYSTEM CSS ========== */

        /* Section Progress Bar */
        .section-progress-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            border: 1px solid #e1e8ed;
        }

        .section-progress-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .section-progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 24px;
            right: 24px;
            height: 3px;
            background: #dee2e6;
            transform: translateY(-50%);
            z-index: 0;
        }

        .section-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .section-step:hover {
            transform: scale(1.05);
        }

        .section-step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .section-step.completed .section-step-indicator {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .section-step.current .section-step-indicator {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(155, 89, 182, 0.2);
        }

        .section-step.locked .section-step-indicator {
            opacity: 0.5;
        }

        .section-step-label {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 6px;
            text-align: center;
            max-width: 60px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .section-step.current .section-step-label {
            color: var(--primary);
            font-weight: 600;
        }

        /* Section Content Area */
        .section-content-area {
            min-height: 400px;
        }

        /* Exercise Container */
        .exercise-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin: 24px 0;
            overflow: hidden;
        }

        .exercise-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
        }

        .exercise-header h3 {
            margin: 0 0 8px 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exercise-header p {
            margin: 0;
            font-size: 0.95em;
            opacity: 0.9;
        }

        .exercise-body {
            padding: 24px;
        }

        .exercise-footer {
            padding: 16px 24px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-skip-link {
            color: #6c757d;
            text-decoration: none;
            font-size: 0.9em;
        }

        .exercise-skip-link:hover {
            text-decoration: underline;
        }

        /* Sociology Link Box */
        .sociology-link-box {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-left: 4px solid #805ad5;
            border-radius: 0 12px 12px 0;
            padding: 16px 20px;
            margin-top: 20px;
        }

        .sociology-link-box h4 {
            color: #553c9a;
            margin: 0 0 8px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sociology-link-box p {
            color: #6b46c1;
            margin: 0;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .sociology-link-box cite {
            display: block;
            margin-top: 8px;
            font-size: 0.85em;
            color: #805ad5;
            font-style: normal;
        }

        /* ========== RANKING EXERCISE ========== */
        .ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ranking-item {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
        }

        .ranking-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.15);
        }

        .ranking-item.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            cursor: grabbing;
            transform: scale(1.02);
        }

        .ranking-item.drag-over {
            border-color: var(--primary);
            border-style: dashed;
        }

        .ranking-handle {
            color: #adb5bd;
            font-size: 1.2em;
            cursor: grab;
        }

        .ranking-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95em;
            flex-shrink: 0;
        }

        .ranking-content {
            flex: 1;
        }

        .ranking-content h4 {
            margin: 0 0 4px 0;
            color: var(--navy);
            font-size: 1em;
        }

        .ranking-content p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
        }

        .ranking-move-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ranking-move-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .ranking-move-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Touch-friendly ranking for mobile */
        @media (max-width: 768px) {
            .ranking-item {
                padding: 14px 16px;
            }

            .ranking-move-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8em;
            }
        }

        /* ========== CALCULATOR EXERCISE ========== */
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .calculator-input-group {
            display: flex;
            flex-direction: column;
        }

        .calculator-input-group label {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .calculator-input-wrapper {
            position: relative;
        }

        .calculator-input-wrapper.currency::before {
            content: '$';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-weight: 500;
        }

        .calculator-input-wrapper.currency input {
            padding-left: 28px;
        }

        .calculator-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        .calculator-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .calculator-select {
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 12px center;
            padding-right: 36px;
            cursor: pointer;
        }

        .calculator-output-desc {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }

        .calculator-outputs {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 24px;
        }

        .calculator-outputs h4 {
            margin: 0 0 16px 0;
            color: var(--navy);
            font-size: 1.1em;
        }

        .calculator-output-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .calculator-output-item:last-child {
            border-bottom: none;
        }

        .calculator-output-item.highlight {
            background: rgba(155, 89, 182, 0.1);
            margin: 0 -16px;
            padding: 12px 16px;
            border-radius: 8px;
            border-bottom: none;
        }

        .calculator-output-label {
            color: var(--text-dark);
            font-size: 0.95em;
        }

        .calculator-output-value {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--navy);
        }

        .calculator-interpretation {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .calculator-interpretation.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .calculator-interpretation.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .calculator-interpretation.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        /* ========== QUIZ EXERCISE ========== */
        .quiz-question {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e1e8ed;
        }

        .quiz-question:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .quiz-question-text {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            display: flex;
            align-items: flex-start;
            padding: 14px 16px;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            border-color: var(--primary);
            background: #f8f4ff;
        }

        .quiz-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8f4ff 0%, #fff 100%);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: #d4edda;
        }

        .quiz-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .quiz-option input {
            margin-right: 12px;
            margin-top: 2px;
            width: 18px;
            height: 18px;
        }

        .quiz-option-text {
            flex: 1;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .quiz-explanation {
            margin-top: 16px;
            padding: 16px;
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 0 8px 8px 0;
            display: none;
        }

        .quiz-explanation.visible {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .quiz-explanation h5 {
            margin: 0 0 8px 0;
            color: #1565c0;
            font-size: 0.95em;
        }

        .quiz-explanation p {
            margin: 0;
            color: #0c5460;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .quiz-explanation cite {
            display: block;
            margin-top: 8px;
            font-size: 0.85em;
            color: #1976d2;
            font-style: italic;
        }

        .quiz-result {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 24px;
        }

        .quiz-result.passed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid var(--success);
        }

        .quiz-result.failed {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #dc3545;
        }

        .quiz-result h4 {
            margin: 0 0 8px 0;
            font-size: 1.2em;
        }

        .quiz-result p {
            margin: 0;
            font-size: 0.95em;
        }

        /* ========== REFLECTION EXERCISE ========== */
        .reflection-textarea {
            width: 100%;
            min-height: 180px;
            padding: 16px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .reflection-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .reflection-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 0.85em;
            color: #6c757d;
        }

        .reflection-char-count {
            transition: color 0.2s ease;
        }

        .reflection-char-count.warning {
            color: #ffc107;
        }

        .reflection-char-count.error {
            color: #dc3545;
        }

        .reflection-char-count.success {
            color: var(--success);
        }

        .reflection-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .reflection-tag {
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #495057;
        }

        /* ========== MAPPING EXERCISE ========== */
        .mapping-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
            min-height: 400px;
        }

        @media (max-width: 768px) {
            .mapping-container {
                grid-template-columns: 1fr;
            }
        }

        .mapping-sidebar {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e8eaed;
        }

        .mapping-sidebar > h4 {
            margin: 0 0 12px 0;
            color: #202124;
            font-size: 0.9em;
            font-weight: 600;
        }

        .mapping-node-types {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .mapping-node-type {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #fafafa;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .mapping-node-type:hover {
            background: #f1f3f4;
            border-color: #dadce0;
        }

        .mapping-node-type.selected {
            background: #e8f0fe;
            border-color: #1a73e8;
        }

        .mapping-node-icon {
            font-size: 1.1em;
        }

        .mapping-node-label {
            font-size: 0.85em;
            color: #202124;
        }

        .mapping-canvas-area {
            background: #fafbfc;
            border: 1px solid #dadce0;
            border-radius: 12px;
            position: relative;
            min-height: 350px;
            overflow: hidden;
        }

        .mapping-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .mapping-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            transition: box-shadow 0.2s ease;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mapping-node:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .mapping-node.selected {
            box-shadow: 0 0 0 4px rgba(155, 89, 182, 0.4);
        }

        .mapping-node-emoji {
            font-size: 1.5em;
        }

        .mapping-node-name {
            font-size: 0.7em;
            color: white;
            text-align: center;
            margin-top: 4px;
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .mapping-connection {
            stroke-linecap: round;
            transition: stroke-width 0.2s ease;
        }

        .mapping-connection:hover {
            stroke-width: 5;
        }

        .mapping-metrics {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e8eaed;
        }

        .mapping-metrics h4 {
            margin: 0 0 8px 0;
            font-size: 0.8em;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .mapping-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .mapping-metric-label {
            font-size: 0.8em;
            color: #5f6368;
        }

        .mapping-metric-value {
            font-weight: 600;
            color: #202124;
            font-size: 0.9em;
        }

        .mapping-instructions {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.85em;
            color: #0c5460;
        }

        /* Mode selector for Add/Connect/Delete */
        .mapping-mode-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            padding: 8px;
            background: #f1f3f4;
            border-radius: 10px;
        }

        .mapping-mode-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: #5f6368;
        }

        .mapping-mode-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .mapping-mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
        }

        .mapping-mode-btn[data-mode="delete"].active {
            color: #dc3545;
        }

        /* Status message area */
        .mapping-status {
            padding: 10px 14px;
            margin-bottom: 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 500;
            text-align: center;
            line-height: 1.4;
        }

        .mapping-status.add-mode {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .mapping-status.connect-mode {
            background: #e3f2fd;
            color: #1565c0;
        }

        .mapping-status.delete-mode {
            background: #ffebee;
            color: #c62828;
        }

        /* Connection type selector panel */
        .mapping-panel {
            margin-bottom: 12px;
            padding: 14px;
            background: #fff;
            border: 1px solid #e8eaed;
            border-radius: 8px;
        }

        .mapping-panel h4 {
            margin: 0 0 12px 0;
            font-size: 0.85em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .mapping-connection-types {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .mapping-connection-type {
            padding: 6px 12px;
            border: 1px solid #dadce0;
            border-radius: 16px;
            background: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mapping-connection-type:hover {
            background: #f8f9fa;
            border-color: #bdc1c6;
        }

        .mapping-connection-type.selected {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .mapping-connection-type .conn-line {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        /* Hint text */
        .mapping-hint {
            font-size: 0.75em;
            color: #5f6368;
            margin-top: 10px;
            line-height: 1.4;
        }

        /* Node delete mode styling */
        .mapping-node.deletable {
            cursor: pointer;
        }

        .mapping-node.deletable:hover {
            filter: brightness(0.9);
        }

        .mapping-node .delete-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .mapping-node .delete-badge:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* Connection delete mode */
        .mapping-connection-group.deletable {
            cursor: pointer;
        }

        .mapping-connection-group.deletable line {
            stroke-width: 6;
        }

        .mapping-connection-group.deletable:hover line {
            stroke: #dc3545 !important;
            stroke-width: 8;
        }

        .mapping-connection-hit-area {
            stroke: transparent;
            stroke-width: 20;
            cursor: pointer;
            fill: none;
        }

        /* ========== SCENARIO EXERCISE ========== */
        .scenario-setup {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-left: 4px solid #ffc107;
            border-radius: 0 12px 12px 0;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .scenario-setup h4 {
            margin: 0 0 12px 0;
            color: #856404;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scenario-setup p {
            margin: 0;
            color: #664d03;
            line-height: 1.6;
        }

        .scenario-branches {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .scenario-branch {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .scenario-branch:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(155, 89, 182, 0.15);
        }

        .scenario-branch.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8f4ff 0%, #fff 100%);
            box-shadow: 0 4px 16px rgba(155, 89, 182, 0.2);
        }

        .scenario-branch.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .scenario-branch h4 {
            margin: 0 0 8px 0;
            color: var(--navy);
            font-size: 1.05em;
        }

        .scenario-branch p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .scenario-outcome {
            display: none;
            margin-top: 24px;
            padding: 24px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            animation: slideIn 0.4s ease-out;
        }

        .scenario-outcome.visible {
            display: block;
        }

        .scenario-outcome h4 {
            margin: 0 0 12px 0;
            color: var(--navy);
            font-size: 1.1em;
        }

        .scenario-outcome p {
            margin: 0 0 16px 0;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .scenario-consequence {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            margin-top: 12px;
        }

        .scenario-consequence.positive {
            border-left: 4px solid var(--success);
        }

        .scenario-consequence.negative {
            border-left: 4px solid #dc3545;
        }

        .scenario-consequence.neutral {
            border-left: 4px solid #6c757d;
        }

        /* Navigation Buttons */
        .section-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 24px;
            margin-top: 24px;
            border-top: 1px solid #e1e8ed;
        }

        .section-nav-left,
        .section-nav-right {
            display: flex;
            gap: 12px;
        }

        /* Skip Warning Modal */
        .skip-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .skip-warning-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .skip-warning-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            text-align: center;
        }

        .skip-warning-content h3 {
            margin: 0 0 16px 0;
            color: var(--navy);
        }

        .skip-warning-content p {
            margin: 0 0 24px 0;
            color: #6c757d;
            line-height: 1.5;
        }

        .skip-warning-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Exercise Type Icons */
        .exercise-type-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .exercise-type-icon.ranking { background: #e3f2fd; }
        .exercise-type-icon.calculator { background: #e8f5e9; }
        .exercise-type-icon.quiz { background: #fff3e0; }
        .exercise-type-icon.reflection { background: #fce4ec; }
        .exercise-type-icon.mapping { background: #e1f5fe; }
        .exercise-type-icon.scenario { background: #f3e5f5; }

        /* Accessibility: Focus visible */
        .exercise-container :focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }

        /* ========== MOBILE RESPONSIVENESS ========== */
        @media (max-width: 768px) {
            /* Section progress bar - horizontal scroll on mobile */
            .section-progress-container {
                overflow-x: auto;
                padding: 12px 10px;
                -webkit-overflow-scrolling: touch;
            }

            .section-progress-bar {
                min-width: 600px;
                padding: 0 10px;
            }

            .section-step-indicator {
                width: 28px;
                height: 28px;
                font-size: 0.7em;
            }

            .section-step-label {
                font-size: 0.6em;
                max-width: 50px;
            }

            /* Exercise containers */
            .exercise-container {
                margin: 16px 0;
                border-radius: 8px;
            }

            .exercise-header {
                padding: 16px;
            }

            .exercise-header h3 {
                font-size: 1.1em;
            }

            .exercise-body {
                padding: 16px;
            }

            /* Scenario branches - stack vertically */
            .scenario-branches {
                flex-direction: column;
            }

            .scenario-branch {
                min-width: unset;
                width: 100%;
            }

            /* Mapping exercise - smaller canvas */
            .mapping-container {
                flex-direction: column;
            }

            .mapping-sidebar {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid #e1e8ed;
                padding-bottom: 16px;
            }

            .mapping-canvas-area {
                height: 300px;
            }

            .mapping-node-types {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .mapping-node-type {
                flex: 1 1 45%;
                padding: 8px;
            }

            /* Mode selector - stack on mobile */
            .mapping-mode-selector {
                flex-direction: column;
                gap: 6px;
            }

            .mapping-mode-btn {
                padding: 12px;
            }

            /* Connection types - smaller on mobile */
            .mapping-connection-types {
                gap: 6px;
            }

            .mapping-connection-type {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .mapping-connection-type .conn-line {
                width: 18px;
            }

            /* Quiz options - full width */
            .quiz-option {
                padding: 12px;
            }

            /* Section navigation */
            .section-nav {
                flex-direction: column;
                gap: 12px;
            }

            .section-nav-left,
            .section-nav-right {
                width: 100%;
            }

            .section-nav button {
                width: 100%;
            }

            /* Reflection textarea */
            .reflection-textarea {
                min-height: 150px;
            }
        }

        @media (max-width: 480px) {
            .section-step-label {
                display: none;
            }

            .section-step-indicator {
                width: 32px;
                height: 32px;
            }

            .exercise-type-icon {
                display: none;
            }

            .mapping-canvas-area {
                height: 250px;
            }

            .mapping-node {
                width: 60px;
                height: 60px;
            }

            .mapping-node-name {
                font-size: 0.65em;
            }

            /* Mode buttons smaller text */
            .mapping-mode-btn {
                font-size: 0.8em;
                padding: 10px;
            }

            /* Hide connection line preview on very small screens */
            .mapping-connection-type .conn-line {
                display: none;
            }

            .mapping-status {
                font-size: 0.85em;
                padding: 10px 12px;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .ranking-item,
            .scenario-branch,
            .quiz-option,
            .section-step {
                transition: none;
            }

            .scenario-outcome,
            .quiz-explanation {
                animation: none;
            }
        }

        /* Print styles for exercises */
        @media print {
            .exercise-container {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #333;
            }

            .exercise-header {
                background: #f0f0f0 !important;
                color: #333 !important;
            }

            .mapping-canvas-area {
                min-height: 200px;
            }

            .scenario-branches {
                grid-template-columns: 1fr 1fr;
            }

            .section-nav,
            .skip-warning-modal {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PRINT-ONLY HEADER -->
        <div class="print-header">
            <h1>Life Planning Challenge - Game Report</h1>
            <p><strong>SOC-213: Sociology of the Family</strong></p>
            <p>Student Name: ________________________________</p>
            <p>Export Date: <span id="print-date"></span></p>
            <p>Modules Completed: <span id="print-modules-completed"></span>/8</p>
        </div>

        <div class="header">
            <h1>ðŸŽ® Life Planning Challenge</h1>
            <p>An Interactive Family Sociology Simulation</p>
        </div>

        <!-- JOURNEY PROGRESS VISUALIZATION -->
        <div class="journey-progress" id="journey-progress-main" style="margin: 20px 0;">
            <div class="journey-path">
                <div class="journey-node current">1<span class="journey-node-label">Origins</span></div>
                <div class="journey-node locked">2<span class="journey-node-label">Career</span></div>
                <div class="journey-node locked">3<span class="journey-node-label">Relate</span></div>
                <div class="journey-node locked">4<span class="journey-node-label">Partner</span></div>
                <div class="journey-node locked">5<span class="journey-node-label">Union</span></div>
                <div class="journey-node locked">6<span class="journey-node-label">Family</span></div>
                <div class="journey-node locked">7<span class="journey-node-label">Crisis</span></div>
                <div class="journey-node locked">8<span class="journey-node-label">Reflect</span></div>
            </div>
        </div>

        <!-- WELCOME SECTION -->
        <div id="welcome" class="content game-section active">
            <div class="welcome-section">
                <h2>Welcome to the Life Planning Challenge!</h2>
                <p>
                    This interactive simulation is part of your SOC-213 (Sociology of the Family) course.
                    Over the next 8 modules, you'll make sequential life decisions about education, career,
                    relationships, family formation, and financesâ€”and experience how choices in one domain
                    cascade through all others.
                </p>
                <p>
                    <strong>This isn't a test.</strong> There are no "right" or "wrong" decisions. The goal is to
                    demonstrate how family is an interconnected system shaped by structural forces, not just personal choices.
                </p>
            </div>

            <div class="info-box">
                <h3>ðŸŽ¯ Learning Goals</h3>
                <ul>
                    <li>Experience how family decisions are interconnected systems</li>
                    <li>Understand how structural forces (economics, gender, education) constrain choices</li>
                    <li>Recognize life course perspective: early decisions affect later options</li>
                    <li>Build empathy for diverse family forms and experiences</li>
                    <li>Develop systems thinking about family sociology</li>
                </ul>
            </div>

            <div class="info-box">
                <h3>ðŸ’¾ Saving Your Progress</h3>
                <p>
                    Your game progress saves automatically to your browser. You can:
                </p>
                <ul>
                    <li><strong>Play across multiple sessions:</strong> Close and return anytime</li>
                    <li><strong>Export your data:</strong> Download a summary at any time (required for Canvas assignments!)</li>
                    <li><strong>Replay modules:</strong> Try different paths to see different outcomes</li>
                </ul>
                <p style="margin-top: 10px; color: var(--secondary); font-weight: 600;">
                    âš ï¸ Important: Always export your game summary before submitting Canvas assignments!
                </p>
            </div>

            <!-- SAVE SLOTS -->
            <div class="save-slots-container">
                <div class="save-slots-header">
                    <h3>ðŸ“ Your Save Slots</h3>
                    <span style="font-size: 0.9em; color: #666;">Save different journeys or replay with new choices</span>
                </div>
                <div class="save-slots-grid" id="save-slots-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="info-box">
                <h3>ðŸ“‹ How It Works</h3>
                <ul>
                    <li><strong>8 Modules:</strong> Each corresponds to a course module</li>
                    <li><strong>15-25 minutes per module:</strong> Take your time with decisions</li>
                    <li><strong>Consequences cascade:</strong> Early choices affect later options</li>
                    <li><strong>Export after each module:</strong> You'll upload summaries to Canvas for reflection assignments</li>
                </ul>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-primary" onclick="startGame()">Begin Module 1: Character Creation â†’</button>
            </div>
        </div>

        <!-- MODULE SELECTION HUB -->
        <div id="moduleHub" class="content game-section">
            <h2 style="color: var(--navy); margin-bottom: 25px;">Module Hub</h2>

            <div class="progress-bar">
                <div class="progress-fill" id="overallProgress" style="width: 0%;"></div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
                <p style="margin: 0; color: var(--text-dark);">
                    Progress: <strong id="progressText">0/8 modules completed</strong>
                </p>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span id="lastSavedTime" style="font-size: 0.85em; color: #7f8c8d;"></span>
                    <button id="whatIfToggle" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9em;" onclick="toggleWhatIfMode()">
                        ðŸ”® What If Mode
                    </button>
                    <a href="#" onclick="resetGame(); return false;" style="font-size: 0.85em; color: #95a5a6; text-decoration: none;" title="Reset game and start over">ðŸ”„ Reset</a>
                </div>
            </div>

            <div class="module-grid" id="moduleGrid">
                <!-- Modules will be populated by JavaScript -->
            </div>

            <div class="export-section">
                <h3 style="color: var(--navy); margin-bottom: 15px;">ðŸ“¥ Export Your Game Data</h3>
                <p style="color: var(--text-dark); margin-bottom: 15px;">
                    Download a complete summary of all your decisions and outcomes. You'll need this for Canvas assignments.
                </p>

                <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 15px; font-weight: bold; border-left: 5px solid #ffc107;">
                    âš ï¸ <strong>EXPORT AFTER EVERY MODULE!</strong><br>
                    <span style="font-weight: normal;">Your game data is ONLY saved in YOUR browser. You MUST export after completing each module to submit with Canvas assignments!</span>
                </div>

                <div class="alert alert-info" style="margin-bottom: 15px;">
                    <strong>Why export matters:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>âœ… <strong>Required for Canvas</strong> - Each module assignment needs your exported data</li>
                        <li>âœ… <strong>Backup your work</strong> - Browser data can be lost if you clear cookies/cache</li>
                        <li>âœ… <strong>Replay protection</strong> - Export BEFORE replaying modules to save original choices</li>
                    </ul>
                </div>

                <div class="alert alert-info" style="margin-bottom: 15px;">
                    <strong>Export methods:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li><strong>Print to PDF</strong> - Most reliable method. Works on all devices.</li>
                        <li><strong>Export as Text</strong> - Download a text file you can upload to Canvas.</li>
                        <li><strong>Export as JSON</strong> - Technical format for advanced users.</li>
                    </ul>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-print" onclick="printToPDF()">ðŸ–¨ï¸ Print to PDF (Recommended)</button>
                    <button class="btn btn-success" onclick="exportData('text')">ðŸ“„ Export as Text</button>
                    <button class="btn btn-success" onclick="exportData('json')">ðŸ’¾ Export as JSON</button>
                </div>
            </div>

            <div class="export-section" style="margin-top: 30px; border-top: 2px solid #e1e8ed; padding-top: 30px;">
                <h3 style="color: var(--navy); margin-bottom: 15px;">ðŸ” Replay Modules</h3>
                <p style="color: var(--text-dark); margin-bottom: 15px;">
                    Want to try different choices? You can click any completed module to replay it.
                </p>
                <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 15px;">
                    <strong>âš ï¸ IMPORTANT:</strong> Replaying a module will <strong>OVERWRITE</strong> your previous answers!<br><br>
                    <strong>Before replaying:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>âœ… Export your current data to save your original choices</li>
                        <li>âœ… Make sure you've already submitted that module's Canvas assignment</li>
                        <li>âœ… Remember: New choices will replace old ones in your saved game</li>
                    </ul>
                </div>
            </div>

            <div class="export-section" style="margin-top: 30px; border-top: 2px solid #e1e8ed; padding-top: 30px;">
                <h3 style="color: var(--navy); margin-bottom: 15px;">ðŸ”„ Start Over</h3>
                <p style="color: var(--text-dark); margin-bottom: 15px;">
                    Want to explore different life paths? Reset the game to start fresh with new decisions.
                </p>
                <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 15px;">
                    <strong>âš ï¸ WARNING:</strong> This will permanently delete your current progress and all saved decisions. Make sure you've exported your data first if you need it for assignments!
                </div>
                <button class="btn btn-secondary" onclick="resetGame()" style="background: var(--secondary); border-color: var(--secondary);">ðŸ—‘ï¸ Reset Game & Start Over</button>
            </div>
        </div>

        <!-- MODULE 1: CHARACTER CREATION -->
        <div id="module1" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module1-section-progress" class="section-progress-container"></div>

            <!-- Dynamic Section Content (rendered by ModuleSectionController) -->
            <div id="module1-section-content" class="section-content-area"></div>

            <!-- EXISTING CHARACTER CREATION CONTENT -->
            <div id="module1-decisions-container">
                <h2 style="color: var(--navy); margin-bottom: 20px;">Module 1: Family Origins & Starting Point</h2>

                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapter 1 (What IS Family?)
                </div>

            <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                <strong>ðŸŽ¯ Decision-Making Framework</strong><br>
                Sociology teaches us that <span class="glossary-term" data-term="kinship">kinship<span class="glossary-tooltip"><strong>Kinship</strong><br>The social relationships and obligations among people considered related, whether by blood (consanguineal), marriage (affinal), or choice.<br><em>Hammond Ch. 1</em></span></span> and family structures shape our opportunities and constraints. Your character's family background will affect their resources, networks, and assumptions about "normal" family life. <strong>There are no "right" answers</strong>â€”all family forms have strengths and challenges.
            </div>

            <p style="margin-bottom: 25px; color: var(--text-dark);">
                This game adapts to YOUR life stage. Your age and current circumstances will shape which decisions you make throughout the simulation, making this experience relevant to where YOU are in your life journey.
            </p>

            <div class="question-group">
                <label><strong>STARTING POINT:</strong> What is your current life stage?</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    This is a <strong>life course perspective</strong> game. Your age and life stage determine which decisions you'll face. Select the stage that best matches where you are NOW (or where you'd like to simulate from). This creates a personalized experience that reflects the sociology of YOUR life trajectory.
                </p>
                <div class="options">
                    <label class="option-label">
                        <input type="radio" name="q0_lifestage" value="traditional" checked>
                        <span><strong>Traditional-Age Student (Ages 18-24):</strong> You're just starting your adult journey. You're making foundational decisions about education, career pathways, and early relationships. Your focus is launching into independence, exploring identity, and building your future. <em>Life Course Stage: Emerging Adulthood / Transition to Independence</em></span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q0_lifestage" value="returning">
                        <span><strong>Returning Adult Student (Ages 25-35):</strong> You're balancing existing commitments while pursuing education or career change. You may have a partner, children, or established career. Your decisions involve managing multiple roles and responsibilities simultaneously. <em>Life Course Stage: Established Adulthood / Role Juggling</em></span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q0_lifestage" value="midcareer">
                        <span><strong>Mid-Career Adult (Ages 36-50):</strong> You're in the thick of work-family demands. You likely have teenage or young adult children, aging parents, and career responsibilities. Your decisions involve navigating the "sandwich generation" pressures and balancing competing caregiving demands. <em>Life Course Stage: Peak Demands / Sandwich Generation</em></span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q0_lifestage" value="laterlife">
                        <span><strong>Later-Life Student (Ages 50+):</strong> You're approaching or in late career, possibly with adult children and grandchildren. Your decisions involve transitions, legacy, and managing relationships across multiple adult generations. You may be navigating retirement, health changes, or life reinvention. <em>Life Course Stage: Late Adulthood / Generativity</em></span>
                    </label>
                </div>
            </div>

            <div class="question-group" id="ageSpecificIntro">
                <!-- This will be dynamically populated based on life stage selection -->
            </div>

            <div class="question-group">
                <label><strong>YOUR CURRENT AGE:</strong> How old are you right now?</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    This helps us personalize the reflection questions to your actual life trajectory. We'll ask you to envision your family life 10-15 years from your current age.
                </p>
                <input type="number" id="currentAge" min="18" max="99" placeholder="Enter your age (e.g., 43)" style="width: 200px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>

            <div class="question-group" id="q1-group">
                <label><strong>DECISION 1:</strong> What family structure did you grow up in?</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    Family structure affects economic resources, social capital, and caregiving models. Click a card to select.
                </p>
                <div class="choice-cards-container">
                    <label class="choice-card" data-value="nuclear_traditional">
                        <input type="radio" name="q1" value="nuclear_traditional" style="display:none;">
                        <div class="choice-icon">ðŸ </div>
                        <div class="choice-label">Nuclear Family</div>
                        <div class="choice-brief">Two parents + children</div>
                    </label>
                    <label class="choice-card" data-value="extended_multigenerational">
                        <input type="radio" name="q1" value="extended_multigenerational" style="display:none;">
                        <div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                        <div class="choice-label">Extended Family</div>
                        <div class="choice-brief">Multigenerational household</div>
                    </label>
                    <label class="choice-card" data-value="single_parent">
                        <input type="radio" name="q1" value="single_parent" style="display:none;">
                        <div class="choice-icon">ðŸ‘¤</div>
                        <div class="choice-label">Single-Parent</div>
                        <div class="choice-brief">One parent managing all</div>
                    </label>
                    <label class="choice-card" data-value="chosen_family">
                        <input type="radio" name="q1" value="chosen_family" style="display:none;">
                        <div class="choice-icon">ðŸ¤</div>
                        <div class="choice-label">Chosen Family</div>
                        <div class="choice-brief">Non-biological support network</div>
                    </label>
                </div>
                <div class="consequence-panel" id="q1-consequence"></div>
            </div>

            <div class="question-group" id="q2-group">
                <label><strong>DECISION 2:</strong> What value will guide your major life decisions?</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    Socialization taught you what matters most. This value shapes all future decisions.
                </p>
                <div class="choice-cards-container">
                    <label class="choice-card" data-value="economic_security">
                        <input type="radio" name="q2" value="economic_security" style="display:none;">
                        <div class="choice-icon">ðŸ’°</div>
                        <div class="choice-label">Economic Security</div>
                        <div class="choice-brief">Financial stability first</div>
                    </label>
                    <label class="choice-card" data-value="relationships">
                        <input type="radio" name="q2" value="relationships" style="display:none;">
                        <div class="choice-icon">â¤ï¸</div>
                        <div class="choice-label">Relationships First</div>
                        <div class="choice-brief">Connection over career</div>
                    </label>
                    <label class="choice-card" data-value="achievement">
                        <input type="radio" name="q2" value="achievement" style="display:none;">
                        <div class="choice-icon">ðŸ†</div>
                        <div class="choice-label">Personal Achievement</div>
                        <div class="choice-brief">Growth and advancement</div>
                    </label>
                    <label class="choice-card" data-value="social_justice">
                        <input type="radio" name="q2" value="social_justice" style="display:none;">
                        <div class="choice-icon">âš–ï¸</div>
                        <div class="choice-label">Social Justice</div>
                        <div class="choice-brief">Meaningful impact work</div>
                    </label>
                </div>
                <div class="consequence-panel" id="q2-consequence"></div>
            </div>

            <div class="question-group">
                <label><strong>REFLECTION:</strong> What's your vision of family at age <span id="reflectionAge">35</span>?</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    Describe what "family" might look like for your character at age <span id="reflectionAge2">35</span>. This is aspirationalâ€”future modules will show how structures and circumstances shape whether this vision is possible.
                </p>
                <textarea id="idealLife" placeholder="Write 2-3 sentences describing your character's imagined family life at age 35. Consider: Who is in your family? What does daily life look like? What matters most to you?" style="min-height: 100px; width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1em;"></textarea>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule1()">Begin My Life Journey â†’</button>
            </div>
            </div> <!-- End module1-decisions-container -->
        </div>

        <!-- MODULE 2: EDUCATION & CAREER (ENHANCED WITH SECTION SYSTEM) -->
        <div id="module2" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module2-section-progress" class="section-progress-container"></div>

            <!-- Advantage Display -->
            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <div id="advantage-m2" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content (rendered by ModuleSectionController) -->
            <div id="module2-section-content" class="section-content-area"></div>

            <!-- Previous Module Summary (populated dynamically) -->
            <div id="module2-intro-summary"></div>

            <!-- EXISTING DECISION CONTENT (shown during DECISION_1 and DECISION_2 sections) -->
            <div id="module2-decisions-container">
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapter 4 (Gender, Socialization & Life Course)
                </div>

                <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                    <strong>ðŸŽ¯ Life Course Perspective in Action</strong><br>
                    Hammond Ch. 4 explains how <strong>timing matters</strong>. The SAME decision (career change, education) has different meanings and consequences depending on your life stage. This module adapts to show how education/career decisions intersect with your current responsibilities and constraints.
                </div>

            <!-- BRANCH 1: TRADITIONAL AGE (18-24) -->
            <div id="module2_traditional" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">22</span> years old.</strong> You're making foundational decisions that will create <span class="glossary-term">path dependency<span class="glossary-tooltip"><strong>Path Dependency</strong><br>How early decisions constrain later optionsâ€”once on a path, it's harder to switch tracks.<br><em>Hammond Ch. 4</em></span></span> for the next decade. Your education and career choices will determine income, debt, work-life flexibility, and when you can afford to form a family.
                </p>

                <div class="question-group" id="q5_traditional-group">
                    <label><strong>DECISION 3:</strong> Education Path - What level of education will you pursue?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Education creates <span class="glossary-term">cumulative advantage/disadvantage<span class="glossary-tooltip"><strong>Cumulative Advantage/Disadvantage</strong><br>How advantages compound over timeâ€”the rich get richer structurally.<br><em>Hammond Ch. 4</em></span></span>. More education = higher lifetime earnings, but also debt and delayed family formation.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="bachelor">
                            <input type="radio" name="q5_traditional" value="bachelor" style="display:none;">
                            <div class="choice-icon">ðŸŽ“</div>
                            <div class="choice-label">Bachelor's Degree</div>
                            <div class="choice-brief">4 years, $30K debt, $50-60K salary</div>
                        </label>
                        <label class="choice-card" data-value="associate">
                            <input type="radio" name="q5_traditional" value="associate" style="display:none;">
                            <div class="choice-icon">ðŸ“‹</div>
                            <div class="choice-label">Associate Degree</div>
                            <div class="choice-brief">2 years, $12K debt, $40-45K salary</div>
                        </label>
                        <label class="choice-card" data-value="trade">
                            <input type="radio" name="q5_traditional" value="trade" style="display:none;">
                            <div class="choice-icon">ðŸ”§</div>
                            <div class="choice-label">Trade Certification</div>
                            <div class="choice-brief">1 year, $5K cost, $35-50K salary</div>
                        </label>
                        <label class="choice-card" data-value="workforce">
                            <input type="radio" name="q5_traditional" value="workforce" style="display:none;">
                            <div class="choice-icon">ðŸ’¼</div>
                            <div class="choice-label">Enter Workforce Now</div>
                            <div class="choice-brief">No debt, $28-32K salary</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q5_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q6_traditional-group">
                    <label><strong>DECISION 4:</strong> Career Field - What work calls to you?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        <span class="glossary-term">Gender socialization<span class="glossary-tooltip"><strong>Gender Socialization</strong><br>Learning cultural norms for "appropriate" gender behavior.<br><em>Hammond Ch. 4</em></span></span> makes some fields feel "natural." This affects pay, respect, work-family balance.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="healthcare">
                            <input type="radio" name="q6_traditional" value="healthcare" style="display:none;">
                            <div class="choice-icon">ðŸ¥</div>
                            <div class="choice-label">Healthcare</div>
                            <div class="choice-brief">Nursing/Med Tech, $45-60K</div>
                        </label>
                        <label class="choice-card" data-value="education">
                            <input type="radio" name="q6_traditional" value="education" style="display:none;">
                            <div class="choice-icon">ðŸ“š</div>
                            <div class="choice-label">Education</div>
                            <div class="choice-brief">Teaching, $40-48K</div>
                        </label>
                        <label class="choice-card" data-value="trades">
                            <input type="radio" name="q6_traditional" value="trades" style="display:none;">
                            <div class="choice-icon">ðŸ”¨</div>
                            <div class="choice-label">Skilled Trades</div>
                            <div class="choice-brief">Construction/Electric, $42-55K</div>
                        </label>
                        <label class="choice-card" data-value="tech">
                            <input type="radio" name="q6_traditional" value="tech" style="display:none;">
                            <div class="choice-icon">ðŸ’»</div>
                            <div class="choice-label">Business/Technology</div>
                            <div class="choice-brief">IT/Software, $50-70K</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q6_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING ADULT (25-35) -->
            <div id="module2_returning" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">30</span> years old.</strong> You have work experience, possibly a partner and/or children. You're considering career change while managing existing commitments. This is <span class="glossary-term">role strain<span class="glossary-tooltip"><strong>Role Strain</strong><br>Tension from competing demands of multiple roles (worker, partner, parent, student).<br><em>Hammond Ch. 4</em></span></span>â€”balancing multiple roles simultaneously.
                </p>

                <div class="question-group" id="q5_returning-group">
                    <label><strong>DECISION 3:</strong> Career/Education Path - What change will you pursue?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Timing affects opportunity costs. Pursuing education at 30 means sacrificing current income, piling debt, and managing family care. But staying put may mean unfulfillment.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="fulltime_school">
                            <input type="radio" name="q5_returning" value="fulltime_school" style="display:none;">
                            <div class="choice-icon">ðŸŽ“</div>
                            <div class="choice-label">Full-Time School</div>
                            <div class="choice-brief">Quit job, 2-4 years, $20-40K debt</div>
                        </label>
                        <label class="choice-card" data-value="parttime_school">
                            <input type="radio" name="q5_returning" value="parttime_school" style="display:none;">
                            <div class="choice-icon">ðŸ“–</div>
                            <div class="choice-label">Part-Time School</div>
                            <div class="choice-brief">Keep job, 3-5 years, $15-25K debt</div>
                        </label>
                        <label class="choice-card" data-value="certification">
                            <input type="radio" name="q5_returning" value="certification" style="display:none;">
                            <div class="choice-icon">ðŸ“œ</div>
                            <div class="choice-label">Professional Certification</div>
                            <div class="choice-brief">6-12 months, $5-10K</div>
                        </label>
                        <label class="choice-card" data-value="stay_advance">
                            <input type="radio" name="q5_returning" value="stay_advance" style="display:none;">
                            <div class="choice-icon">ðŸ“ˆ</div>
                            <div class="choice-label">Stay & Advance</div>
                            <div class="choice-brief">No school, pursue promotions</div>
                        </label>
                        <label class="choice-card" data-value="lateral_pivot">
                            <input type="radio" name="q5_returning" value="lateral_pivot" style="display:none;">
                            <div class="choice-icon">â†”ï¸</div>
                            <div class="choice-label">Lateral Pivot</div>
                            <div class="choice-brief">Switch roles without school</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q5_returning-consequence"></div>
                </div>

                <div class="question-group" id="q6_returning-group">
                    <label><strong>DECISION 4:</strong> Work-Life Considerations - What's your reality?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Career decisions at 30 intersect with family responsibilities. Your commitments shape what's actually possible.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="single_independent">
                            <input type="radio" name="q6_returning" value="single_independent" style="display:none;">
                            <div class="choice-icon">ðŸ¦…</div>
                            <div class="choice-label">Single, No Kids</div>
                            <div class="choice-brief">Maximum flexibility</div>
                        </label>
                        <label class="choice-card" data-value="partnered_nokids">
                            <input type="radio" name="q6_returning" value="partnered_nokids" style="display:none;">
                            <div class="choice-icon">ðŸ‘«</div>
                            <div class="choice-label">Partnered, No Kids</div>
                            <div class="choice-brief">Moderate flexibility</div>
                        </label>
                        <label class="choice-card" data-value="young_kids">
                            <input type="radio" name="q6_returning" value="young_kids" style="display:none;">
                            <div class="choice-icon">ðŸ‘¶</div>
                            <div class="choice-label">Young Children (0-5)</div>
                            <div class="choice-brief">High constraints</div>
                        </label>
                        <label class="choice-card" data-value="school_age_kids">
                            <input type="radio" name="q6_returning" value="school_age_kids" style="display:none;">
                            <div class="choice-icon">ðŸŽ’</div>
                            <div class="choice-label">School-Age Kids (6-12)</div>
                            <div class="choice-brief">Moderate constraints</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q6_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER (36-50) -->
            <div id="module2_midcareer" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">42</span> years old.</strong> You're in peak earning years but also peak demandsâ€”likely have teenagers or young adults, aging parents, established career. This is the <span class="glossary-term">sandwich generation<span class="glossary-tooltip"><strong>Sandwich Generation</strong><br>Adults caring for both children AND aging parents simultaneously.<br><em>Hammond Ch. 4, 7</em></span></span> crunch. Career decisions must navigate multiple generations' needs.
                </p>

                <div class="question-group" id="q5_midcareer-group">
                    <label><strong>DECISION 3:</strong> Career Direction - Where are you headed?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">42</span>, career changes are risky but burnout is real. Your choice affects family income, caregiving capacity, and legacy.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="continue_current">
                            <input type="radio" name="q5_midcareer" value="continue_current" style="display:none;">
                            <div class="choice-icon">âž¡ï¸</div>
                            <div class="choice-label">Continue Current</div>
                            <div class="choice-brief">Stay the course, max earnings</div>
                        </label>
                        <label class="choice-card" data-value="leadership_advancement">
                            <input type="radio" name="q5_midcareer" value="leadership_advancement" style="display:none;">
                            <div class="choice-icon">ðŸ‘”</div>
                            <div class="choice-label">Pursue Leadership</div>
                            <div class="choice-brief">$10-30K raise, more hours</div>
                        </label>
                        <label class="choice-card" data-value="reduce_caregiving">
                            <input type="radio" name="q5_midcareer" value="reduce_caregiving" style="display:none;">
                            <div class="choice-icon">ðŸ </div>
                            <div class="choice-label">Reduce for Caregiving</div>
                            <div class="choice-brief">$15-30K income cut</div>
                        </label>
                        <label class="choice-card" data-value="start_business">
                            <input type="radio" name="q5_midcareer" value="start_business" style="display:none;">
                            <div class="choice-icon">ðŸš€</div>
                            <div class="choice-label">Start Business</div>
                            <div class="choice-brief">Variable income, high risk</div>
                        </label>
                        <label class="choice-card" data-value="late_pivot">
                            <input type="radio" name="q5_midcareer" value="late_pivot" style="display:none;">
                            <div class="choice-icon">ðŸ”„</div>
                            <div class="choice-label">Industry Pivot</div>
                            <div class="choice-brief">Change fields at 42</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q5_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q6_midcareer-group">
                    <label><strong>DECISION 4:</strong> Caregiving Reality - Who needs you?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">42</span>, you're likely caring for multiple generations. This reality constrains career options.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="teens_home">
                            <input type="radio" name="q6_midcareer" value="teens_home" style="display:none;">
                            <div class="choice-icon">ðŸš—</div>
                            <div class="choice-label">Teenagers at Home</div>
                            <div class="choice-brief">Time-intensive but flexible</div>
                        </label>
                        <label class="choice-card" data-value="young_adults_college">
                            <input type="radio" name="q6_midcareer" value="young_adults_college" style="display:none;">
                            <div class="choice-icon">ðŸŽ“</div>
                            <div class="choice-label">Young Adults/College</div>
                            <div class="choice-brief">Financial support needed</div>
                        </label>
                        <label class="choice-card" data-value="aging_parents">
                            <input type="radio" name="q6_midcareer" value="aging_parents" style="display:none;">
                            <div class="choice-icon">ðŸ‘´</div>
                            <div class="choice-label">Aging Parents Need Care</div>
                            <div class="choice-brief">Time-consuming, emotional</div>
                        </label>
                        <label class="choice-card" data-value="sandwich_both">
                            <input type="radio" name="q6_midcareer" value="sandwich_both" style="display:none;">
                            <div class="choice-icon">ðŸ¥ª</div>
                            <div class="choice-label">Sandwich Generation</div>
                            <div class="choice-brief">Peak demand both directions</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q6_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE (50+) -->
            <div id="module2_laterlife" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">58</span> years old.</strong> You're navigating late-career transitions, possible retirement planning, adult children, maybe grandchildren. Career decisions now involve legacy, health, financial security for old age, and how to spend remaining work years. This is about <span class="glossary-term">generativity<span class="glossary-tooltip"><strong>Generativity</strong><br>Late adulthood focus on passing knowledge, mentoring, legacy work.<br><em>Hammond Ch. 4</em></span></span>â€”what mark you leave.
                </p>

                <div class="question-group" id="q5_laterlife-group">
                    <label><strong>DECISION 3:</strong> Career Transition - What's your path to retirement?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">58</span>, retirement looms. But finances, health, purpose, and Social Security timing affect when and how you leave workforce.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="continue_to_67">
                            <input type="radio" name="q5_laterlife" value="continue_to_67" style="display:none;">
                            <div class="choice-icon">ðŸ“…</div>
                            <div class="choice-label">Work to 67</div>
                            <div class="choice-brief">Max pension, max Social Security</div>
                        </label>
                        <label class="choice-card" data-value="semi_retirement">
                            <input type="radio" name="q5_laterlife" value="semi_retirement" style="display:none;">
                            <div class="choice-icon">â°</div>
                            <div class="choice-label">Semi-Retirement</div>
                            <div class="choice-brief">Part-time, 20-30 hrs/week</div>
                        </label>
                        <label class="choice-card" data-value="career_change_fulfillment">
                            <input type="radio" name="q5_laterlife" value="career_change_fulfillment" style="display:none;">
                            <div class="choice-icon">ðŸ’«</div>
                            <div class="choice-label">Purpose-Driven Change</div>
                            <div class="choice-brief">Nonprofit, teaching, service</div>
                        </label>
                        <label class="choice-card" data-value="retire_now">
                            <input type="radio" name="q5_laterlife" value="retire_now" style="display:none;">
                            <div class="choice-icon">ðŸ–ï¸</div>
                            <div class="choice-label">Retire Now (58)</div>
                            <div class="choice-brief">If financially able</div>
                        </label>
                        <label class="choice-card" data-value="work_past_67">
                            <input type="radio" name="q5_laterlife" value="work_past_67" style="display:none;">
                            <div class="choice-icon">ðŸ’ª</div>
                            <div class="choice-label">Work Past 67</div>
                            <div class="choice-brief">Into 70s, need or want</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q5_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q6_laterlife-group">
                    <label><strong>DECISION 4:</strong> Life Stage Realities - What's your situation?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">58</span>, your family situation affects career flexibility and retirement planning.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="adult_kids_independent">
                            <input type="radio" name="q6_laterlife" value="adult_kids_independent" style="display:none;">
                            <div class="choice-icon">ðŸŽ‰</div>
                            <div class="choice-label">Kids Independent</div>
                            <div class="choice-brief">Launched and self-supporting</div>
                        </label>
                        <label class="choice-card" data-value="adult_kids_struggling">
                            <input type="radio" name="q6_laterlife" value="adult_kids_struggling" style="display:none;">
                            <div class="choice-icon">ðŸ’¸</div>
                            <div class="choice-label">Kids Struggling</div>
                            <div class="choice-brief">30s but need financial help</div>
                        </label>
                        <label class="choice-card" data-value="active_grandparenting">
                            <input type="radio" name="q6_laterlife" value="active_grandparenting" style="display:none;">
                            <div class="choice-icon">ðŸ‘¶</div>
                            <div class="choice-label">Active Grandparent</div>
                            <div class="choice-brief">Providing regular childcare</div>
                        </label>
                        <label class="choice-card" data-value="aging_parents_alive">
                            <input type="radio" name="q6_laterlife" value="aging_parents_alive" style="display:none;">
                            <div class="choice-icon">ðŸ‘µ</div>
                            <div class="choice-label">Very Elderly Parents (85+)</div>
                            <div class="choice-brief">Still needing significant care</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q6_laterlife-consequence"></div>
                </div>
            </div>

                <!-- SHARED: Career cascades -->
                <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                    <strong>ðŸ’¡ SYSTEMS THINKING: How will your career choices cascade?</strong><br>
                    â€¢ <strong>Module 3 (Relationships):</strong> Work hours affect relationship quality and time together<br>
                    â€¢ <strong>Module 4-5 (Partnership):</strong> Income affects homogamy, marriage timing, financial dynamics<br>
                    â€¢ <strong>Module 6 (Work-Family):</strong> Career flexibility determines caregiving options<br>
                    â€¢ <strong>Module 7 (Crisis):</strong> Income stability affects resilience to job loss/emergency<br><br>
                    <em>No decision is isolatedâ€”your career choice ripples through every life domain.</em>
                </div>

                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn btn-primary" onclick="completeModule2()">Complete Module 2 â†’</button>
                </div>
            </div><!-- End module2-decisions-container -->
        </div>

        <!-- MODULE 3: LOVE, INTIMACY & COMMUNICATION -->
        <div id="module3" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module3-section-progress" class="section-progress-container"></div>

            <!-- Advantage Display -->
            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <div id="advantage-m3" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content (rendered by ModuleSectionController) -->
            <div id="module3-section-content" class="section-content-area"></div>

            <!-- Previous Module Summary (populated dynamically) -->
            <div id="module3-intro-summary"></div>

            <!-- EXISTING DECISION CONTENT (shown during DECISION_1 and DECISION_2 sections) -->
            <div id="module3-decisions-container">
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapters 5-6 (Love, Intimacy & Communication)
                </div>

            <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                <strong>ðŸŽ¯ Life Course Perspective in Action</strong><br>
                Hammond Ch. 5-6 explains that <span class="glossary-term">romantic love<span class="glossary-tooltip"><strong>Romantic Love</strong><br>Cultural belief that marriage should be based on passionate emotional attachment.<br><em>Hammond Ch. 5</em></span></span> and <span class="glossary-term">attachment styles<span class="glossary-tooltip"><strong>Attachment Theory</strong><br>How childhood bonds create relationship patterns in adulthood.<br><em>Hammond Ch. 5</em></span></span> vary across the lifespan. Relationship challenges at 25 (forming partnerships) differ dramatically from 35 (maintaining relationships while parenting) or 50 (long-term relationship evaluation). <span class="glossary-term">Emotional labor<span class="glossary-tooltip"><strong>Emotional Labor</strong><br>Invisible work of managing relationships and emotions.<br><em>Hammond Ch. 6</em></span></span> is gendered at every life stage.
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE YOUR PROGRESS!</strong> Click "Export Game Data" regularly. You need this for Canvas assignments!
            </div>

            <!-- BRANCH 1: TRADITIONAL AGE (18-24) -->
            <div id="module3_traditional" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">25</span> years old.</strong> You're exploring romantic relationships and learning communication patterns. Your <span class="glossary-term">attachment style<span class="glossary-tooltip"><strong>Attachment Theory</strong><br>Childhood bonds shape adult relationships.<br><em>Hammond Ch. 5</em></span></span> from Module 1 shapes how you approach intimacy. These early relationship patterns will follow you through life.
                </p>

                <div class="question-group" id="q7_traditional-group">
                    <label><strong>DECISION 5:</strong> Early Relationship Path - How are you approaching romantic relationships?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 5 shows that relationship timing affects all future decisions. Your Module 2 career choice influences time/energy available for relationships.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="serious_early">
                            <input type="radio" name="q7_traditional" value="serious_early" style="display:none;">
                            <div class="choice-icon">ðŸ’‘</div>
                            <div class="choice-label">Committed Early</div>
                            <div class="choice-brief">Prioritize relationship</div>
                        </label>
                        <label class="choice-card" data-value="exploratory_dating">
                            <input type="radio" name="q7_traditional" value="exploratory_dating" style="display:none;">
                            <div class="choice-icon">ðŸ”</div>
                            <div class="choice-label">Exploratory Dating</div>
                            <div class="choice-brief">Learn through relationships</div>
                        </label>
                        <label class="choice-card" data-value="career_focus_defer">
                            <input type="radio" name="q7_traditional" value="career_focus_defer" style="display:none;">
                            <div class="choice-icon">ðŸ’¼</div>
                            <div class="choice-label">Career Priority</div>
                            <div class="choice-brief">Deliberately delay romance</div>
                        </label>
                        <label class="choice-card" data-value="balanced_organic">
                            <input type="radio" name="q7_traditional" value="balanced_organic" style="display:none;">
                            <div class="choice-icon">ðŸŒ±</div>
                            <div class="choice-label">Balanced Approach</div>
                            <div class="choice-brief">Open if right person appears</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q7_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q8_traditional-group">
                    <label><strong>DECISION 6:</strong> Communication Style - How will you handle conflict in relationships?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 6 discusses Gottman's <span class="glossary-term">Four Horsemen<span class="glossary-tooltip"><strong>Four Horsemen</strong><br>Communication patterns predicting divorce: criticism, contempt, defensiveness, stonewalling.<br><em>Hammond Ch. 6</em></span></span>. Learning healthy communication NOW prevents future relationship distress.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="direct_expressive">
                            <input type="radio" name="q8_traditional" value="direct_expressive" style="display:none;">
                            <div class="choice-icon">ðŸ’¬</div>
                            <div class="choice-label">Direct & Expressive</div>
                            <div class="choice-brief">Address issues immediately</div>
                        </label>
                        <label class="choice-card" data-value="harmony_prioritizing">
                            <input type="radio" name="q8_traditional" value="harmony_prioritizing" style="display:none;">
                            <div class="choice-icon">â˜®ï¸</div>
                            <div class="choice-label">Harmony-Seeking</div>
                            <div class="choice-brief">Avoid confrontation</div>
                        </label>
                        <label class="choice-card" data-value="problem_solving_logical">
                            <input type="radio" name="q8_traditional" value="problem_solving_logical" style="display:none;">
                            <div class="choice-icon">ðŸ§ </div>
                            <div class="choice-label">Analytical Problem-Solver</div>
                            <div class="choice-brief">Focus on solutions</div>
                        </label>
                        <label class="choice-card" data-value="emotional_labor_manager">
                            <input type="radio" name="q8_traditional" value="emotional_labor_manager" style="display:none;">
                            <div class="choice-icon">ðŸ“‹</div>
                            <div class="choice-label">Relationship Manager</div>
                            <div class="choice-brief">Active maintenance</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q8_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING ADULT (25-35) -->
            <div id="module3_returning" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">32</span> years old.</strong> You may already be partnered from earlier years, OR you're navigating dating after divorce/breakup, OR forming new relationships while managing work and possibly children. Relationship dynamics at this stage intersect with established responsibilities.
                </p>

                <div class="question-group" id="q7_returning-group">
                    <label><strong>DECISION 5:</strong> Relationship Status - Where are you in your relationship journey?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Life stage affects relationship options and constraints. Your Module 2 career decision and life circumstances shape what's possible.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="established_partnership">
                            <input type="radio" name="q7_returning" value="established_partnership" style="display:none;">
                            <div class="choice-icon">ðŸ’</div>
                            <div class="choice-label">Established Partnership</div>
                            <div class="choice-brief">3-8 years together</div>
                        </label>
                        <label class="choice-card" data-value="post_breakup_healing">
                            <input type="radio" name="q7_returning" value="post_breakup_healing" style="display:none;">
                            <div class="choice-icon">ðŸ’”</div>
                            <div class="choice-label">Post-Breakup/Divorce</div>
                            <div class="choice-brief">Rebuilding after loss</div>
                        </label>
                        <label class="choice-card" data-value="new_relationship_forming">
                            <input type="radio" name="q7_returning" value="new_relationship_forming" style="display:none;">
                            <div class="choice-icon">ðŸŒŸ</div>
                            <div class="choice-label">New Relationship</div>
                            <div class="choice-brief">Met someone recently</div>
                        </label>
                        <label class="choice-card" data-value="single_by_choice">
                            <input type="radio" name="q7_returning" value="single_by_choice" style="display:none;">
                            <div class="choice-icon">ðŸ¦…</div>
                            <div class="choice-label">Single by Choice</div>
                            <div class="choice-brief">Prioritizing independence</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q7_returning-consequence"></div>
                </div>

                <div class="question-group" id="q8_returning-group">
                    <label><strong>DECISION 6:</strong> Communication Challenges - What's your biggest relationship communication issue?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">32</span>, relationship communication intersects with work stress, time scarcity, and life demands. Hammond Ch. 6 explains how stress affects communication quality.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="established_patterns">
                            <input type="radio" name="q8_returning" value="established_patterns" style="display:none;">
                            <div class="choice-icon">ðŸ”„</div>
                            <div class="choice-label">Established Patterns</div>
                            <div class="choice-brief">Years of learned dynamics</div>
                        </label>
                        <label class="choice-card" data-value="seeking_improvement">
                            <input type="radio" name="q8_returning" value="seeking_improvement" style="display:none;">
                            <div class="choice-icon">ðŸ“ˆ</div>
                            <div class="choice-label">Seeking Improvement</div>
                            <div class="choice-brief">Therapy or self-work</div>
                        </label>
                        <label class="choice-card" data-value="conflict_avoidant">
                            <input type="radio" name="q8_returning" value="conflict_avoidant" style="display:none;">
                            <div class="choice-icon">ðŸ™ˆ</div>
                            <div class="choice-label">Conflict Avoidant</div>
                            <div class="choice-brief">Keeping peace at cost</div>
                        </label>
                        <label class="choice-card" data-value="direct_negotiation">
                            <input type="radio" name="q8_returning" value="direct_negotiation" style="display:none;">
                            <div class="choice-icon">ðŸ¤</div>
                            <div class="choice-label">Direct Negotiation</div>
                            <div class="choice-brief">Explicit problem-solving</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q8_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER (36-50) -->
            <div id="module3_midcareer" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">44</span> years old.</strong> You're likely in a long-term partnership (15-25 years) OR navigating "gray divorce" OR rebuilding after divorce. Relationships at this stage face different challenges: long-term maintenance, potential staleness, peak life demands, or late-life rediscovery.
                </p>

                <div class="question-group" id="q7_midcareer-group">
                    <label><strong>DECISION 5:</strong> Long-Term Relationship Status - Where do you stand?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 5-6 show that long-term relationships require active maintenance. Couples at midlife face unique challenges balancing partnership with peak demands.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="long_term_stable">
                            <input type="radio" name="q7_midcareer" value="long_term_stable" style="display:none;">
                            <div class="choice-icon">ðŸ </div>
                            <div class="choice-label">Long-Term Stable</div>
                            <div class="choice-brief">15+ years together</div>
                        </label>
                        <label class="choice-card" data-value="midlife_strain">
                            <input type="radio" name="q7_midcareer" value="midlife_strain" style="display:none;">
                            <div class="choice-icon">âš ï¸</div>
                            <div class="choice-label">Relationship Strain</div>
                            <div class="choice-brief">Challenges emerging</div>
                        </label>
                        <label class="choice-card" data-value="remarried_blended">
                            <input type="radio" name="q7_midcareer" value="remarried_blended" style="display:none;">
                            <div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                            <div class="choice-label">Remarried/Blended</div>
                            <div class="choice-brief">Second marriage dynamics</div>
                        </label>
                        <label class="choice-card" data-value="single_midlife">
                            <input type="radio" name="q7_midcareer" value="single_midlife" style="display:none;">
                            <div class="choice-icon">ðŸ”</div>
                            <div class="choice-label">Single at Midlife</div>
                            <div class="choice-brief">Dating or independent</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q7_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q8_midcareer-group">
                    <label><strong>DECISION 6:</strong> Midlife Relationship Challenges - What strains your relationship most?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">44</span>, relationships face unique pressures: sandwich generation demands, career peak, potential empty nest, aging and health changes.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="comfortable_routine">
                            <input type="radio" name="q8_midcareer" value="comfortable_routine" style="display:none;">
                            <div class="choice-icon">ðŸ”</div>
                            <div class="choice-label">Comfortable Routine</div>
                            <div class="choice-brief">Predictable patterns</div>
                        </label>
                        <label class="choice-card" data-value="rekindling_effort">
                            <input type="radio" name="q8_midcareer" value="rekindling_effort" style="display:none;">
                            <div class="choice-icon">ðŸ”¥</div>
                            <div class="choice-label">Rekindling Effort</div>
                            <div class="choice-brief">Intentional reconnection</div>
                        </label>
                        <label class="choice-card" data-value="parallel_lives">
                            <input type="radio" name="q8_midcareer" value="parallel_lives" style="display:none;">
                            <div class="choice-icon">â†”ï¸</div>
                            <div class="choice-label">Parallel Lives</div>
                            <div class="choice-brief">Coexisting separately</div>
                        </label>
                        <label class="choice-card" data-value="transparent_partnership">
                            <input type="radio" name="q8_midcareer" value="transparent_partnership" style="display:none;">
                            <div class="choice-icon">ðŸªŸ</div>
                            <div class="choice-label">Transparent Partnership</div>
                            <div class="choice-brief">Full honesty practice</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q8_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE (50+) -->
            <div id="module3_laterlife" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">60</span> years old.</strong> You may be in a decades-long partnership, navigating widowhood, post-divorce and single, or forming new late-life relationships. Relationships at this stage involve legacy, health changes, retirement transitions, and generativity (focus on next generation).
                </p>

                <div class="question-group" id="q7_laterlife-group">
                    <label><strong>DECISION 5:</strong> Late-Life Relationship Status - Your current situation?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 5 explains that relationship needs evolve across lifespan. Late-life relationships prioritize companionship, care, and legacy over passion or economic partnership.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="long_marriage_thriving">
                            <input type="radio" name="q7_laterlife" value="long_marriage_thriving" style="display:none;">
                            <div class="choice-icon">ðŸ’Ž</div>
                            <div class="choice-label">Long Marriage Thriving</div>
                            <div class="choice-brief">25+ years strong</div>
                        </label>
                        <label class="choice-card" data-value="gray_divorce">
                            <input type="radio" name="q7_laterlife" value="gray_divorce" style="display:none;">
                            <div class="choice-icon">ðŸ’”</div>
                            <div class="choice-label">Gray Divorce</div>
                            <div class="choice-brief">Late-life separation</div>
                        </label>
                        <label class="choice-card" data-value="widowed">
                            <input type="radio" name="q7_laterlife" value="widowed" style="display:none;">
                            <div class="choice-icon">ðŸ•¯ï¸</div>
                            <div class="choice-label">Widowed</div>
                            <div class="choice-brief">Lost life partner</div>
                        </label>
                        <label class="choice-card" data-value="late_life_romance">
                            <input type="radio" name="q7_laterlife" value="late_life_romance" style="display:none;">
                            <div class="choice-icon">ðŸŒ¹</div>
                            <div class="choice-label">Late-Life Romance</div>
                            <div class="choice-brief">New love after 50</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q7_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q8_laterlife-group">
                    <label><strong>DECISION 6:</strong> Late-Life Relationship Priorities - What matters most now?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 6 explains that communication needs shift in later lifeâ€”focus on companionship, health management, legacy, and caregiving rather than passion or child-rearing.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="decades_of_practice">
                            <input type="radio" name="q8_laterlife" value="decades_of_practice" style="display:none;">
                            <div class="choice-icon">ðŸ“š</div>
                            <div class="choice-label">Decades of Practice</div>
                            <div class="choice-brief">Well-worn patterns</div>
                        </label>
                        <label class="choice-card" data-value="health_focused">
                            <input type="radio" name="q8_laterlife" value="health_focused" style="display:none;">
                            <div class="choice-icon">ðŸ¥</div>
                            <div class="choice-label">Health-Focused</div>
                            <div class="choice-brief">Medical decisions together</div>
                        </label>
                        <label class="choice-card" data-value="legacy_discussions">
                            <input type="radio" name="q8_laterlife" value="legacy_discussions" style="display:none;">
                            <div class="choice-icon">ðŸ“œ</div>
                            <div class="choice-label">Legacy Discussions</div>
                            <div class="choice-brief">Values and inheritance</div>
                        </label>
                        <label class="choice-card" data-value="companionate_comfort">
                            <input type="radio" name="q8_laterlife" value="companionate_comfort" style="display:none;">
                            <div class="choice-icon">â˜•</div>
                            <div class="choice-label">Companionate Comfort</div>
                            <div class="choice-brief">Quiet togetherness</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q8_laterlife-consequence"></div>
                </div>
            </div>

            <!-- SHARED: Relationship cascades -->
            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ SYSTEMS THINKING: How will your relationship patterns cascade?</strong><br>
                â€¢ <strong>Module 4 (Partner Selection):</strong> Communication style shapes compatibility and partner choice<br>
                â€¢ <strong>Module 5 (Marriage Timing):</strong> Relationship status determines when/if you formalize partnership<br>
                â€¢ <strong>Module 6 (Work-Family):</strong> Communication patterns predict how you'll negotiate caregiving<br>
                â€¢ <strong>Module 7 (Crisis):</strong> Relationship quality determines resilience when facing challenges<br><br>
                <em>Your relationship communication affects every future life domain decision.</em>
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE NOW!</strong> Export your data before continuing. Required for Canvas Module 3 reflection assignment.
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule3()">Complete Module 3 â†’</button>
            </div>
            </div> <!-- End module3-decisions-container -->
        </div>

        <!-- MODULE 4: SEXUALITY & MATE SELECTION -->
        <div id="module4" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module4-section-progress" class="section-progress-container"></div>

            <!-- Advantage Display -->
            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <div id="advantage-m4" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content (rendered by ModuleSectionController) -->
            <div id="module4-section-content" class="section-content-area"></div>

            <!-- Previous Module Summary (populated dynamically) -->
            <div id="module4-intro-summary"></div>

            <!-- EXISTING DECISION CONTENT (shown during DECISION_1 and DECISION_2 sections) -->
            <div id="module4-decisions-container">
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapters 7-8 (Sexuality & Mate Selection)
                </div>

            <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                <strong>ðŸŽ¯ Life Course Perspective in Action</strong><br>
                Hammond Ch. 7-8 explains <span class="glossary-term">homogamy<span class="glossary-tooltip"><strong>Homogamy</strong><br>Like marries likeâ€”education, class, values.<br><em>Hammond Ch. 8</em></span></span> and <span class="glossary-term">marriage markets<span class="glossary-tooltip"><strong>Marriage Market</strong><br>Partnering as marketplace with supply/demand.<br><em>Hammond Ch. 8</em></span></span>. Partner selection at 27 (wide market, focus on potential) differs from 35 (narrower market, proven compatibility) or 50 (re-partnering after loss). <span class="glossary-term">Sexual scripts<span class="glossary-tooltip"><strong>Sexual Scripts</strong><br>Gendered cultural rules for sexuality.<br><em>Hammond Ch. 7</em></span></span> evolve across life stages.
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE YOUR PROGRESS!</strong> Export data regularly for Canvas assignments!
            </div>

            <!-- BRANCH 1: TRADITIONAL AGE (18-24) -->
            <div id="module4_traditional" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">27</span> years old.</strong> You're choosing your first serious long-term partner. Your Module 2 education/career shaped your <span class="glossary-term">marriage market<span class="glossary-tooltip"><strong>Marriage Market</strong><br>Who you meet and compete with for partners.<br><em>Hammond Ch. 8</em></span></span>â€”where you meet potential partners and what you bring to relationships.
                </p>

                <div class="question-group" id="q9_traditional-group">
                    <label><strong>DECISION 7:</strong> Partner Selection - What do you prioritize?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 8: <span class="glossary-term">Homogamy<span class="glossary-tooltip"><strong>Homogamy</strong><br>Like marries like across education, class, values.<br><em>Hammond Ch. 8</em></span></span> means you'll likely choose someone similar.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="education_career_match">
                            <input type="radio" name="q9_traditional" value="education_career_match" style="display:none;">
                            <div class="choice-icon">ðŸŽ“</div>
                            <div class="choice-label">Career Compatibility</div>
                            <div class="choice-brief">Similar education & ambitions</div>
                        </label>
                        <label class="choice-card" data-value="emotional_connection">
                            <input type="radio" name="q9_traditional" value="emotional_connection" style="display:none;">
                            <div class="choice-icon">â¤ï¸</div>
                            <div class="choice-label">Emotional Connection</div>
                            <div class="choice-brief">Deep intimacy first</div>
                        </label>
                        <label class="choice-card" data-value="family_values_align">
                            <input type="radio" name="q9_traditional" value="family_values_align" style="display:none;">
                            <div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§</div>
                            <div class="choice-label">Family Values</div>
                            <div class="choice-brief">Shared vision for family</div>
                        </label>
                        <label class="choice-card" data-value="economic_stability">
                            <input type="radio" name="q9_traditional" value="economic_stability" style="display:none;">
                            <div class="choice-icon">ðŸ’°</div>
                            <div class="choice-label">Economic Security</div>
                            <div class="choice-brief">Financial stability priority</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q9_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q10_traditional-group">
                    <label><strong>DECISION 8:</strong> Relationship Pacing - How do you progress?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Hammond Ch. 7: <span class="glossary-term">Sexual scripts<span class="glossary-tooltip"><strong>Sexual Scripts</strong><br>Cultural rules for relationship progression.<br><em>Hammond Ch. 7</em></span></span> shape relationship timing.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="traditional_pacing">
                            <input type="radio" name="q10_traditional" value="traditional_pacing" style="display:none;">
                            <div class="choice-icon">ðŸ’’</div>
                            <div class="choice-label">Traditional Path</div>
                            <div class="choice-brief">Datingâ†’engagementâ†’marriage</div>
                        </label>
                        <label class="choice-card" data-value="egalitarian_progressive">
                            <input type="radio" name="q10_traditional" value="egalitarian_progressive" style="display:none;">
                            <div class="choice-icon">âš–ï¸</div>
                            <div class="choice-label">Egalitarian</div>
                            <div class="choice-brief">Shared decisions, no gender roles</div>
                        </label>
                        <label class="choice-card" data-value="practical_testing">
                            <input type="radio" name="q10_traditional" value="practical_testing" style="display:none;">
                            <div class="choice-icon">ðŸ </div>
                            <div class="choice-label">Cohabit First</div>
                            <div class="choice-brief">Test compatibility before commit</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q10_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING ADULT (25-35) -->
            <div id="module4_returning" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">34</span> years old.</strong> You're either evaluating an existing partnership formed earlier OR you're re-partnering after divorce/breakup. Your Module 3 relationship status determines your path. Partner evaluation differs when you have life experience and established responsibilities.
                </p>

                <div class="question-group" id="q9_returning-group">
                    <label><strong>DECISION 7:</strong> Partner Evaluation - Where do you stand?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">34</span>, you assess partners differentlyâ€”you know yourself better, have established life.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="current_partner_strong">
                            <input type="radio" name="q9_returning" value="current_partner_strong" style="display:none;">
                            <div class="choice-icon">ðŸ’ª</div>
                            <div class="choice-label">Partner: Strong Fit</div>
                            <div class="choice-brief">Ready to deepen commitment</div>
                        </label>
                        <label class="choice-card" data-value="current_partner_reassessing">
                            <input type="radio" name="q9_returning" value="current_partner_reassessing" style="display:none;">
                            <div class="choice-icon">ðŸ¤”</div>
                            <div class="choice-label">Partner: Reassessing</div>
                            <div class="choice-brief">Questioning compatibility</div>
                        </label>
                        <label class="choice-card" data-value="new_partner_post_breakup">
                            <input type="radio" name="q9_returning" value="new_partner_post_breakup" style="display:none;">
                            <div class="choice-icon">ðŸŒŸ</div>
                            <div class="choice-label">New Partner</div>
                            <div class="choice-brief">Post-breakup fresh start</div>
                        </label>
                        <label class="choice-card" data-value="single_selective">
                            <input type="radio" name="q9_returning" value="single_selective" style="display:none;">
                            <div class="choice-icon">ðŸŽ¯</div>
                            <div class="choice-label">Single, Selective</div>
                            <div class="choice-brief">High standards, no settling</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q9_returning-consequence"></div>
                </div>

                <div class="question-group" id="q10_returning-group">
                    <label><strong>DECISION 8:</strong> Relationship Priorities - What matters most?</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">34</span>, experience clarifies what's essential vs. negotiable.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="life_goal_alignment">
                            <input type="radio" name="q10_returning" value="life_goal_alignment" style="display:none;">
                            <div class="choice-icon">ðŸŽ¯</div>
                            <div class="choice-label">Life Goals Aligned</div>
                            <div class="choice-brief">Kids, career, location match</div>
                        </label>
                        <label class="choice-card" data-value="proven_reliability">
                            <input type="radio" name="q10_returning" value="proven_reliability" style="display:none;">
                            <div class="choice-icon">âœ…</div>
                            <div class="choice-label">Proven Reliability</div>
                            <div class="choice-brief">Actions over words</div>
                        </label>
                        <label class="choice-card" data-value="work_family_philosophy">
                            <input type="radio" name="q10_returning" value="work_family_philosophy" style="display:none;">
                            <div class="choice-icon">âš–ï¸</div>
                            <div class="choice-label">Work-Family Match</div>
                            <div class="choice-brief">Same caregiving philosophy</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q10_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER (36-50) -->
            <div id="module4_midcareer" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">46</span> years old.</strong> You're likely in a long-term partnership (15-25 years) evaluating compatibility OR you're re-partnering after gray divorce/widowhood. Partner assessment at midlife involves reassessing long relationships or navigating dating after decades.
                </p>

                <div class="question-group" id="q9_midcareer-group">
                    <label><strong>DECISION 7:</strong> Midlife Partnership Evaluation</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">46</span>, assessing decades-long partnerships or starting over.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="longterm_satisfying">
                            <input type="radio" name="q9_midcareer" value="longterm_satisfying" style="display:none;">
                            <div class="choice-icon">ðŸ’Ž</div>
                            <div class="choice-label">Still Compatible</div>
                            <div class="choice-brief">Decades together, still aligned</div>
                        </label>
                        <label class="choice-card" data-value="longterm_drifted">
                            <input type="radio" name="q9_midcareer" value="longterm_drifted" style="display:none;">
                            <div class="choice-icon">â†”ï¸</div>
                            <div class="choice-label">Grown Apart</div>
                            <div class="choice-brief">Lost intimacy over years</div>
                        </label>
                        <label class="choice-card" data-value="new_partner_postdivorce">
                            <input type="radio" name="q9_midcareer" value="new_partner_postdivorce" style="display:none;">
                            <div class="choice-icon">ðŸŒŸ</div>
                            <div class="choice-label">Post-Divorce Partner</div>
                            <div class="choice-brief">Re-partnering after split</div>
                        </label>
                        <label class="choice-card" data-value="postwidow_dating">
                            <input type="radio" name="q9_midcareer" value="postwidow_dating" style="display:none;">
                            <div class="choice-icon">ðŸ•¯ï¸</div>
                            <div class="choice-label">Dating After Loss</div>
                            <div class="choice-brief">Post-widowhood companionship</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q9_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q10_midcareer-group">
                    <label><strong>DECISION 8:</strong> Midlife Partnership Priorities</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        Focus shifts to companionship, health, legacy, caregiving.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="deep_companionship">
                            <input type="radio" name="q10_midcareer" value="deep_companionship" style="display:none;">
                            <div class="choice-icon">â¤ï¸</div>
                            <div class="choice-label">Deep Companionship</div>
                            <div class="choice-brief">Emotional intimacy first</div>
                        </label>
                        <label class="choice-card" data-value="mutual_caregiving">
                            <input type="radio" name="q10_midcareer" value="mutual_caregiving" style="display:none;">
                            <div class="choice-icon">ðŸ¥</div>
                            <div class="choice-label">Caregiving Partnership</div>
                            <div class="choice-brief">Health support together</div>
                        </label>
                        <label class="choice-card" data-value="independent_autonomy">
                            <input type="radio" name="q10_midcareer" value="independent_autonomy" style="display:none;">
                            <div class="choice-icon">ðŸ¦…</div>
                            <div class="choice-label">LAT / Autonomy</div>
                            <div class="choice-brief">Together but separate homes</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q10_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE (50+) -->
            <div id="module4_laterlife" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're <span class="dynamic-age">62</span> years old.</strong> You're either sustaining a decades-long partnership (30-40+ years), navigating widowhood, post-divorce single, or forming new late-life relationships. Partner dynamics at this stage involve health, caregiving, legacy, and companionship rather than romance or reproduction.
                </p>

                <div class="question-group" id="q9_laterlife-group">
                    <label><strong>DECISION 7:</strong> Late-Life Partnership Status</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">62</span>, sustaining long marriages, coping with loss, or forming new relationships.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="decades_long_partnership">
                            <input type="radio" name="q9_laterlife" value="decades_long_partnership" style="display:none;">
                            <div class="choice-icon">ðŸ’Ž</div>
                            <div class="choice-label">30-40+ Years Together</div>
                            <div class="choice-brief">Partnership is identity</div>
                        </label>
                        <label class="choice-card" data-value="recent_widowhood">
                            <input type="radio" name="q9_laterlife" value="recent_widowhood" style="display:none;">
                            <div class="choice-icon">ðŸ•¯ï¸</div>
                            <div class="choice-label">Recent Widowhood</div>
                            <div class="choice-brief">Navigating loss and grief</div>
                        </label>
                        <label class="choice-card" data-value="gray_divorce_single">
                            <input type="radio" name="q9_laterlife" value="gray_divorce_single" style="display:none;">
                            <div class="choice-icon">ðŸ¦…</div>
                            <div class="choice-label">Post-Divorce Solo</div>
                            <div class="choice-brief">Freedom after split</div>
                        </label>
                        <label class="choice-card" data-value="new_latelife_companion">
                            <input type="radio" name="q9_laterlife" value="new_latelife_companion" style="display:none;">
                            <div class="choice-icon">ðŸŒ¹</div>
                            <div class="choice-label">New Companionship</div>
                            <div class="choice-brief">LAT or late romance</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q9_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q10_laterlife-group">
                    <label><strong>DECISION 8:</strong> Late-Life Partnership Priorities</label>
                    <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                        At <span class="dynamic-age">62</span>, priorities: health, caregiving, legacy, companionship.
                    </p>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="health_caregiving_focus">
                            <input type="radio" name="q10_laterlife" value="health_caregiving_focus" style="display:none;">
                            <div class="choice-icon">ðŸ¥</div>
                            <div class="choice-label">Health Partnership</div>
                            <div class="choice-brief">Mutual caregiving focus</div>
                        </label>
                        <label class="choice-card" data-value="companionship_legacy">
                            <input type="radio" name="q10_laterlife" value="companionship_legacy" style="display:none;">
                            <div class="choice-icon">âœ¨</div>
                            <div class="choice-label">Companionship & Legacy</div>
                            <div class="choice-brief">Travel, grandkids, memories</div>
                        </label>
                        <label class="choice-card" data-value="independent_community">
                            <input type="radio" name="q10_laterlife" value="independent_community" style="display:none;">
                            <div class="choice-icon">ðŸ¤</div>
                            <div class="choice-label">Independent + Community</div>
                            <div class="choice-brief">Friends and family, not partner</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q10_laterlife-consequence"></div>
                </div>
            </div>

            <!-- SHARED: Connection box -->
            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ SYSTEMS THINKING: How will partner selection cascade?</strong><br>
                â€¢ <strong>Module 5 (Partnership Formation):</strong> Selection criteria determine marriage timing and structure<br>
                â€¢ <strong>Module 6 (Work-Family):</strong> Partner's values shape childcare and domestic labor negotiations<br>
                â€¢ <strong>Module 7 (Crisis):</strong> Partner compatibility affects resilience during stress<br><br>
                <em>Homogamy creates path dependencyâ€”choosing similar partners reproduces class and values across generations.</em>
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE NOW!</strong> Export your data before continuing. Required for Canvas Module 4 assignment.
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule4()">Complete Module 4 â†’</button>
            </div>
            </div> <!-- End module4-decisions-container -->
        </div>

        <!-- MODULE 5: MARRIAGE & PARTNERSHIP FORMATION -->
        <div id="module5" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module5-section-progress" class="section-progress-container"></div>

            <!-- Advantage Display -->
            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <div id="advantage-m5" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content -->
            <div id="module5-section-content" class="section-content-area"></div>

            <!-- Previous Module Summary -->
            <div id="module5-intro-summary"></div>

            <!-- EXISTING DECISION CONTENT -->
            <div id="module5-decisions-container">
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapter 9
                </div>

            <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                <strong>ðŸŽ¯ Life Course Perspective in Action</strong><br>
                Hammond Ch. 9: <span class="glossary-term">Marriage bar<span class="glossary-tooltip"><strong>Marriage Bar</strong><br>Economic barriers to marriage.<br><em>Hammond Ch. 9</em></span></span>, <span class="glossary-term">deinstitutionalization<span class="glossary-tooltip"><strong>Deinstitutionalization</strong><br>Marriage shifts from required to optional.<br><em>Hammond Ch. 9</em></span></span>, and <span class="glossary-term">cohabitation<span class="glossary-tooltip"><strong>Cohabitation</strong><br>Living together unmarried.<br><em>Hammond Ch. 9</em></span></span> patterns vary by life stageâ€”first marriage at 29 differs from remarriage at 40 or sustaining 30-year partnerships.
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE YOUR PROGRESS!</strong> Export data regularly for Canvas!
            </div>

            <!-- BRANCH 1: TRADITIONAL (18-24) -->
            <div id="module5_traditional" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're 29 years old.</strong> Many peers are marrying. Your Module 2 career and Module 4 partner determine if you've "cleared" the <span class="glossary-term">marriage bar<span class="glossary-tooltip"><strong>Marriage Bar</strong><br>Economic readiness needed for marriage.<br><em>Hammond Ch. 9</em></span></span>.
                </p>

                <div class="question-group" id="q11_traditional-group">
                    <label><strong>DECISION 9:</strong> Marriage Timing - When will you formalize?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="marry_now_cleared_bar">
                            <input type="radio" name="q11_traditional" value="marry_now_cleared_bar" style="display:none;">
                            <div class="choice-icon">ðŸ’’</div>
                            <div class="choice-label">Marry Now</div>
                            <div class="choice-brief">Cleared the marriage bar</div>
                        </label>
                        <label class="choice-card" data-value="cohabit_pathway">
                            <input type="radio" name="q11_traditional" value="cohabit_pathway" style="display:none;">
                            <div class="choice-icon">ðŸ </div>
                            <div class="choice-label">Cohabit First</div>
                            <div class="choice-brief">Test before commitment</div>
                        </label>
                        <label class="choice-card" data-value="marry_despite_bar">
                            <input type="radio" name="q11_traditional" value="marry_despite_bar" style="display:none;">
                            <div class="choice-icon">â¤ï¸</div>
                            <div class="choice-label">Marry Despite Barriers</div>
                            <div class="choice-brief">Love over economics</div>
                        </label>
                        <label class="choice-card" data-value="cohabit_alternative">
                            <input type="radio" name="q11_traditional" value="cohabit_alternative" style="display:none;">
                            <div class="choice-icon">ðŸ”„</div>
                            <div class="choice-label">Permanent Cohabitation</div>
                            <div class="choice-brief">Reject marriage institution</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q11_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q12_traditional-group">
                    <label><strong>DECISION 10:</strong> Partnership Structure - Financial arrangement?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="traditional_merged">
                            <input type="radio" name="q12_traditional" value="traditional_merged" style="display:none;">
                            <div class="choice-icon">ðŸ‘«</div>
                            <div class="choice-label">Traditional Merged</div>
                            <div class="choice-brief">Joint finances, typed roles</div>
                        </label>
                        <label class="choice-card" data-value="egalitarian_dual_career">
                            <input type="radio" name="q12_traditional" value="egalitarian_dual_career" style="display:none;">
                            <div class="choice-icon">âš–ï¸</div>
                            <div class="choice-label">Egalitarian Dual-Career</div>
                            <div class="choice-brief">Both work, equal labor</div>
                        </label>
                        <label class="choice-card" data-value="semi_autonomous">
                            <input type="radio" name="q12_traditional" value="semi_autonomous" style="display:none;">
                            <div class="choice-icon">ðŸ¤</div>
                            <div class="choice-label">Semi-Autonomous</div>
                            <div class="choice-brief">Shared + separate accounts</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q12_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING (25-35) -->
            <div id="module5_returning" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're 35 years old.</strong> You may already be married (Module 3-4 partnership) OR considering remarriage after divorce. Partnership decisions differ with established life.
                </p>

                <div class="question-group" id="q11_returning-group">
                    <label><strong>DECISION 9:</strong> Partnership Status - Where are you?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="already_married_stable">
                            <input type="radio" name="q11_returning" value="already_married_stable" style="display:none;">
                            <div class="choice-icon">ðŸ’</div>
                            <div class="choice-label">Married, Stable</div>
                            <div class="choice-brief">5-8 years, navigating well</div>
                        </label>
                        <label class="choice-card" data-value="already_married_struggling">
                            <input type="radio" name="q11_returning" value="already_married_struggling" style="display:none;">
                            <div class="choice-icon">âš ï¸</div>
                            <div class="choice-label">Married, Struggling</div>
                            <div class="choice-brief">Facing challenges</div>
                        </label>
                        <label class="choice-card" data-value="remarrying_postdivorce">
                            <input type="radio" name="q11_returning" value="remarrying_postdivorce" style="display:none;">
                            <div class="choice-icon">ðŸ”„</div>
                            <div class="choice-label">Remarrying</div>
                            <div class="choice-brief">Second marriage</div>
                        </label>
                        <label class="choice-card" data-value="cohabiting_longterm">
                            <input type="radio" name="q11_returning" value="cohabiting_longterm" style="display:none;">
                            <div class="choice-icon">ðŸ </div>
                            <div class="choice-label">Long-term Cohabiting</div>
                            <div class="choice-brief">Together, not marrying</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q11_returning-consequence"></div>
                </div>

                <div class="question-group" id="q12_returning-group">
                    <label><strong>DECISION 10:</strong> Partnership Priority - What needs attention?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="strengthen_communication">
                            <input type="radio" name="q12_returning" value="strengthen_communication" style="display:none;">
                            <div class="choice-icon">ðŸ’¬</div>
                            <div class="choice-label">Strengthen Communication</div>
                            <div class="choice-brief">Counseling, date nights</div>
                        </label>
                        <label class="choice-card" data-value="renegotiate_structure">
                            <input type="radio" name="q12_returning" value="renegotiate_structure" style="display:none;">
                            <div class="choice-icon">ðŸ“‹</div>
                            <div class="choice-label">Renegotiate Finances</div>
                            <div class="choice-brief">New agreements needed</div>
                        </label>
                        <label class="choice-card" data-value="accept_status_quo">
                            <input type="radio" name="q12_returning" value="accept_status_quo" style="display:none;">
                            <div class="choice-icon">âœ…</div>
                            <div class="choice-label">Accept Status Quo</div>
                            <div class="choice-brief">Works as-is</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q12_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER (36-50) -->
            <div id="module5_midcareer" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're 47 years old.</strong> You're likely in a long-term marriage (15-25 years) assessing its health OR you're navigating gray divorce or remarriage. Partnership at midlife means evaluating decades together or rebuilding.
                </p>

                <div class="question-group" id="q11_midcareer-group">
                    <label><strong>DECISION 9:</strong> Long-Term Partnership Status</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="longterm_strong">
                            <input type="radio" name="q11_midcareer" value="longterm_strong" style="display:none;">
                            <div class="choice-icon">ðŸ’Ž</div>
                            <div class="choice-label">20+ Years, Strong</div>
                            <div class="choice-brief">Deep companionship</div>
                        </label>
                        <label class="choice-card" data-value="longterm_drifted">
                            <input type="radio" name="q11_midcareer" value="longterm_drifted" style="display:none;">
                            <div class="choice-icon">â†”ï¸</div>
                            <div class="choice-label">Drifted Apart</div>
                            <div class="choice-brief">Coparenting roommates</div>
                        </label>
                        <label class="choice-card" data-value="postdivorce_new_partnership">
                            <input type="radio" name="q11_midcareer" value="postdivorce_new_partnership" style="display:none;">
                            <div class="choice-icon">ðŸŒŸ</div>
                            <div class="choice-label">New Partnership</div>
                            <div class="choice-brief">Post-gray divorce</div>
                        </label>
                        <label class="choice-card" data-value="single_postdivorce">
                            <input type="radio" name="q11_midcareer" value="single_postdivorce" style="display:none;">
                            <div class="choice-icon">ðŸ¦…</div>
                            <div class="choice-label">Single Post-Divorce</div>
                            <div class="choice-brief">Embracing solo life</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q11_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q12_midcareer-group">
                    <label><strong>DECISION 10:</strong> Midlife Partnership Focus</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="reinvest_empty_nest">
                            <input type="radio" name="q12_midcareer" value="reinvest_empty_nest" style="display:none;">
                            <div class="choice-icon">ðŸ”¥</div>
                            <div class="choice-label">Reinvest at Empty Nest</div>
                            <div class="choice-brief">Rediscover partnership</div>
                        </label>
                        <label class="choice-card" data-value="accept_companionate">
                            <input type="radio" name="q12_midcareer" value="accept_companionate" style="display:none;">
                            <div class="choice-icon">â˜•</div>
                            <div class="choice-label">Accept Companionate</div>
                            <div class="choice-brief">Good enough partnership</div>
                        </label>
                        <label class="choice-card" data-value="pursue_gray_divorce">
                            <input type="radio" name="q12_midcareer" value="pursue_gray_divorce" style="display:none;">
                            <div class="choice-icon">ðŸ’”</div>
                            <div class="choice-label">Pursue Gray Divorce</div>
                            <div class="choice-brief">End unsatisfying marriage</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q12_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE (50+) -->
            <div id="module5_laterlife" class="branch-content" style="display:none;">
                <p style="margin-bottom: 25px; color: var(--text-dark); font-weight: 500;">
                    <strong>You're 63 years old.</strong> You're sustaining a decades-long marriage (30-40+ years), navigating widowhood, or in new late-life partnerships. Partnership at this stage focuses on caregiving, companionship, legacy.
                </p>

                <div class="question-group" id="q11_laterlife-group">
                    <label><strong>DECISION 9:</strong> Late-Life Partnership Status</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="decades_marriage_strong">
                            <input type="radio" name="q11_laterlife" value="decades_marriage_strong" style="display:none;">
                            <div class="choice-icon">ðŸ’Ž</div>
                            <div class="choice-label">30-40+ Years Together</div>
                            <div class="choice-brief">Partnership is identity</div>
                        </label>
                        <label class="choice-card" data-value="widowhood">
                            <input type="radio" name="q11_laterlife" value="widowhood" style="display:none;">
                            <div class="choice-icon">ðŸ•¯ï¸</div>
                            <div class="choice-label">Widowhood</div>
                            <div class="choice-brief">Navigating loss</div>
                        </label>
                        <label class="choice-card" data-value="new_latelife_partnership">
                            <input type="radio" name="q11_laterlife" value="new_latelife_partnership" style="display:none;">
                            <div class="choice-icon">ðŸŒ¹</div>
                            <div class="choice-label">New Late-Life Partnership</div>
                            <div class="choice-brief">LAT or companionship</div>
                        </label>
                        <label class="choice-card" data-value="single_by_choice">
                            <input type="radio" name="q11_laterlife" value="single_by_choice" style="display:none;">
                            <div class="choice-icon">ðŸ¦…</div>
                            <div class="choice-label">Single by Choice</div>
                            <div class="choice-brief">Embracing solo aging</div>
                        </label>
                    </div>
                    <div class="consequence-panel" id="q11_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q12_laterlife-group">
                    <label><strong>DECISION 10:</strong> Late-Life Partnership Priorities</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="caregiving_partnership">
                            <input type="radio" name="q12_laterlife" value="caregiving_partnership" style="display:none;">
                            <div class="choice-icon">ðŸ¥</div>
                            <div class="choice-label">Mutual Caregiving</div>
                            <div class="choice-brief">Health partnership</div>
                        </label>
                        <label class="choice-card" data-value="companionship_active">
                            <input type="radio" name="q12_laterlife" value="companionship_active" style="display:none;">
                            <div class="choice-icon">âœ¨</div>
                            <div class="choice-label">Active Companionship</div>
                            <div class="choice-brief">Travel, grandkids, hobbies</div>
                        </label>
                        <label class="choice-card" data-value="independent_community">
                            <input type="radio" name="q12_laterlife" value="independent_community" style="display:none;">
                            <div class="choice-icon">ðŸ¤</div>
                            <div class="choice-label">Independent + Community</div>
                            <div class="choice-brief">Friends, family network</div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ SYSTEMS THINKING: Partnership cascades</strong><br>
                â€¢ <strong>Module 6:</strong> Marriage structure determines work-family negotiations<br>
                â€¢ <strong>Module 7:</strong> Legal/financial arrangements affect crisis resilience<br><br>
                <em>Marriage bar increasingly class-stratifiedâ€”college-educated delay but marry; working-class face persistent barriers.</em>
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE NOW!</strong> Canvas Module 5 assignment requires this data.
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule5()">Complete Module 5 â†’</button>
            </div>
            </div> <!-- End module5-decisions-container -->
        </div>

        <!-- MODULE 6: PARENTHOOD & WORK-FAMILY BALANCE -->
        <div id="module6" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module6-section-progress" class="section-progress-container"></div>

            <!-- Advantage Display -->
            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <div id="advantage-m6" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content -->
            <div id="module6-section-content" class="section-content-area"></div>

            <!-- Previous Module Summary -->
            <div id="module6-intro-summary"></div>

            <!-- EXISTING DECISION CONTENT -->
            <div id="module6-decisions-container">
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapters 10-12
                </div>

            <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                <strong>ðŸŽ¯ Life Course Perspective:</strong> Work-family challenges differ by life stageâ€”young children (31), current childcare crisis (36), teenagers (48), grandchildren (64).
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE!</strong> Export data for Canvas Module 6 assignment.
            </div>

            <!-- BRANCH 1: TRADITIONAL -->
            <div id="module6_traditional" class="branch-content" style="display:none;">
                <p><strong>You're 31.</strong> Planning/having young children. Childcare costs $1,000-$1,500/month.</p>

                <div class="question-group" id="q13_traditional-group">
                    <label><strong>DECISION 11:</strong> Childcare Strategy?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="dual_career_purchased"><input type="radio" name="q13_traditional" value="dual_career_purchased" style="display:none;"><div class="choice-icon">ðŸ‘«</div><div class="choice-label">Dual-Career + Daycare</div><div class="choice-brief">Both work, pay for care</div></label>
                        <label class="choice-card" data-value="one_exits_career"><input type="radio" name="q13_traditional" value="one_exits_career" style="display:none;"><div class="choice-icon">ðŸ </div><div class="choice-label">One Parent Exits</div><div class="choice-brief">Stay-home parent</div></label>
                        <label class="choice-card" data-value="family_network"><input type="radio" name="q13_traditional" value="family_network" style="display:none;"><div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div><div class="choice-label">Family Network</div><div class="choice-brief">Grandparents help</div></label>
                    </div>
                    <div class="consequence-panel" id="q13_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q14_traditional-group">
                    <label><strong>DECISION 12:</strong> Domestic Labor Division?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="traditional_gendered"><input type="radio" name="q14_traditional" value="traditional_gendered" style="display:none;"><div class="choice-icon">ðŸ‘©â€ðŸ³</div><div class="choice-label">Traditional Gendered</div><div class="choice-brief">Mother does most</div></label>
                        <label class="choice-card" data-value="egalitarian_50_50"><input type="radio" name="q14_traditional" value="egalitarian_50_50" style="display:none;"><div class="choice-icon">âš–ï¸</div><div class="choice-label">Egalitarian 50/50</div><div class="choice-brief">Split equally</div></label>
                        <label class="choice-card" data-value="outsource_services"><input type="radio" name="q14_traditional" value="outsource_services" style="display:none;"><div class="choice-icon">ðŸ’°</div><div class="choice-label">Outsource Services</div><div class="choice-brief">Hire help</div></label>
                    </div>
                    <div class="consequence-panel" id="q14_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING -->
            <div id="module6_returning" class="branch-content" style="display:none;">
                <p><strong>You're 36.</strong> Young kids NOW. In the thick of childcare crisis, exhausted.</p>

                <div class="question-group" id="q13_returning-group">
                    <label><strong>DECISION 11:</strong> Current Reality?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="dual_drowning"><input type="radio" name="q13_returning" value="dual_drowning" style="display:none;"><div class="choice-icon">ðŸ˜°</div><div class="choice-label">Dual-Career Drowning</div><div class="choice-brief">Exhausted, second shift</div></label>
                        <label class="choice-card" data-value="home_trapped"><input type="radio" name="q13_returning" value="home_trapped" style="display:none;"><div class="choice-icon">ðŸ </div><div class="choice-label">Home, Feeling Trapped</div><div class="choice-brief">Career paused, isolated</div></label>
                        <label class="choice-card" data-value="family_constrained"><input type="radio" name="q13_returning" value="family_constrained" style="display:none;"><div class="choice-icon">ðŸ‘´</div><div class="choice-label">Family Help, Constrained</div><div class="choice-brief">Follow their rules</div></label>
                    </div>
                    <div class="consequence-panel" id="q13_returning-consequence"></div>
                </div>

                <div class="question-group" id="q14_returning-group">
                    <label><strong>DECISION 12:</strong> What needs to change?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="power_through"><input type="radio" name="q14_returning" value="power_through" style="display:none;"><div class="choice-icon">ðŸ’ª</div><div class="choice-label">Power Through</div><div class="choice-brief">Temporary phase</div></label>
                        <label class="choice-card" data-value="renegotiate"><input type="radio" name="q14_returning" value="renegotiate" style="display:none;"><div class="choice-icon">ðŸ’¬</div><div class="choice-label">Renegotiate</div><div class="choice-brief">Urgent conversation</div></label>
                        <label class="choice-card" data-value="major_change"><input type="radio" name="q14_returning" value="major_change" style="display:none;"><div class="choice-icon">ðŸ”„</div><div class="choice-label">Major Change</div><div class="choice-brief">Someone quits or hire help</div></label>
                    </div>
                    <div class="consequence-panel" id="q14_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER -->
            <div id="module6_midcareer" class="branch-content" style="display:none;">
                <p><strong>You're 48.</strong> Teenagers/young adults. Different challenges: autonomy, college, launching.</p>

                <div class="question-group" id="q13_midcareer-group">
                    <label><strong>DECISION 11:</strong> Parenting Approach?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="heavy_involvement"><input type="radio" name="q13_midcareer" value="heavy_involvement" style="display:none;"><div class="choice-icon">ðŸŽ¯</div><div class="choice-label">Heavy Involvement</div><div class="choice-brief">Active monitoring, support</div></label>
                        <label class="choice-card" data-value="promote_autonomy"><input type="radio" name="q13_midcareer" value="promote_autonomy" style="display:none;"><div class="choice-icon">ðŸ¦…</div><div class="choice-label">Promote Autonomy</div><div class="choice-brief">Let them struggle/learn</div></label>
                        <label class="choice-card" data-value="financial_boundaries"><input type="radio" name="q13_midcareer" value="financial_boundaries" style="display:none;"><div class="choice-icon">ðŸ’°</div><div class="choice-label">Financial Boundaries</div><div class="choice-brief">Limited support</div></label>
                    </div>
                    <div class="consequence-panel" id="q13_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q14_midcareer-group">
                    <label><strong>DECISION 12:</strong> Launch Support?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="fund_launch"><input type="radio" name="q14_midcareer" value="fund_launch" style="display:none;"><div class="choice-icon">ðŸŽ“</div><div class="choice-label">Fund Full Launch</div><div class="choice-brief">Pay college, apartment</div></label>
                        <label class="choice-card" data-value="accept_boomerang"><input type="radio" name="q14_midcareer" value="accept_boomerang" style="display:none;"><div class="choice-icon">ðŸ </div><div class="choice-label">Accept Boomerang</div><div class="choice-brief">Adult child lives home</div></label>
                        <label class="choice-card" data-value="tough_love"><input type="radio" name="q14_midcareer" value="tough_love" style="display:none;"><div class="choice-icon">âœŠ</div><div class="choice-label">Tough Love</div><div class="choice-brief">Sink or swim</div></label>
                    </div>
                    <div class="consequence-panel" id="q14_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE -->
            <div id="module6_laterlife" class="branch-content" style="display:none;">
                <p><strong>You're 64.</strong> Adult children, possibly grandchildren. Generativityâ€”focus on next generation.</p>

                <div class="question-group" id="q13_laterlife-group">
                    <label><strong>DECISION 11:</strong> Grandparenting Role?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="active_grandparent"><input type="radio" name="q13_laterlife" value="active_grandparent" style="display:none;"><div class="choice-icon">ðŸ‘¶</div><div class="choice-label">Active Grandparenting</div><div class="choice-brief">Regular childcare</div></label>
                        <label class="choice-card" data-value="occasional"><input type="radio" name="q13_laterlife" value="occasional" style="display:none;"><div class="choice-icon">ðŸŽ</div><div class="choice-label">Occasional Visits</div><div class="choice-brief">Enjoy but independent</div></label>
                        <label class="choice-card" data-value="distant"><input type="radio" name="q13_laterlife" value="distant" style="display:none;"><div class="choice-icon">âœˆï¸</div><div class="choice-label">Distant/Minimal</div><div class="choice-brief">Geographic or strained</div></label>
                    </div>
                    <div class="consequence-panel" id="q13_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q14_laterlife-group">
                    <label><strong>DECISION 12:</strong> Adult Child Support?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="ongoing_financial"><input type="radio" name="q14_laterlife" value="ongoing_financial" style="display:none;"><div class="choice-icon">ðŸ’µ</div><div class="choice-label">Ongoing Financial</div><div class="choice-brief">Help with housing, emergencies</div></label>
                        <label class="choice-card" data-value="emotional_only"><input type="radio" name="q14_laterlife" value="emotional_only" style="display:none;"><div class="choice-icon">â¤ï¸</div><div class="choice-label">Emotional Only</div><div class="choice-brief">Protect retirement</div></label>
                        <label class="choice-card" data-value="prioritize_self"><input type="radio" name="q14_laterlife" value="prioritize_self" style="display:none;"><div class="choice-icon">ðŸ§˜</div><div class="choice-label">Prioritize Self</div><div class="choice-brief">Focus on retirement/health</div></label>
                    </div>
                    <div class="consequence-panel" id="q14_laterlife-consequence"></div>
                </div>
            </div>

            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ SYSTEMS THINKING:</strong> Work-family conflict is structural (policy gaps) not individual failure.
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE NOW!</strong>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule6()">Complete Module 6 â†’</button>
            </div>
            </div> <!-- End module6-decisions-container -->
        </div>

        <!-- MODULE 7: FAMILY CHALLENGES & TRANSITIONS -->
        <div id="module7" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module7-section-progress" class="section-progress-container"></div>

            <!-- Advantage Display -->
            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <div id="advantage-m7" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content -->
            <div id="module7-section-content" class="section-content-area"></div>

            <!-- Previous Module Summary -->
            <div id="module7-intro-summary"></div>

            <!-- EXISTING DECISION CONTENT -->
            <div id="module7-decisions-container">
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 15-20 minutes |
                    <strong>ðŸ“š Connect to:</strong> Hammond Chapter 12-13 (ABC-X Model)
                </div>

            <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                <strong>ðŸŽ¯ Life Course:</strong> Crisis types vary by ageâ€”job loss at 35, teen crisis at 50, health crisis at 65.
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ SAVE!</strong> Export for Canvas Module 7 assignment.
            </div>

            <!-- BRANCH 1: TRADITIONAL -->
            <div id="module7_traditional" class="branch-content" style="display:none;">
                <p><strong>You're 35.</strong> Crisis hits. Your accumulated resources determine resilience.</p>

                <div class="question-group" id="q15_traditional-group">
                    <label><strong>DECISION 13:</strong> Crisis Type?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="job_loss"><input type="radio" name="q15_traditional" value="job_loss" style="display:none;"><div class="choice-icon">ðŸ’¼</div><div class="choice-label">Job Loss</div><div class="choice-brief">Laid off, no income</div></label>
                        <label class="choice-card" data-value="health_emergency"><input type="radio" name="q15_traditional" value="health_emergency" style="display:none;"><div class="choice-icon">ðŸ¥</div><div class="choice-label">Health Emergency</div><div class="choice-brief">Serious diagnosis</div></label>
                        <label class="choice-card" data-value="relationship_crisis"><input type="radio" name="q15_traditional" value="relationship_crisis" style="display:none;"><div class="choice-icon">ðŸ’”</div><div class="choice-label">Relationship Crisis</div><div class="choice-brief">Partnership breakdown</div></label>
                    </div>
                    <div class="consequence-panel" id="q15_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q16_traditional-group">
                    <label><strong>DECISION 14:</strong> Response Strategy?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="rely_savings"><input type="radio" name="q16_traditional" value="rely_savings" style="display:none;"><div class="choice-icon">ðŸ’°</div><div class="choice-label">Use Savings</div><div class="choice-brief">Weather with resources</div></label>
                        <label class="choice-card" data-value="family_support"><input type="radio" name="q16_traditional" value="family_support" style="display:none;"><div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div><div class="choice-label">Turn to Family</div><div class="choice-brief">Family provides support</div></label>
                        <label class="choice-card" data-value="struggle_debt"><input type="radio" name="q16_traditional" value="struggle_debt" style="display:none;"><div class="choice-icon">ðŸ’³</div><div class="choice-label">Struggle, Debt</div><div class="choice-brief">No buffer, devastation</div></label>
                    </div>
                    <div class="consequence-panel" id="q16_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING -->
            <div id="module7_returning" class="branch-content" style="display:none;">
                <p><strong>You're 40.</strong> Crisis during peak demandsâ€”young kids, career, limited slack.</p>

                <div class="question-group" id="q15_returning-group">
                    <label><strong>DECISION 13:</strong> Crisis Type?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="childcare_collapse"><input type="radio" name="q15_returning" value="childcare_collapse" style="display:none;"><div class="choice-icon">ðŸ‘¶</div><div class="choice-label">Childcare Collapse</div><div class="choice-brief">No backup plan</div></label>
                        <label class="choice-card" data-value="partner_job_loss"><input type="radio" name="q15_returning" value="partner_job_loss" style="display:none;"><div class="choice-icon">ðŸ’¼</div><div class="choice-label">Partner Job Loss</div><div class="choice-brief">Single income now</div></label>
                        <label class="choice-card" data-value="parent_health"><input type="radio" name="q15_returning" value="parent_health" style="display:none;"><div class="choice-icon">ðŸ‘´</div><div class="choice-label">Parent Health Crisis</div><div class="choice-brief">Sandwich generation</div></label>
                    </div>
                    <div class="consequence-panel" id="q15_returning-consequence"></div>
                </div>

                <div class="question-group" id="q16_returning-group">
                    <label><strong>DECISION 14:</strong> How cope?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="one_quits_emergency"><input type="radio" name="q16_returning" value="one_quits_emergency" style="display:none;"><div class="choice-icon">ðŸšª</div><div class="choice-label">Emergency Career Exit</div><div class="choice-brief">Someone quits</div></label>
                        <label class="choice-card" data-value="cobble_together"><input type="radio" name="q16_returning" value="cobble_together" style="display:none;"><div class="choice-icon">ðŸ§©</div><div class="choice-label">Cobble Together</div><div class="choice-brief">Patchwork, exhaustion</div></label>
                        <label class="choice-card" data-value="system_breaks"><input type="radio" name="q16_returning" value="system_breaks" style="display:none;"><div class="choice-icon">ðŸ’¥</div><div class="choice-label">System Breaks</div><div class="choice-brief">Something gives</div></label>
                    </div>
                    <div class="consequence-panel" id="q16_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER -->
            <div id="module7_midcareer" class="branch-content" style="display:none;">
                <p><strong>You're 50.</strong> Sandwich generation peakâ€”aging parents, teens, career vulnerability.</p>

                <div class="question-group" id="q15_midcareer-group">
                    <label><strong>DECISION 13:</strong> Crisis Type?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="parent_care_crisis"><input type="radio" name="q15_midcareer" value="parent_care_crisis" style="display:none;"><div class="choice-icon">ðŸ‘µ</div><div class="choice-label">Parent Care Crisis</div><div class="choice-brief">Can't live alone</div></label>
                        <label class="choice-card" data-value="teen_crisis"><input type="radio" name="q15_midcareer" value="teen_crisis" style="display:none;"><div class="choice-icon">ðŸš¨</div><div class="choice-label">Teen Crisis</div><div class="choice-brief">Mental health, legal</div></label>
                        <label class="choice-card" data-value="job_loss_50plus"><input type="radio" name="q15_midcareer" value="job_loss_50plus" style="display:none;"><div class="choice-icon">ðŸ“‰</div><div class="choice-label">Job Loss 50+</div><div class="choice-brief">Age discrimination</div></label>
                    </div>
                    <div class="consequence-panel" id="q15_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q16_midcareer-group">
                    <label><strong>DECISION 14:</strong> Coping Strategy?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="resources_hold"><input type="radio" name="q16_midcareer" value="resources_hold" style="display:none;"><div class="choice-icon">ðŸ›¡ï¸</div><div class="choice-label">Resources Hold</div><div class="choice-brief">Weather the storm</div></label>
                        <label class="choice-card" data-value="partnership_strain"><input type="radio" name="q16_midcareer" value="partnership_strain" style="display:none;"><div class="choice-icon">âš ï¸</div><div class="choice-label">Partnership Strain</div><div class="choice-brief">Fight or unite?</div></label>
                        <label class="choice-card" data-value="collapse_cascade"><input type="radio" name="q16_midcareer" value="collapse_cascade" style="display:none;"><div class="choice-icon">ðŸŒŠ</div><div class="choice-label">Cascade Collapse</div><div class="choice-brief">Everything fails</div></label>
                    </div>
                    <div class="consequence-panel" id="q16_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE -->
            <div id="module7_laterlife" class="branch-content" style="display:none;">
                <p><strong>You're 66.</strong> Late-life crisesâ€”health, widowhood, adult child problems.</p>

                <div class="question-group" id="q15_laterlife-group">
                    <label><strong>DECISION 13:</strong> Crisis Type?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="spouse_health"><input type="radio" name="q15_laterlife" value="spouse_health" style="display:none;"><div class="choice-icon">ðŸ¥</div><div class="choice-label">Spouse Health Crisis</div><div class="choice-brief">Become caregiver</div></label>
                        <label class="choice-card" data-value="adult_child_crisis"><input type="radio" name="q15_laterlife" value="adult_child_crisis" style="display:none;"><div class="choice-icon">ðŸ†˜</div><div class="choice-label">Adult Child Crisis</div><div class="choice-brief">Bail them out?</div></label>
                        <label class="choice-card" data-value="own_health_decline"><input type="radio" name="q15_laterlife" value="own_health_decline" style="display:none;"><div class="choice-icon">ðŸ©º</div><div class="choice-label">Own Health Decline</div><div class="choice-brief">Need assistance</div></label>
                    </div>
                    <div class="consequence-panel" id="q15_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q16_laterlife-group">
                    <label><strong>DECISION 14:</strong> How navigate?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="strong_network"><input type="radio" name="q16_laterlife" value="strong_network" style="display:none;"><div class="choice-icon">ðŸ¤</div><div class="choice-label">Strong Network</div><div class="choice-brief">Support provides resilience</div></label>
                        <label class="choice-card" data-value="isolated_struggle"><input type="radio" name="q16_laterlife" value="isolated_struggle" style="display:none;"><div class="choice-icon">ðŸï¸</div><div class="choice-label">Isolated Struggle</div><div class="choice-brief">Managing alone</div></label>
                        <label class="choice-card" data-value="adapt_reframe"><input type="radio" name="q16_laterlife" value="adapt_reframe" style="display:none;"><div class="choice-icon">ðŸ§˜</div><div class="choice-label">Adapt & Reframe</div><div class="choice-brief">Resilience through acceptance</div></label>
                    </div>
                    <div class="consequence-panel" id="q16_laterlife-consequence"></div>
                </div>
            </div>

            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ ABC-X MODEL:</strong> A (stressor) + B (resources from Modules 1-6) + C (meaning) = X (crisis level)
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule7()">Complete Module 7 â†’</button>
            </div>
            </div> <!-- End module7-decisions-container -->
        </div>

        <!-- MODULE 8: SYSTEMS REFLECTION & ANALYSIS -->
        <div id="module8" class="content game-section">
            <!-- Section Progress Bar -->
            <div id="module8-section-progress" class="section-progress-container"></div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--navy); margin: 0;">Module 8: Systems Thinking & Reflection</h2>
                <div id="advantage-m8" class="advantage-display"></div>
            </div>

            <!-- Dynamic Section Content -->
            <div id="module8-section-content" class="section-content-area"></div>

            <!-- Decisions Container - shown/hidden by section controller -->
            <div id="module8-decisions-container" class="decisions-container" style="display: none;">
                <div id="module8-intro-summary"></div>

                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> 20 minutes |
                    <strong>ðŸ“š Connect to:</strong> All Hammond Chaptersâ€”Systems Integration
                </div>

                <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107; color: #856404; margin-bottom: 25px;">
                    <strong>ðŸŽ¯ Life Course Integration:</strong> Trace how decisions cascaded from Module 1 through Module 7.
                </div>

                <!-- INSTRUCTOR DASHBOARD (visible to instructors or as demo) -->
            <details style="margin-bottom: 24px;">
                <summary style="cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 600;">
                    ðŸ“Š View Class Aggregate Data (Instructor View)
                </summary>
                <div id="instructor-dashboard-container" style="margin-top: 16px;">
                    <!-- Populated by JavaScript -->
                </div>
            </details>
            <script>
                // Render instructor dashboard when details is opened
                document.querySelector('#instructor-dashboard-container')?.closest('details')?.addEventListener('toggle', function(e) {
                    if (this.open && typeof InstructorDashboard !== 'undefined') {
                        InstructorDashboard.render('instructor-dashboard-container');
                    }
                });
            </script>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ FINAL SAVE!</strong> Export complete game data for Canvas final reflection.
            </div>

            <!-- PROFILE SUMMARY - Shows player's journey across modules -->
            <div id="profileSummary" class="profile-summary" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 20px 0; border: 2px solid #e1e8ed;">
                <h3 style="color: var(--navy); margin-bottom: 15px;">ðŸ“‹ Your Life Course Journey</h3>
                <!-- Populated by buildProfileSummary() -->
            </div>

            <!-- BRANCH 1: TRADITIONAL -->
            <div id="module8_traditional" class="branch-content" style="display:none;">
                <p><strong>You're 35.</strong> Reflect on 15 years of cascading decisions from 20-35.</p>

                <div class="question-group" id="q17_traditional-group">
                    <label><strong>REFLECTION 1:</strong> Path Dependenciesâ€”Which early decision most shaped your trajectory?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="mod1_family"><input type="radio" name="q17_traditional" value="mod1_family" style="display:none;"><div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§</div><div class="choice-label">Module 1 Family</div><div class="choice-brief">Class, resources, values</div></label>
                        <label class="choice-card" data-value="mod2_education"><input type="radio" name="q17_traditional" value="mod2_education" style="display:none;"><div class="choice-icon">ðŸŽ“</div><div class="choice-label">Module 2 Education</div><div class="choice-brief">College vs no-college</div></label>
                        <label class="choice-card" data-value="mod4_partner"><input type="radio" name="q17_traditional" value="mod4_partner" style="display:none;"><div class="choice-icon">ðŸ’‘</div><div class="choice-label">Module 4 Partner</div><div class="choice-brief">Who you chose</div></label>
                    </div>
                    <div class="consequence-panel" id="q17_traditional-consequence"></div>
                </div>

                <div class="question-group" id="q18_traditional-group">
                    <label><strong>REFLECTION 2:</strong> What would you change if replaying?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="nothing"><input type="radio" name="q18_traditional" value="nothing" style="display:none;"><div class="choice-icon">âœ…</div><div class="choice-label">Nothing</div><div class="choice-brief">Path makes sense</div></label>
                        <label class="choice-card" data-value="career_different"><input type="radio" name="q18_traditional" value="career_different" style="display:none;"><div class="choice-icon">ðŸ’¼</div><div class="choice-label">Different Career</div><div class="choice-brief">Education choice</div></label>
                        <label class="choice-card" data-value="relationship_timing"><input type="radio" name="q18_traditional" value="relationship_timing" style="display:none;"><div class="choice-icon">â°</div><div class="choice-label">Relationship Timing</div><div class="choice-brief">Too early/late</div></label>
                    </div>
                    <div class="consequence-panel" id="q18_traditional-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 2: RETURNING -->
            <div id="module8_returning" class="branch-content" style="display:none;">
                <p><strong>You're 40.</strong> Reflect on managing transitions and accumulated decisions.</p>

                <div class="question-group" id="q17_returning-group">
                    <label><strong>REFLECTION 1:</strong> Key Insight?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="systems_not_individual"><input type="radio" name="q17_returning" value="systems_not_individual" style="display:none;"><div class="choice-icon">ðŸ›ï¸</div><div class="choice-label">Systems, Not Individual</div><div class="choice-brief">Structural policy failure</div></label>
                        <label class="choice-card" data-value="cumulative_advantage"><input type="radio" name="q17_returning" value="cumulative_advantage" style="display:none;"><div class="choice-icon">ðŸ“ˆ</div><div class="choice-label">Cumulative Advantage</div><div class="choice-brief">Early resources compound</div></label>
                        <label class="choice-card" data-value="gender_inequality"><input type="radio" name="q17_returning" value="gender_inequality" style="display:none;"><div class="choice-icon">âš–ï¸</div><div class="choice-label">Gender Inequality</div><div class="choice-brief">Structural barriers</div></label>
                    </div>
                    <div class="consequence-panel" id="q17_returning-consequence"></div>
                </div>

                <div class="question-group" id="q18_returning-group">
                    <label><strong>REFLECTION 2:</strong> Moving forward?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="renegotiate_partnership"><input type="radio" name="q18_returning" value="renegotiate_partnership" style="display:none;"><div class="choice-icon">ðŸ’¬</div><div class="choice-label">Renegotiate Partnership</div><div class="choice-brief">Need changes</div></label>
                        <label class="choice-card" data-value="career_pivot"><input type="radio" name="q18_returning" value="career_pivot" style="display:none;"><div class="choice-icon">ðŸ”„</div><div class="choice-label">Career Pivot</div><div class="choice-brief">Work-family balance</div></label>
                        <label class="choice-card" data-value="accept_trade_offs"><input type="radio" name="q18_returning" value="accept_trade_offs" style="display:none;"><div class="choice-icon">ðŸ¤</div><div class="choice-label">Accept Trade-offs</div><div class="choice-brief">Make peace with path</div></label>
                    </div>
                    <div class="consequence-panel" id="q18_returning-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 3: MID-CAREER -->
            <div id="module8_midcareer" class="branch-content" style="display:none;">
                <p><strong>You're 50.</strong> Reflect on decades of decisions, prepare for next chapter.</p>

                <div class="question-group" id="q17_midcareer-group">
                    <label><strong>REFLECTION 1:</strong> Life Course Analysis?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="satisfied_trajectory"><input type="radio" name="q17_midcareer" value="satisfied_trajectory" style="display:none;"><div class="choice-icon">ðŸ˜Š</div><div class="choice-label">Satisfied</div><div class="choice-brief">Choices made sense</div></label>
                        <label class="choice-card" data-value="regrets_constraints"><input type="radio" name="q17_midcareer" value="regrets_constraints" style="display:none;"><div class="choice-icon">ðŸš§</div><div class="choice-label">Regrets About Constraints</div><div class="choice-brief">Structural barriers</div></label>
                        <label class="choice-card" data-value="would_redo_major"><input type="radio" name="q17_midcareer" value="would_redo_major" style="display:none;"><div class="choice-icon">ðŸ”™</div><div class="choice-label">Would Redo</div><div class="choice-brief">Major decisions</div></label>
                    </div>
                    <div class="consequence-panel" id="q17_midcareer-consequence"></div>
                </div>

                <div class="question-group" id="q18_midcareer-group">
                    <label><strong>REFLECTION 2:</strong> Next Life Stage Focus?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="empty_nest_reinvest"><input type="radio" name="q18_midcareer" value="empty_nest_reinvest" style="display:none;"><div class="choice-icon">ðŸ”¥</div><div class="choice-label">Empty Nest Reinvest</div><div class="choice-brief">Partner, hobbies, travel</div></label>
                        <label class="choice-card" data-value="career_final_push"><input type="radio" name="q18_midcareer" value="career_final_push" style="display:none;"><div class="choice-icon">ðŸ’¼</div><div class="choice-label">Career Final Push</div><div class="choice-brief">Maximize earnings</div></label>
                        <label class="choice-card" data-value="generativity_focus"><input type="radio" name="q18_midcareer" value="generativity_focus" style="display:none;"><div class="choice-icon">ðŸŒ±</div><div class="choice-label">Generativity Focus</div><div class="choice-brief">Mentoring, legacy</div></label>
                    </div>
                    <div class="consequence-panel" id="q18_midcareer-consequence"></div>
                </div>
            </div>

            <!-- BRANCH 4: LATER-LIFE -->
            <div id="module8_laterlife" class="branch-content" style="display:none;">
                <p><strong>You're 66.</strong> Reflect on full life course, legacy, meaning-making.</p>

                <div class="question-group" id="q17_laterlife-group">
                    <label><strong>REFLECTION 1:</strong> Life Narrative?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="fulfilling_journey"><input type="radio" name="q17_laterlife" value="fulfilling_journey" style="display:none;"><div class="choice-icon">âœ¨</div><div class="choice-label">Fulfilling Journey</div><div class="choice-brief">Meaning, relationships</div></label>
                        <label class="choice-card" data-value="mixed_accepting"><input type="radio" name="q17_laterlife" value="mixed_accepting" style="display:none;"><div class="choice-icon">â˜¯ï¸</div><div class="choice-label">Mixed But Accepting</div><div class="choice-brief">Peace with both</div></label>
                        <label class="choice-card" data-value="regrets_structural"><input type="radio" name="q17_laterlife" value="regrets_structural" style="display:none;"><div class="choice-icon">ðŸ”</div><div class="choice-label">Structural Awareness</div><div class="choice-brief">Class, gender, policy</div></label>
                    </div>
                    <div class="consequence-panel" id="q17_laterlife-consequence"></div>
                </div>

                <div class="question-group" id="q18_laterlife-group">
                    <label><strong>REFLECTION 2:</strong> Legacy Focus?</label>
                    <div class="choice-cards-container">
                        <label class="choice-card" data-value="family_legacy"><input type="radio" name="q18_laterlife" value="family_legacy" style="display:none;"><div class="choice-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div><div class="choice-label">Family Legacy</div><div class="choice-brief">Children, grandchildren</div></label>
                        <label class="choice-card" data-value="community_contribution"><input type="radio" name="q18_laterlife" value="community_contribution" style="display:none;"><div class="choice-icon">ðŸ¤</div><div class="choice-label">Community Contribution</div><div class="choice-brief">Volunteer, mentor</div></label>
                        <label class="choice-card" data-value="personal_contentment"><input type="radio" name="q18_laterlife" value="personal_contentment" style="display:none;"><div class="choice-icon">ðŸ§˜</div><div class="choice-label">Personal Contentment</div><div class="choice-brief">Focus on wellbeing</div></label>
                    </div>
                    <div class="consequence-panel" id="q18_laterlife-consequence"></div>
                </div>
            </div>

            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ SYSTEMS THINKING COMPLETE:</strong> You've experienced how individual biography intersects with historical time, social structure, and life course timing. Module 1 family background created foundation â†’ Module 2 education opened/closed doors â†’ Module 3-5 relationships shaped daily life â†’ Module 6 work-family revealed structural inequality â†’ Module 7 crisis tested accumulated resources.
            </div>

            <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0;">
                <strong>ðŸ’¾ EXPORT YOUR COMPLETE GAME DATA NOW!</strong> Required for Canvas final reflection assignment.
            </div>

            <!-- DECISION 15: Policy Stance & Political Consciousness -->
            <div class="question-group" id="q15-group">
                <label><strong>DECISION 15:</strong> What is your stance on family policy after this journey?</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    Having navigated work-family conflict and crises with minimal U.S. policy supports, what changes do you advocate?
                </p>
                <div class="choice-cards-container">
                    <label class="choice-card" data-value="comprehensive_social_democracy">
                        <input type="radio" name="q15" value="comprehensive_social_democracy" style="display:none;" required>
                        <div class="choice-icon">ðŸ›ï¸</div>
                        <div class="choice-label">Social Democratic</div>
                        <div class="choice-brief">Universal family supports</div>
                    </label>
                    <label class="choice-card" data-value="targeted_supports">
                        <input type="radio" name="q15" value="targeted_supports" style="display:none;">
                        <div class="choice-icon">ðŸŽ¯</div>
                        <div class="choice-label">Targeted Supports</div>
                        <div class="choice-brief">Help low-income families</div>
                    </label>
                    <label class="choice-card" data-value="market_solutions_minimal_government">
                        <input type="radio" name="q15" value="market_solutions_minimal_government" style="display:none;">
                        <div class="choice-icon">ðŸ“ˆ</div>
                        <div class="choice-label">Market Solutions</div>
                        <div class="choice-brief">Personal responsibility</div>
                    </label>
                    <label class="choice-card" data-value="marriage_promotion_traditional_values">
                        <input type="radio" name="q15" value="marriage_promotion_traditional_values" style="display:none;">
                        <div class="choice-icon">ðŸ’’</div>
                        <div class="choice-label">Marriage Promotion</div>
                        <div class="choice-brief">Traditional family values</div>
                    </label>
                </div>
                <div class="consequence-panel" id="q15-consequence"></div>
            </div>

            <!-- DECISION 16: Systems Reflection (Open-Ended Synthesis) -->
            <div class="question-group">
                <label><strong>REFLECTION 16:</strong> Sociological Imagination - Connect Your Biography to Social Structure</label>
                <p style="font-size: 0.95em; color: #555; margin: 10px 0 15px 0;">
                    <span class="glossary-term" data-term="systems-thinking">Systems thinking<span class="glossary-tooltip"><strong>Systems Thinking</strong><br>Analyzing how multiple factors (education, economy, policy, culture, timing) interconnect and affect each other rather than viewing issues in isolation.<br><em>Course synthesis</em></span></span> means tracing how your Module 1-7 decisions cascaded. C. Wright Mills called this the "sociological imagination"â€”understanding how biography (your life) intersects with history (time period) and social structure (economy, policy, inequality). Write your synthesis below:
                </p>
                <textarea id="q16_systems_reflection" rows="10" style="width: 100%; padding: 15px; font-size: 1em; border: 2px solid #ddd; border-radius: 8px;" placeholder="Synthesize your journey:

â€¢ How did Module 1 (family background) affect later modules?
â€¢ Which structural factors constrained your 'choices' most (economic? gender? policy gaps?)?
â€¢ Where did you see privilege or disadvantage accumulate across modules?
â€¢ What surprised you about how decisions cascaded?
â€¢ How would different U.S. policies have changed your journey?
â€¢ Did playing this game change how you understand 'family' as a social institution?

Use specific examples from your gameplay. Reference Hammond concepts: homogamy, marriage bar, second shift, ABC-X model, divorce gap, intensive mothering, work-family conflict, deinstitutionalization, etc.

Aim for 300-500 words demonstrating sociological analysis, not just personal opinion."></textarea>
            </div>

            <!-- Final Connection Box -->
            <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 25px 0;">
                <strong>ðŸ’¡ COURSE SYNTHESIS: What Did You Learn?</strong><br><br>
                This game demonstrated <span class="glossary-term" data-term="systems-thinking">systems thinking<span class="glossary-tooltip"><strong>Systems Thinking</strong><br>Analyzing how multiple factors (education, economy, policy, culture, timing) interconnect and affect each other rather than viewing issues in isolation.<br><em>Course synthesis</em></span></span>: decisions cascade across life domains and time. Your Module 1 family background â†’ Module 2 education access â†’ Module 2 career income â†’ Module 4 marriage market â†’ Module 5 clearing marriage bar â†’ Module 6 work-family options â†’ Module 7 crisis resilience. Early advantages/disadvantages compound.<br><br>
                <strong>Key takeaway:</strong> "Personal choices" happen within structural constraints. Same decisions (work hard, get married, have kids) produce different outcomes based on class position, gender, race, policy context. This is sociologyâ€”revealing how biography connects to social structure.<br><br>
                <em>Hammond Ch. 15 shows U.S. as outlier among wealthy nationsâ€”no paid leave, no universal childcare, no healthcare, weak safety net. Cross-national comparisons reveal policy choices matter. Family outcomes aren't "natural" but politically constructed.</em>
            </div>

            <div class="alert alert-success">
                <strong>ðŸŽ‰ You've completed all 8 modules!</strong><br>
                Click below to generate your comprehensive game report. You'll need this for your Canvas assignments!
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="btn btn-primary" onclick="completeModule8()">Generate Final Report â†’</button>
            </div>
            </div> <!-- End decisions-container -->
        </div>

        <div class="footer">
            <p><strong>Life Planning Challenge</strong> | Part of SOC-213: Sociology of the Family</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Built for FTCC | Free & Open Educational Resource</p>
            <p style="margin-top: 10px; font-size: 0.85em;">Your data stays in your browser. We don't collect anything.</p>
        </div>
    </div>

    <script>
        // Game state management
        let gameState = {
            currentModule: 0,
            modulesCompleted: [],
            characterData: {},
            startedAt: null,
            lastUpdated: null
        };

        // Load saved state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('lifePlanningGame');
            if (saved) {
                gameState = JSON.parse(saved);

                // Initialize GameEngine with saved state (handles migration)
                if (typeof GameEngine !== 'undefined') {
                    GameEngine.init({
                        exerciseResponses: gameState.exerciseResponses || {},
                        sectionProgress: gameState.sectionProgress || {},
                        comprehensionResults: gameState.comprehensionResults || {},
                        journal: gameState.journal || [],
                        mappingData: gameState.mappingData || {},
                        scenarioPaths: gameState.scenarioPaths || {},
                        narrativeFlags: gameState.narrativeFlags || [],
                        advantageScore: gameState.characterData?.advantageScore || 0
                    });
                }
            } else {
                gameState.startedAt = new Date().toISOString();
            }
        }

        // Save state to localStorage
        function saveGameState(showNotification = false) {
            // Sync exercise data from GameEngine to gameState before saving
            if (typeof GameEngine !== 'undefined' && GameEngine.state) {
                gameState.exerciseResponses = GameEngine.state.exerciseResponses || {};
                gameState.sectionProgress = GameEngine.state.sectionProgress || {};
                gameState.comprehensionResults = GameEngine.state.comprehensionResults || {};
                gameState.journal = GameEngine.state.journal || [];
                gameState.mappingData = GameEngine.state.mappingData || {};
                gameState.scenarioPaths = GameEngine.state.scenarioPaths || {};
                gameState.narrativeFlags = GameEngine.state.narrativeFlags || [];
                gameState.advantageScore = GameEngine.state.advantageScore || 0;
            }

            gameState.lastUpdated = new Date().toISOString();
            localStorage.setItem('lifePlanningGame', JSON.stringify(gameState));

            // Show save notification on important saves (module completions)
            if (showNotification && typeof showSaveNotification === 'function') {
                showSaveNotification();
            }
        }

        // Initialize game
        function initGame() {
            loadGameState();

            if (gameState.modulesCompleted.length > 0) {
                showModuleHub();
            }
        }

        // Show specific section
        function showSection(sectionId) {
            document.querySelectorAll('.game-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            window.scrollTo(0, 0);

            // Initialize modules that need setup
            if (sectionId === 'module1') initModule1();
            if (sectionId === 'module2') initModule2();
            if (sectionId === 'module3') initModule3();
            if (sectionId === 'module4') initModule4();
            if (sectionId === 'module5') initModule5();
            if (sectionId === 'module6') initModule6();
            if (sectionId === 'module7') initModule7();
            if (sectionId === 'module8') initModule8();

            // Update journey progress visualization
            const moduleMatch = sectionId.match(/module(\d+)/);
            if (moduleMatch) {
                const moduleNum = parseInt(moduleMatch[1]);
                if (typeof onModuleChange === 'function') {
                    onModuleChange(moduleNum);
                }
            }
        }

        // Start game
        function startGame() {
            showSection('module1');
            // initModule1 is called by showSection
        }

        // Show module hub
        function showModuleHub() {
            populateModuleHub();
            showSection('moduleHub');

            // Update last saved timestamp
            if (typeof updateLastSavedDisplay === 'function') {
                updateLastSavedDisplay();
            }
        }

        // Populate module hub
        function populateModuleHub() {
            const modules = [
                { num: 1, title: "Character Creation", icon: "ðŸ‘¤" },
                { num: 2, title: "Education & Career", icon: "ðŸŽ“" },
                { num: 3, title: "Love & Communication", icon: "ðŸ’¬" },
                { num: 4, title: "Mate Selection", icon: "ðŸ’‘" },
                { num: 5, title: "Marriage & Partnership", icon: "ðŸ’" },
                { num: 6, title: "Parenthood & Balance", icon: "ðŸ‘¶" },
                { num: 7, title: "Family Challenges", icon: "âš¡" },
                { num: 8, title: "Systems Reflection", icon: "ðŸ”„" }
            ];

            const grid = document.getElementById('moduleGrid');
            grid.innerHTML = '';

            modules.forEach(module => {
                const completed = gameState.modulesCompleted.includes(module.num);
                const current = gameState.currentModule === module.num;
                // Module is available if: completed OR it's the next sequential module
                const available = completed || module.num === 1 || gameState.modulesCompleted.includes(module.num - 1);

                const card = document.createElement('div');
                card.className = `module-card ${completed ? 'completed' : ''} ${current ? 'current' : ''}`;
                if (!available) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                }

                card.innerHTML = `
                    <div class="module-number">${module.num}</div>
                    <div class="module-title">${module.icon} ${module.title}</div>
                    <div class="module-status">
                        ${completed ? 'âœ… Completed' : available ? 'â–¶ï¸ Available' : 'ðŸ”’ Locked'}
                    </div>
                `;

                if (available) {
                    card.onclick = () => showSection(`module${module.num}`);
                }

                grid.appendChild(card);
            });

            // Update progress
            const completedCount = gameState.modulesCompleted.length;
            document.getElementById('progressText').textContent = `${completedCount}/8 modules completed`;
            document.getElementById('overallProgress').style.width = `${(completedCount / 8) * 100}%`;
        }

        // Complete Module 1
        // Handle life stage selection and update intro dynamically
        function updateLifeStageIntro() {
            const lifeStage = document.querySelector('input[name="q0_lifestage"]:checked')?.value || 'traditional';
            const introDiv = document.getElementById('ageSpecificIntro');

            const intros = {
                traditional: '<p style="color: var(--text-dark); margin-bottom: 25px;"><strong>Your Journey:</strong> You\'re at the starting line of adulthood. Your family background has shaped your values, resources, and worldview. The decisions you make now about education, career, and relationships will set the trajectory for your next decade. <em>Sociological Concept: Life Course Perspective - Early decisions create path dependencies that constrain/enable later choices.</em></p>',
                returning: '<p style="color: var(--text-dark); margin-bottom: 25px;"><strong>Your Journey:</strong> You\'re managing established commitments while navigating change. You may have a career you\'re reconsidering, a partner, children, or financial obligations. Your family background still influences how you approach these transitions. <em>Sociological Concept: Role Strain - Balancing multiple simultaneous demands (worker, partner, parent, student) creates unique pressures.</em></p>',
                midcareer: '<p style="color: var(--text-dark); margin-bottom: 25px;"><strong>Your Journey:</strong> You\'re in the peak demand yearsâ€”career established, children needing support, aging parents requiring care. Your early family experiences shaped how you navigate these simultaneous caregiving demands. <em>Sociological Concept: Sandwich Generation - Caring for both children and aging parents while maintaining career creates time poverty and economic stress.</em></p>',
                laterlife: '<p style="color: var(--text-dark); margin-bottom: 25px;"><strong>Your Journey:</strong> You\'re navigating late-life transitionsâ€”adult children, possible grandchildren, aging parents or their loss, career shifts. Your family of origin continues to influence how you approach legacy, caregiving, and relationships. <em>Sociological Concept: Generativity - Late adulthood involves passing on knowledge, managing intergenerational relationships, and legacy work.</em></p>'
            };

            introDiv.innerHTML = intros[lifeStage];

            // Update reflection question age - call the calculation function
            updateReflectionAge();
        }

        function updateReflectionAge() {
            // Get current age from input field
            const currentAgeInput = document.getElementById('currentAge');
            const currentAge = parseInt(currentAgeInput?.value) || null;

            // Update all dynamic age displays throughout the game
            if (currentAge && currentAge >= 18) {
                document.querySelectorAll('.dynamic-age').forEach(el => {
                    el.textContent = currentAge;
                });
            }

            // Calculate future age for reflection
            let reflectionAge;

            if (currentAge && currentAge >= 18) {
                // Use actual age + 10-15 years based on life stage
                const lifeStage = document.querySelector('input[name="q0_lifestage"]:checked')?.value || 'traditional';

                if (currentAge < 30) {
                    // Younger: look ahead 10-15 years
                    reflectionAge = currentAge + 12;
                } else if (currentAge < 45) {
                    // Mid-range: look ahead 10 years
                    reflectionAge = currentAge + 10;
                } else if (currentAge < 60) {
                    // Mid-career: look ahead 10 years
                    reflectionAge = currentAge + 10;
                } else {
                    // Later life: look ahead 8-10 years
                    reflectionAge = currentAge + 8;
                }
            } else {
                // Fallback to life stage defaults if no age entered yet
                const lifeStage = document.querySelector('input[name="q0_lifestage"]:checked')?.value || 'traditional';
                const defaultAges = {
                    traditional: 35,
                    returning: 45,
                    midcareer: 55,
                    laterlife: 70
                };
                reflectionAge = defaultAges[lifeStage];
            }

            // Update age in reflection question text
            const reflectionAgeSpan = document.getElementById('reflectionAge');
            const reflectionAge2Span = document.getElementById('reflectionAge2');
            if (reflectionAgeSpan) reflectionAgeSpan.textContent = reflectionAge;
            if (reflectionAge2Span) reflectionAge2Span.textContent = reflectionAge;

            // Update textarea placeholder
            const textarea = document.getElementById('idealLife');
            if (textarea) {
                textarea.placeholder = `Write 2-3 sentences describing your character's imagined family life at age ${reflectionAge}. Consider: Who is in your family? What does daily life look like? What matters most to you?`;
            }
        }

        function completeModule1() {
            // Validate all questions answered
            const q0 = document.querySelector('input[name="q0_lifestage"]:checked');
            const q1 = document.querySelector('input[name="q1"]:checked');
            const q2 = document.querySelector('input[name="q2"]:checked');
            const idealLife = document.getElementById('idealLife').value;
            const currentAge = document.getElementById('currentAge').value;

            if (!q0 || !q1 || !q2 || !idealLife.trim()) {
                alert('Please answer all questions before continuing.');
                return;
            }

            if (!currentAge || parseInt(currentAge) < 18 || parseInt(currentAge) > 99) {
                alert('Please enter your current age (18-99) before continuing.');
                return;
            }

            // Save character data including life stage and current age
            gameState.characterData.lifeStage = q0.value;
            gameState.characterData.currentAge = parseInt(currentAge);
            gameState.characterData.familyValues = q1.value;
            gameState.characterData.coreValue = q2.value;
            gameState.characterData.idealLife = idealLife;

            // Mark module complete
            if (!gameState.modulesCompleted.includes(1)) {
                gameState.modulesCompleted.push(1);
            }
            gameState.currentModule = 2;

            saveGameState(true);

            // Show success and module 2
            alert('âœ… Module 1 Complete!\n\n' +
                  'ðŸ“¥ IMPORTANT: Return to Module Hub and export your data!\n\n' +
                  'Next Steps:\n' +
                  '1. Click OK to continue to Module 2\n' +
                  '2. OR return to Module Hub to export first\n\n' +
                  'You need your exported data for Canvas assignments!');
            showSection('module2');
        }

        // Initialize Module 1 - Character Creation
        function initModule1() {
            // Initialize section controller for enhanced experience
            if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module1) {
                ModuleSectionController.init(1);
            }
        }

        // Initialize Module 2 based on life stage
        function initModule2() {
            const lifeStage = gameState.characterData.lifeStage || 'traditional';

            // Initialize section controller for enhanced experience
            if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module2) {
                ModuleSectionController.init(2);
            }

            // Hide all branches
            document.querySelectorAll('#module2 .branch-content').forEach(div => {
                div.style.display = 'none';
            });

            // Show appropriate branch
            const branchDiv = document.getElementById(`module2_${lifeStage}`);
            if (branchDiv) {
                branchDiv.style.display = 'block';
            }

            // Update dynamic ages to match user's entered age
            if (gameState.characterData?.currentAge) {
                document.querySelectorAll('.dynamic-age').forEach(el => {
                    el.textContent = gameState.characterData.currentAge;
                });
            }

            // Update advantage display
            updateAdvantageDisplay('m2');
        }

        // Update advantage score display for a module
        function updateAdvantageDisplay(moduleKey) {
            const display = document.getElementById(`advantage-${moduleKey}`);
            if (!display || typeof GameEngine === 'undefined') return;

            const score = GameEngine.state.advantageScore;
            let className = 'advantage-indicator neutral';
            let text = `Advantage: ${score}`;

            if (score > 0) {
                className = 'advantage-indicator positive';
                text = `+${score} Advantage`;
            } else if (score < 0) {
                className = 'advantage-indicator negative';
                text = `${score} Disadvantage`;
            }

            display.innerHTML = `<span class="${className}">${text}</span>`;
        }

        function completeModule2() {
            const lifeStage = gameState.characterData.lifeStage || 'traditional';

            // Validate based on life stage (different question names per branch)
            const q5 = document.querySelector(`input[name="q5_${lifeStage}"]:checked`);
            const q6 = document.querySelector(`input[name="q6_${lifeStage}"]:checked`);

            if (!q5 || !q6) {
                alert('Please answer all questions before continuing.');
                return;
            }

            // Check if required exercises were completed
            const quizResult = GameEngine.state.comprehensionResults?.['m2_ex3_quiz'];
            const scenarioResult = GameEngine.state.scenarioPaths?.['m2_ex6_scenario'];

            // Soft validation - warn but allow proceeding
            if (!quizResult?.passed) {
                if (!confirm('You haven\'t passed the comprehension check yet. Continue anyway?')) {
                    return;
                }
            }

            if (!scenarioResult) {
                if (!confirm('You haven\'t completed the scenario exercise. Continue anyway?')) {
                    return;
                }
            }

            // Save data with life stage context
            gameState.characterData.educationPath = q5.value;
            gameState.characterData.careerField = q6.value;
            gameState.characterData.module2LifeStage = lifeStage; // Track which path taken

            // Sync exercise responses to gameState for export
            if (typeof GameEngine !== 'undefined') {
                gameState.exerciseResponses = GameEngine.state.exerciseResponses;
                gameState.comprehensionResults = GameEngine.state.comprehensionResults;
                gameState.journal = GameEngine.state.journal;
                gameState.mappingData = GameEngine.state.mappingData;
                gameState.scenarioPaths = GameEngine.state.scenarioPaths;
                gameState.narrativeFlags = GameEngine.state.narrativeFlags;
            }

            // Mark complete
            if (!gameState.modulesCompleted.includes(2)) {
                gameState.modulesCompleted.push(2);
            }
            gameState.currentModule = 3;

            saveGameState(true);

            alert('âœ… Module 2 Complete!\n\n' +
                  'ðŸ“¥ IMPORTANT: Export your game data before continuing!\n\n' +
                  'You need this for your Canvas Module 2 assignment.');
            showModuleHub();
        }

        // Initialize Module 3 (show appropriate branch based on life stage)
        function initModule3() {
            const lifeStage = gameState.characterData.lifeStage || 'traditional';

            // Initialize section controller for enhanced experience
            if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module3) {
                ModuleSectionController.init(3);
            }

            // Hide all branches
            document.querySelectorAll('#module3 .branch-content').forEach(div => {
                div.style.display = 'none';
            });

            // Show appropriate branch
            const branchDiv = document.getElementById(`module3_${lifeStage}`);
            if (branchDiv) {
                branchDiv.style.display = 'block';
            }
        }

        // Complete Module 3
        function completeModule3() {
            const lifeStage = gameState.characterData.lifeStage || 'traditional';

            // Validate based on life stage (different question names per branch)
            const q7 = document.querySelector(`input[name="q7_${lifeStage}"]:checked`);
            const q8 = document.querySelector(`input[name="q8_${lifeStage}"]:checked`);

            if (!q7 || !q8) {
                alert('Please answer all questions before continuing.');
                return;
            }

            // Save data with life stage context
            gameState.characterData.relationshipPath = q7.value;
            gameState.characterData.communicationStyle = q8.value;
            gameState.characterData.module3LifeStage = lifeStage; // Track which path taken

            // Mark complete
            if (!gameState.modulesCompleted.includes(3)) {
                gameState.modulesCompleted.push(3);
            }
            gameState.currentModule = 4;

            saveGameState(true);

            alert('âœ… Module 3 Complete!\n\n' +
                  'ðŸ“¥ IMPORTANT: Export your game data before continuing!\n\n' +
                  'You need this for your Canvas Module 3 assignment.');
            showModuleHub();
        }

        // Initialize Module 8 - populate profile summary (builds the character profile display)
        function buildProfileSummary() {
            const profile = gameState.characterData;
            let html = '';

            // Build comprehensive summary
            if (profile.familyValues) {
                html += `<div class="profile-item">
                    <span class="profile-label">Family Background:</span>
                    <span class="profile-value">${formatValue(profile.familyValues)}</span>
                </div>`;
            }

            if (profile.educationPath) {
                html += `<div class="profile-item">
                    <span class="profile-label">Education Path:</span>
                    <span class="profile-value">${formatValue(profile.educationPath)}</span>
                </div>`;
            }

            if (profile.careerField) {
                html += `<div class="profile-item">
                    <span class="profile-label">Career Field:</span>
                    <span class="profile-value">${formatValue(profile.careerField)}</span>
                </div>`;
            }

            if (profile.relationshipStatus) {
                html += `<div class="profile-item">
                    <span class="profile-label">Relationship Status:</span>
                    <span class="profile-value">${formatValue(profile.relationshipStatus)}</span>
                </div>`;
            }

            if (profile.communicationStyle) {
                html += `<div class="profile-item">
                    <span class="profile-label">Communication Score:</span>
                    <span class="profile-value">${profile.communicationStyle.score}/8</span>
                </div>`;
            }

            if (profile.partnerCompatibility) {
                html += `<div class="profile-item">
                    <span class="profile-label">Partner Compatibility:</span>
                    <span class="profile-value">${profile.partnerCompatibility.compatibilityScore}/10</span>
                </div>`;
            }

            if (profile.partnership) {
                html += `<div class="profile-item">
                    <span class="profile-label">Partnership Type:</span>
                    <span class="profile-value">${formatValue(profile.partnership.type)}</span>
                </div>`;
            }

            if (profile.parenthoodDecision) {
                html += `<div class="profile-item">
                    <span class="profile-label">Parenthood Decision:</span>
                    <span class="profile-value">${formatValue(profile.parenthoodDecision)}</span>
                </div>`;
            }

            if (profile.workFamilyBalance) {
                html += `<div class="profile-item">
                    <span class="profile-label">Work-Family Stress:</span>
                    <span class="profile-value">${formatValue(profile.workFamilyBalance.stressLevel)}</span>
                </div>`;
            }

            if (profile.crisisResponse) {
                html += `<div class="profile-item">
                    <span class="profile-label">Resilience Score:</span>
                    <span class="profile-value">${profile.crisisResponse.resilienceScore}/8</span>
                </div>`;
            }

            document.getElementById('profileSummary').innerHTML = html;
        }

        // Format values for display (with null safety)
        function formatValue(value) {
            if (!value) return 'Not set';
            if (typeof value !== 'string') return String(value);
            return value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Export data
        function exportData(format) {
            if (gameState.modulesCompleted.length === 0) {
                alert('Complete at least one module before exporting!');
                return;
            }

            // Sync GameEngine state to gameState before export
            saveGameState(false);

            if (format === 'text') {
                exportText();
            } else if (format === 'json') {
                exportJSON();
            }
        }

        function exportText() {
            const profile = gameState.characterData;
            let text = '=== LIFE PLANNING CHALLENGE - COMPLETE GAME SUMMARY ===\n\n';
            text += `Export Date: ${new Date().toLocaleString()}\n`;
            text += `Started: ${new Date(gameState.startedAt).toLocaleString()}\n`;
            text += `Modules Completed: ${gameState.modulesCompleted.length}/8\n\n`;

            text += '--- MODULE 1: CHARACTER CREATION ---\n';
            if (profile.familyValues) {
                text += `Family Values Growing Up: ${formatValue(profile.familyValues)}\n`;
            }
            if (profile.parentsWork) {
                text += `Parents' Work Pattern: ${formatValue(profile.parentsWork)}\n`;
            }
            if (profile.moneyRelationship) {
                text += `Money Relationship: ${formatValue(profile.moneyRelationship)}\n`;
            }
            if (profile.idealLife) {
                text += `Ideal Life at 35: ${profile.idealLife}\n`;
            }

            if (profile.educationPath) {
                text += `\n--- MODULE 2: EDUCATION & CAREER ---\n`;
                text += `Education Path: ${formatValue(profile.educationPath)}\n`;
                text += `Career Field: ${formatValue(profile.careerField)}\n`;
            }

            if (profile.communicationStyle) {
                text += `\n--- MODULE 3: COMMUNICATION & RELATIONSHIPS ---\n`;
                text += `Communication Score: ${profile.communicationStyle.score}/8\n`;
                text += `Relationship Status: ${formatValue(profile.relationshipStatus)}\n`;
                text += `Conflict Resolution: ${formatValue(profile.communicationStyle.conflict)}\n`;
                text += `Emotional Labor: ${formatValue(profile.communicationStyle.emotionalLabor)}\n`;
            }

            if (profile.partnerCompatibility) {
                text += `\n--- MODULE 4: MATE SELECTION & COMPATIBILITY ---\n`;
                text += `Compatibility Score: ${profile.partnerCompatibility.compatibilityScore}/10\n`;
                text += `Educational Homogamy: ${formatValue(profile.partnerCompatibility.education)}\n`;
                text += `Values Alignment: ${formatValue(profile.partnerCompatibility.values)}\n`;
                text += `Financial Compatibility: ${formatValue(profile.partnerCompatibility.finances)}\n`;
                text += `Children Agreement: ${formatValue(profile.partnerCompatibility.children)}\n`;
                text += `Relationship Decision: ${formatValue(profile.partnerCompatibility.decision)}\n`;
            }

            if (profile.partnership) {
                text += `\n--- MODULE 5: PARTNERSHIP FORMATION ---\n`;
                text += `Partnership Type: ${formatValue(profile.partnership.type)}\n`;
                text += `Financial Arrangement: ${formatValue(profile.partnership.finances)}\n`;
                text += `Legal Protections: ${formatValue(profile.partnership.legalProtection)}\n`;
            } else if (profile.partnershipType) {
                text += `\n--- MODULE 5: PARTNERSHIP FORMATION ---\n`;
                text += `Status: ${formatValue(profile.partnershipType)}\n`;
            }

            if (profile.parenthoodDecision) {
                text += `\n--- MODULE 6: PARENTHOOD & WORK-FAMILY BALANCE ---\n`;
                text += `Parenthood Decision: ${formatValue(profile.parenthoodDecision)}\n`;
                if (profile.workFamilyBalance) {
                    text += `Childcare Arrangement: ${formatValue(profile.workFamilyBalance.childcare)}\n`;
                    text += `Monthly Childcare Cost: $${profile.workFamilyBalance.childcareCost}\n`;
                    text += `Work Arrangement: ${formatValue(profile.workFamilyBalance.workArrangement)}\n`;
                    text += `Labor Division: ${formatValue(profile.workFamilyBalance.laborDivision)}\n`;
                    text += `Stress Level: ${formatValue(profile.workFamilyBalance.stressLevel)}\n`;
                }
            }

            if (profile.crisisResponse) {
                text += `\n--- MODULE 7: FAMILY CHALLENGES & RESILIENCE ---\n`;
                text += `Crisis Type: ${formatValue(profile.crisisResponse.crisisType)}\n`;
                text += `Immediate Response: ${formatValue(profile.crisisResponse.immediateResponse)}\n`;
                text += `Support Systems: ${profile.crisisResponse.supportSystems.map(s => formatValue(s)).join(', ')}\n`;
                text += `Relationship Impact: ${formatValue(profile.crisisResponse.relationshipImpact)}\n`;
                text += `Resilience Score: ${profile.crisisResponse.resilienceScore}/8\n`;
            }

            // Module 8 reflections (life-stage based + policy stance + systems reflection)
            if (profile.reflection1 || profile.policyStance || profile.systemsReflection) {
                text += `\n--- MODULE 8: SYSTEMS REFLECTION ---\n`;
                if (profile.module8LifeStage) {
                    text += `Life Stage Path: ${formatValue(profile.module8LifeStage)}\n`;
                }
                if (profile.reflection1) {
                    text += `Reflection 1 (Path Dependencies): ${formatValue(profile.reflection1)}\n`;
                }
                if (profile.reflection2) {
                    text += `Reflection 2 (Looking Forward): ${formatValue(profile.reflection2)}\n`;
                }
                if (profile.policyStance) {
                    text += `\nDECISION 15 - Policy Stance: ${formatValue(profile.policyStance)}\n`;
                }
                if (profile.systemsReflection) {
                    text += `\nREFLECTION 16 - Sociological Imagination:\n${profile.systemsReflection}\n`;
                }
            }
            // Backwards compatibility for old save format
            if (profile.finalReflection) {
                text += `\n--- MODULE 8: SYSTEMS REFLECTION (Legacy Format) ---\n`;
                text += `Biggest Impact Decision: ${formatValue(profile.finalReflection.biggestImpact)}\n`;
                if (profile.finalReflection.structuralConstraints) {
                    text += `Structural Constraints Experienced: ${profile.finalReflection.structuralConstraints.map(c => formatValue(c)).join(', ')}\n\n`;
                }
                text += `What Surprised You:\n${profile.finalReflection.surprises}\n\n`;
                text += `How Understanding of Family Changed:\n${profile.finalReflection.familyUnderstanding}\n\n`;
                text += `Policy Changes Needed:\n${profile.finalReflection.policyNeeds}\n`;
            }

            // Add GameEngine consequence summary if available
            if (typeof GameEngine !== 'undefined' && GameEngine.state.consequences.length > 0) {
                text += '\n\n=== CONSEQUENCE ANALYSIS ===\n';
                text += `Cumulative Advantage Score: ${GameEngine.state.advantageScore}\n`;
                text += `(Positive = accumulated advantages, Negative = accumulated disadvantages)\n\n`;

                // Group consequences by module
                const byModule = {};
                GameEngine.state.consequences.forEach(c => {
                    if (!byModule[c.moduleId]) byModule[c.moduleId] = [];
                    byModule[c.moduleId].push(c);
                });

                for (const [moduleId, consequences] of Object.entries(byModule)) {
                    const module = GAME_DATA.modules[moduleId];
                    text += `--- ${module?.title || 'Module ' + moduleId} ---\n`;
                    consequences.forEach(c => {
                        text += `Choice: ${c.consequence.label}\n`;
                        text += `Impact: ${c.consequence.immediate}\n`;
                        if (c.consequence.sociologicalLink) {
                            const concept = GAME_DATA.concepts[c.consequence.sociologicalLink.concept];
                            text += `Sociology: ${concept?.term || c.consequence.sociologicalLink.concept} (${c.consequence.sociologicalLink.hammondRef})\n`;
                        }
                        if (c.consequence.personalizedAdditions?.length > 0) {
                            text += `Path Dependencies: ${c.consequence.personalizedAdditions.join('; ')}\n`;
                        }
                        text += '\n';
                    });
                }

                // Add synthesis analysis
                const synthesis = GameEngine.generateSynthesisAnalysis();
                if (synthesis.pathDependencies.length > 0) {
                    text += '\n=== PATH DEPENDENCY PATTERNS ===\n';
                    synthesis.pathDependencies.forEach(p => {
                        text += `${p.pattern}: ${p.description}\n`;
                    });
                }

                if (synthesis.sociologicalInsights.length > 0) {
                    text += '\n=== SOCIOLOGICAL CONCEPTS ENCOUNTERED ===\n';
                    synthesis.sociologicalInsights.forEach(s => {
                        text += `â€¢ ${s.concept}: ${s.definition || ''} (${s.hammondRef || ''})\n`;
                    });
                }

                if (synthesis.policyImplications.length > 0) {
                    text += '\n=== POLICY IMPLICATIONS ===\n';
                    synthesis.policyImplications.forEach(p => {
                        text += `â€¢ ${p}\n`;
                    });
                }
            }

            // Add journal entries if available
            if (typeof ReflectionJournal !== 'undefined' && ReflectionJournal.entries.length > 0) {
                text += '\n\n=== YOUR REFLECTION JOURNAL ===\n';
                text += ReflectionJournal.exportEntries();
            }

            text += '\n\n=== END OF COMPREHENSIVE GAME SUMMARY ===\n';
            text += '\nUse this summary for your Canvas reflection assignments.\n';
            text += 'Connect your game experience to sociological concepts from the Hammond textbook.\n';
            text += 'Analyze how decisions cascaded across life domains and how structural forces shaped your choices.\n';

            // Download
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifePlanningGame_Complete_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            alert('âœ… Complete game summary downloaded! Upload this to your Canvas reflection assignment.');
        }

        function exportJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                gameState: gameState
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifePlanningGame_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('âœ… JSON data downloaded!');
        }

        // Print to PDF function
        function printToPDF() {
            if (gameState.modulesCompleted.length === 0) {
                alert('Complete at least one module before printing!');
                return;
            }

            // Create printable content
            const profile = gameState.characterData;
            let printContent = `
                <div id="printable" style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #9b59b6; padding-bottom: 20px;">
                        <h1 style="color: #2c3e50; margin-bottom: 10px;">Life Planning Challenge Game Report</h1>
                        <p style="color: #7f8c8d; font-size: 14px;">Student Name: _________________________________</p>
                        <p style="color: #7f8c8d; font-size: 14px;">Export Date: ${new Date().toLocaleString()}</p>
                        <p style="color: #7f8c8d; font-size: 14px;">Modules Completed: ${gameState.modulesCompleted.length}/8</p>
                    </div>
            `;

            // Add comprehensive game summary
            printContent += generatePrintSummary();

            printContent += `
                    <div style="margin-top: 40px; padding: 20px; background: #f0f8ff; border-left: 4px solid #9b59b6;">
                        <h3 style="color: #2c3e50;">Instructions for Canvas Submission:</h3>
                        <ol style="line-height: 1.8; color: #34495e;">
                            <li>Save this PDF with your name (e.g., "YourName_LifePlanningGame_Module${gameState.modulesCompleted.length}.pdf")</li>
                            <li>Upload to the corresponding Canvas assignment</li>
                            <li>Write your reflection connecting your game choices to course concepts</li>
                            <li>Cite specific decisions from this report in your reflection</li>
                        </ol>
                    </div>

                    <div style="margin-top: 30px; text-align: center; color: #7f8c8d; font-size: 12px;">
                        <p>Life Planning Challenge | SOC-213 Sociology of the Family | FTCC</p>
                        <p>This data is saved in your browser. Keep this PDF for your records.</p>
                    </div>
                </div>
            `;

            // Create temporary container
            const printContainer = document.createElement('div');
            printContainer.innerHTML = printContent;
            printContainer.id = 'printable';
            document.body.appendChild(printContainer);

            // Trigger print dialog
            window.print();

            // Clean up
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 1000);
        }

        // Generate comprehensive print summary
        function generatePrintSummary() {
            const profile = gameState.characterData;
            let html = '';

            if (profile.familyValues) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 1: Character Creation</h2>
                        <p><strong>Family Values Growing Up:</strong> ${formatValue(profile.familyValues)}</p>
                        <p><strong>Parents' Work Pattern:</strong> ${formatValue(profile.parentsWork)}</p>
                        <p><strong>Money Relationship:</strong> ${formatValue(profile.moneyRelationship)}</p>
                        <p><strong>Ideal Life at 35:</strong> ${profile.idealLife}</p>
                    </div>
                `;
            }

            if (profile.educationPath) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 2: Education & Career</h2>
                        <p><strong>Education Path:</strong> ${formatValue(profile.educationPath)}</p>
                        <p><strong>Career Field:</strong> ${formatValue(profile.careerField)}</p>
                    </div>
                `;
            }

            if (profile.communicationStyle) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 3: Communication & Relationships</h2>
                        <p><strong>Communication Score:</strong> ${profile.communicationStyle.score}/8</p>
                        <p><strong>Relationship Status:</strong> ${formatValue(profile.relationshipStatus)}</p>
                        <p><strong>Conflict Resolution Style:</strong> ${formatValue(profile.communicationStyle.conflict)}</p>
                        <p><strong>Emotional Labor:</strong> ${formatValue(profile.communicationStyle.emotionalLabor)}</p>
                    </div>
                `;
            }

            if (profile.partnerCompatibility) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 4: Mate Selection & Compatibility</h2>
                        <p><strong>Compatibility Score:</strong> ${profile.partnerCompatibility.compatibilityScore}/10</p>
                        <p><strong>Educational Homogamy:</strong> ${formatValue(profile.partnerCompatibility.education)}</p>
                        <p><strong>Values Alignment:</strong> ${formatValue(profile.partnerCompatibility.values)}</p>
                        <p><strong>Children Agreement:</strong> ${formatValue(profile.partnerCompatibility.children)}</p>
                    </div>
                `;
            }

            if (profile.partnership) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 5: Partnership Formation</h2>
                        <p><strong>Partnership Type:</strong> ${formatValue(profile.partnership.type)}</p>
                        <p><strong>Financial Arrangement:</strong> ${formatValue(profile.partnership.finances)}</p>
                        <p><strong>Legal Protections:</strong> ${formatValue(profile.partnership.legalProtection)}</p>
                    </div>
                `;
            }

            if (profile.parenthoodDecision) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 6: Parenthood & Work-Family Balance</h2>
                        <p><strong>Parenthood Decision:</strong> ${formatValue(profile.parenthoodDecision)}</p>
                `;
                if (profile.workFamilyBalance) {
                    html += `
                        <p><strong>Childcare:</strong> ${formatValue(profile.workFamilyBalance.childcare)}</p>
                        <p><strong>Monthly Cost:</strong> $${profile.workFamilyBalance.childcareCost}</p>
                        <p><strong>Work Arrangement:</strong> ${formatValue(profile.workFamilyBalance.workArrangement)}</p>
                        <p><strong>Stress Level:</strong> ${formatValue(profile.workFamilyBalance.stressLevel)}</p>
                    `;
                }
                html += `</div>`;
            }

            if (profile.crisisResponse) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 7: Family Challenges & Resilience</h2>
                        <p><strong>Crisis Type:</strong> ${formatValue(profile.crisisResponse.crisisType)}</p>
                        <p><strong>Immediate Response:</strong> ${formatValue(profile.crisisResponse.immediateResponse)}</p>
                        <p><strong>Support Systems:</strong> ${profile.crisisResponse.supportSystems.map(s => formatValue(s)).join(', ')}</p>
                        <p><strong>Resilience Score:</strong> ${profile.crisisResponse.resilienceScore}/8</p>
                    </div>
                `;
            }

            if (profile.finalReflection) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Module 8: Systems Reflection</h2>
                        <p><strong>Biggest Impact Decision:</strong> ${formatValue(profile.finalReflection.biggestImpact)}</p>
                        <p><strong>Structural Constraints:</strong> ${profile.finalReflection.structuralConstraints.map(c => formatValue(c)).join(', ')}</p>
                        <div style="margin-top: 15px;">
                            <p><strong>What Surprised You:</strong></p>
                            <p style="margin-left: 20px; font-style: italic;">${profile.finalReflection.surprises}</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <p><strong>Family Understanding Evolution:</strong></p>
                            <p style="margin-left: 20px; font-style: italic;">${profile.finalReflection.familyUnderstanding}</p>
                        </div>
                    </div>
                `;
            }

            // Add GameEngine analysis if available
            if (typeof GameEngine !== 'undefined' && GameEngine.state.consequences.length > 0) {
                const score = GameEngine.state.advantageScore;
                const scoreLabel = score > 0 ? 'Cumulative Advantage' : score < 0 ? 'Cumulative Disadvantage' : 'Neutral';
                const scoreColor = score > 0 ? '#27ae60' : score < 0 ? '#e74c3c' : '#7f8c8d';

                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border: 2px solid ${scoreColor}; border-radius: 8px;">
                        <h2 style="color: ${scoreColor}; margin-bottom: 15px;">Cumulative Life Course Score</h2>
                        <div style="text-align: center; margin: 20px 0;">
                            <span style="font-size: 48px; font-weight: bold; color: ${scoreColor};">${score > 0 ? '+' : ''}${score}</span>
                            <p style="color: #666; margin-top: 10px;">${scoreLabel}</p>
                        </div>
                        <p style="font-style: italic; color: #666; text-align: center;">
                            This score reflects how structural advantages and disadvantages accumulated across your life course decisions.
                        </p>
                    </div>
                `;

                // Add sociological concepts encountered
                const synthesis = GameEngine.generateSynthesisAnalysis();
                if (synthesis.sociologicalInsights.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #3498db; border-radius: 8px;">
                            <h2 style="color: #3498db; margin-bottom: 15px;">Sociological Concepts Encountered</h2>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #3498db; color: white;">
                                        <th style="padding: 10px; text-align: left;">Concept</th>
                                        <th style="padding: 10px; text-align: left;">Definition</th>
                                        <th style="padding: 10px; text-align: left;">Hammond Ref</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${synthesis.sociologicalInsights.map(s => `
                                        <tr style="border-bottom: 1px solid #ddd;">
                                            <td style="padding: 10px; font-weight: bold;">${s.concept}</td>
                                            <td style="padding: 10px;">${s.definition || 'See textbook'}</td>
                                            <td style="padding: 10px;">${s.hammondRef || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Add path dependency patterns
                if (synthesis.pathDependencies.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px; padding: 20px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 8px;">
                            <h2 style="color: #856404; margin-bottom: 15px;">Path Dependency Patterns Identified</h2>
                            ${synthesis.pathDependencies.map(p => `
                                <div style="margin-bottom: 15px;">
                                    <p style="font-weight: bold; color: #856404;">${p.pattern}</p>
                                    <p style="margin-left: 15px; color: #666;">${p.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            // Add journal entries if available
            if (typeof ReflectionJournal !== 'undefined' && ReflectionJournal.entries.length > 0) {
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: white; border: 2px solid #9b59b6; border-radius: 8px;">
                        <h2 style="color: #9b59b6; margin-bottom: 15px;">Your Reflection Journal</h2>
                        ${ReflectionJournal.entries.map(e => `
                            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <p style="font-size: 12px; color: #7f8c8d;">${new Date(e.timestamp).toLocaleString()}</p>
                                <p style="margin-top: 5px;">${e.entry}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return html;
        }

        // Add module completion reminders
        function showModuleCompletionReminder(moduleNum) {
            const reminder = `
                <div style="background: #fff3cd; border: 2px solid #f39c12; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #856404; margin-bottom: 10px;">Module ${moduleNum} Complete - Don't Forget to Save!</h3>
                    <p style="color: #856404; margin-bottom: 15px;"><strong>IMPORTANT:</strong> Before returning to Canvas, you MUST export your game data!</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-print" onclick="printToPDF()">Print to PDF (Recommended)</button>
                        <button class="btn btn-success" onclick="exportData('text')">Export as Text</button>
                        <button class="btn btn-secondary" onclick="showModuleHub()">Return to Module Hub</button>
                    </div>
                </div>
            `;
            return reminder;
        }

        // MODULE LOCKING SYSTEM
        const moduleProgress = JSON.parse(localStorage.getItem('soc213-module-progress')) || {
            1: { unlocked: true, completed: false, dateStarted: null, dateCompleted: null },
            2: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null },
            3: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null },
            4: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null },
            5: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null },
            6: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null },
            7: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null },
            8: { unlocked: false, completed: false, dateStarted: null, dateCompleted: null }
        };

        function saveModuleProgress() {
            localStorage.setItem('soc213-module-progress', JSON.stringify(moduleProgress));
        }

        function isModuleUnlocked(moduleNum) {
            return moduleProgress[moduleNum].unlocked;
        }

        function startModule(moduleNum) {
            if (!isModuleUnlocked(moduleNum)) {
                alert(`âš ï¸ Module ${moduleNum} is Locked\n\nTo unlock this module, you must:\nâœ“ Complete Module ${moduleNum - 1} game decisions\nâœ“ Export your game data\nâœ“ Submit Module ${moduleNum - 1} Canvas reflection\n\nThis ensures systematic learning progression through the course.`);
                return false;
            }

            if (!moduleProgress[moduleNum].dateStarted) {
                moduleProgress[moduleNum].dateStarted = new Date().toISOString();
                saveModuleProgress();
            }

            return true;
        }

        function completeModule(moduleNum) {
            moduleProgress[moduleNum].completed = true;
            moduleProgress[moduleNum].dateCompleted = new Date().toISOString();

            if (moduleNum < 8) {
                moduleProgress[moduleNum + 1].unlocked = true;
            }

            saveModuleProgress();
            showModuleCompletionModal(moduleNum);
        }

        function showModuleCompletionModal(moduleNum) {
            const nextModule = moduleNum + 1;
            const message = moduleNum < 8
                ? `âœ“ Module ${moduleNum} Completed!\n\nâœ“ Module ${nextModule} is now unlocked\n\nNext Steps:\n1. Export your game data (click button below)\n2. Submit Module ${moduleNum} Canvas reflection\n3. Return to continue Module ${nextModule}`
                : `âœ“ Module ${moduleNum} Completed!\n\nâœ“ You've finished all 8 modules!\n\nNext Steps:\n1. Export your complete game data\n2. Submit Module 8 final reflection\n3. Complete your "What IS Family?" portfolio project`;

            alert(message);
        }

        function updateModuleCards() {
            for (let i = 1; i <= 8; i++) {
                const card = document.getElementById(`module-${i}-card`);
                if (!card) continue;

                const status = moduleProgress[i];
                card.classList.remove('locked', 'unlocked', 'completed');

                if (status.completed) {
                    card.classList.add('completed');
                    const statusEl = card.querySelector('.module-status');
                    if (statusEl) statusEl.textContent = 'âœ“ Completed';
                } else if (status.unlocked) {
                    card.classList.add('unlocked');
                    const statusEl = card.querySelector('.module-status');
                    if (statusEl) statusEl.textContent = 'â–¶ï¸ Available';
                } else {
                    card.classList.add('locked');
                    const statusEl = card.querySelector('.module-status');
                    if (statusEl) statusEl.textContent = 'ðŸ”’ Locked';
                }
            }
        }

        // Print date update for PDF export
        window.addEventListener('beforeprint', function() {
            const printDate = document.getElementById('print-date');
            if (printDate) printDate.textContent = new Date().toLocaleDateString();
            const completedCount = Object.values(moduleProgress).filter(m => m.completed).length;
            const printModules = document.getElementById('print-modules-completed');
            if (printModules) printModules.textContent = completedCount;
        });

        // Reset game function
        function resetGame() {
            // Confirm with user
            const confirmed = confirm(
                'âš ï¸ RESET GAME WARNING âš ï¸\n\n' +
                'This will permanently delete:\n' +
                'âœ— All your game progress\n' +
                'âœ— All character decisions\n' +
                'âœ— All module completions\n' +
                'âœ— All saved data\n\n' +
                'Make sure you have exported your data first if you need it for assignments!\n\n' +
                'Are you absolutely sure you want to reset?'
            );

            if (!confirmed) {
                return; // User cancelled
            }

            // Double confirmation
            const doubleConfirm = confirm(
                'ðŸš¨ FINAL CONFIRMATION ðŸš¨\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Click OK to permanently delete all game data and start over.'
            );

            if (!doubleConfirm) {
                return; // User cancelled on second confirmation
            }

            // Clear all localStorage data
            localStorage.removeItem('lifePlanningGame');
            localStorage.removeItem('soc213-module-progress');

            // Show success message
            alert(
                'âœ“ Game Reset Complete!\n\n' +
                'All data has been cleared.\n' +
                'The page will now reload to start fresh.'
            );

            // Reload page to reset UI
            window.location.reload();
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            initGame();
            updateModuleCards();

            // Initialize life stage intro on load
            updateLifeStageIntro();

            // Add event listeners to life stage radio buttons
            document.querySelectorAll('input[name="q0_lifestage"]').forEach(radio => {
                radio.addEventListener('change', updateLifeStageIntro);
            });

            // Add event listener to age input field
            const ageInput = document.getElementById('currentAge');
            if (ageInput) {
                ageInput.addEventListener('input', updateReflectionAge);
                ageInput.addEventListener('change', updateReflectionAge);
            }
        });
// Add these functions for modules 4-8

// Initialize Module 4
function initModule4() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';

    // Initialize section controller for enhanced experience
    if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module4) {
        ModuleSectionController.init(4);
    }

    // Hide all branches
    document.querySelectorAll('#module4 .branch-content').forEach(div => {
        div.style.display = 'none';
    });

    // Show appropriate branch
    const branchDiv = document.getElementById(`module4_${lifeStage}`);
    if (branchDiv) {
        branchDiv.style.display = 'block';
    }
}

// Complete Module 4
function completeModule4() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';
    const q9 = document.querySelector(`input[name="q9_${lifeStage}"]:checked`);
    const q10 = document.querySelector(`input[name="q10_${lifeStage}"]:checked`);

    if (!q9 || !q10) {
        alert('Please answer all questions before continuing.');
        return;
    }

    gameState.characterData.partnerSelection = q9.value;
    gameState.characterData.sexualScripts = q10.value;
    gameState.characterData.module4LifeStage = lifeStage;

    if (!gameState.modulesCompleted.includes(4)) {
        gameState.modulesCompleted.push(4);
    }
    gameState.currentModule = 5;
    saveGameState(true);

    alert('âœ… Module 4 Complete!\n\nðŸ“¥ IMPORTANT: Export your game data before continuing!\n\nYou need this for your Canvas Module 4 assignment.');
    showModuleHub();
}

// Initialize Module 5
function initModule5() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';

    // Initialize section controller for enhanced experience
    if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module5) {
        ModuleSectionController.init(5);
    }

    // Hide all branches
    document.querySelectorAll('#module5 .branch-content').forEach(div => {
        div.style.display = 'none';
    });

    // Show appropriate branch
    const branchDiv = document.getElementById(`module5_${lifeStage}`);
    if (branchDiv) {
        branchDiv.style.display = 'block';
    }
}

// Complete Module 5
function completeModule5() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';
    const q11 = document.querySelector(`input[name="q11_${lifeStage}"]:checked`);
    const q12 = document.querySelector(`input[name="q12_${lifeStage}"]:checked`);

    if (!q11 || !q12) {
        alert('Please answer all questions before continuing.');
        return;
    }

    gameState.characterData.partnershipStatus = q11.value;
    gameState.characterData.partnershipStructure = q12.value;
    gameState.characterData.module5LifeStage = lifeStage;

    if (!gameState.modulesCompleted.includes(5)) {
        gameState.modulesCompleted.push(5);
    }
    gameState.currentModule = 6;
    saveGameState(true);

    alert('âœ… Module 5 Complete!\n\nðŸ“¥ IMPORTANT: Export your game data before continuing!\n\nYou need this for your Canvas Module 5 assignment.');
    showModuleHub();
}

// Initialize Module 6
function initModule6() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';

    // Initialize section controller for enhanced experience
    if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module6) {
        ModuleSectionController.init(6);
    }

    // Hide all branches
    document.querySelectorAll('#module6 .branch-content').forEach(div => {
        div.style.display = 'none';
    });

    // Show appropriate branch
    const branchDiv = document.getElementById(`module6_${lifeStage}`);
    if (branchDiv) {
        branchDiv.style.display = 'block';
    }
}

// Complete Module 6
function completeModule6() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';
    const q13 = document.querySelector(`input[name="q13_${lifeStage}"]:checked`);
    const q14 = document.querySelector(`input[name="q14_${lifeStage}"]:checked`);

    if (!q13 || !q14) {
        alert('Please answer all questions before continuing.');
        return;
    }

    gameState.characterData.parentingChildcare = q13.value;
    gameState.characterData.workFamilyBalance = q14.value;
    gameState.characterData.module6LifeStage = lifeStage;

    if (!gameState.modulesCompleted.includes(6)) {
        gameState.modulesCompleted.push(6);
    }
    gameState.currentModule = 7;
    saveGameState(true);

    alert('âœ… Module 6 Complete!\n\nðŸ“¥ IMPORTANT: Export your game data before continuing!\n\nYou need this for your Canvas Module 6 assignment.');
    showModuleHub();
}

// Initialize Module 7
function initModule7() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';

    // Initialize section controller for enhanced experience
    if (typeof ModuleSectionController !== 'undefined' && GAME_DATA.moduleSections?.module7) {
        ModuleSectionController.init(7);
    }

    // Hide all branches
    document.querySelectorAll('#module7 .branch-content').forEach(div => {
        div.style.display = 'none';
    });

    // Show appropriate branch
    const branchDiv = document.getElementById(`module7_${lifeStage}`);
    if (branchDiv) {
        branchDiv.style.display = 'block';
    }
}

// Complete Module 7
function completeModule7() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';
    const q15 = document.querySelector(`input[name="q15_${lifeStage}"]:checked`);
    const q16 = document.querySelector(`input[name="q16_${lifeStage}"]:checked`);

    if (!q15 || !q16) {
        alert('Please answer all questions before continuing.');
        return;
    }

    gameState.characterData.crisisType = q15.value;
    gameState.characterData.crisisResponse = q16.value;
    gameState.characterData.module7LifeStage = lifeStage;

    if (!gameState.modulesCompleted.includes(7)) {
        gameState.modulesCompleted.push(7);
    }
    gameState.currentModule = 8;
    saveGameState(true);

    alert('âœ… Module 7 Complete!\n\nðŸ“¥ IMPORTANT: Export your game data before continuing!\n\nYou need this for your Canvas Module 7 assignment.');
    showModuleHub();
}

// Initialize Module 8
function initModule8() {
    // Initialize section controller for Module 8
    if (typeof ModuleSectionController !== 'undefined') {
        ModuleSectionController.init(8);
    }

    const lifeStage = gameState.characterData.lifeStage || 'traditional';
    document.querySelectorAll('#module8 .branch-content').forEach(div => {
        div.style.display = 'none';
    });
    const branchDiv = document.getElementById(`module8_${lifeStage}`);
    if (branchDiv) {
        branchDiv.style.display = 'block';
    }

    // Build profile summary with error handling
    try {
        if (typeof buildProfileSummary === 'function') {
            buildProfileSummary();
        }
    } catch (err) {
        console.warn('Could not build profile summary:', err);
        const summaryEl = document.getElementById('profileSummary');
        if (summaryEl) {
            summaryEl.innerHTML = '<p style="color: #666;">Profile summary unavailable. Complete earlier modules to see your journey.</p>';
        }
    }

    // Show journey dashboard with error handling
    try {
        const summaryContainer = document.getElementById('module8-intro-summary');
        if (summaryContainer && typeof generateJourneyDashboard === 'function') {
            summaryContainer.innerHTML = generateJourneyDashboard();
        }
    } catch (err) {
        console.warn('Could not generate journey dashboard:', err);
    }

    // Show completion achievement if this is the final module
    if (typeof showAchievement === 'function') {
        const state = typeof GameEngine !== 'undefined' ? GameEngine.state : null;
        if (state && state.consequences.length >= 10) {
            setTimeout(() => {
                showAchievement('ðŸŽ‰', 'Journey Complete!', 'You\'ve navigated the full life course!');
            }, 1000);
        }
    }
}

// Complete Module 8 (Final)
function completeModule8() {
    const lifeStage = gameState.characterData.lifeStage || 'traditional';
    const q17 = document.querySelector(`input[name="q17_${lifeStage}"]:checked`);
    const q18 = document.querySelector(`input[name="q18_${lifeStage}"]:checked`);

    // Also validate DECISION 15 (policy stance) and REFLECTION 16 (systems reflection)
    const q15_policy = document.querySelector('input[name="q15"]:checked');
    const q16_reflection = document.getElementById('q16_systems_reflection');

    if (!q17 || !q18) {
        alert('Please answer the life-stage reflection questions before continuing.');
        return;
    }

    if (!q15_policy) {
        alert('Please answer DECISION 15 (your policy stance) before completing the game.');
        return;
    }

    if (!q16_reflection || !q16_reflection.value.trim()) {
        alert('Please complete REFLECTION 16 (sociological imagination synthesis) before completing the game.');
        return;
    }

    // Save life-stage reflections
    gameState.characterData.reflection1 = q17.value;
    gameState.characterData.reflection2 = q18.value;
    gameState.characterData.module8LifeStage = lifeStage;

    // Save policy stance and systems reflection
    gameState.characterData.policyStance = q15_policy.value;
    gameState.characterData.systemsReflection = q16_reflection.value;

    if (!gameState.modulesCompleted.includes(8)) {
        gameState.modulesCompleted.push(8);
    }
    gameState.currentModule = 8; // Stay at 8, game complete
    saveGameState(true);

    // Celebration confetti!
    if (typeof showConfetti === 'function') {
        showConfetti();
    }

    alert('ðŸŽ‰ GAME COMPLETE!\n\n' +
          'You have completed all 8 modules of the Life Planning Challenge!\n\n' +
          'ðŸ“¥ CRITICAL: Export your complete game data NOW!\n\n' +
          'You need this for your Canvas final reflection assignment.\n\n' +
          'Congratulations on experiencing how individual biography intersects with social structure, historical time, and life course timing.');
    showModuleHub();
}

// ========== CHOICE CARD UI SYSTEM ==========

/**
 * Create choice card HTML from game data
 */
function createChoiceCard(choiceData, isSelected = false) {
    const selectedClass = isSelected ? 'selected' : '';
    return `
        <div class="choice-card ${selectedClass}"
             data-choice-id="${choiceData.id}"
             onclick="selectChoiceCard(this, '${choiceData.id}')">
            <div class="choice-icon">${choiceData.icon || 'ðŸ“‹'}</div>
            <div class="choice-label">${choiceData.label}</div>
            <div class="choice-brief">${choiceData.brief}</div>
        </div>
    `;
}

/**
 * Render choice cards in a container
 */
function renderChoiceCards(containerId, choices, selectedId = null) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let html = '<div class="choice-cards-container">';
    for (const choice of choices) {
        html += createChoiceCard(choice, choice.id === selectedId);
    }
    html += '</div>';
    container.innerHTML = html;
}

/**
 * Handle choice card selection
 */
function selectChoiceCard(cardElement, choiceId) {
    // Remove selection from siblings
    const container = cardElement.parentElement;
    container.querySelectorAll('.choice-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Select this card
    cardElement.classList.add('selected');

    // Store selection in hidden input if exists
    const hiddenInput = container.querySelector('input[type="hidden"]');
    if (hiddenInput) {
        hiddenInput.value = choiceId;
    }

    // Trigger consequence reveal if panel exists
    const consequencePanel = container.closest('.question-group')?.querySelector('.consequence-panel');
    if (consequencePanel) {
        showConsequenceForChoice(choiceId, consequencePanel);
    }
}

/**
 * Show consequence panel for a choice
 */
function showConsequenceForChoice(choiceId, panelElement) {
    // Try to get consequence from GameEngine if available
    if (typeof GameEngine !== 'undefined' && typeof GAME_DATA !== 'undefined') {
        // Find the choice in game data
        let choiceData = null;
        for (const [key, choiceSet] of Object.entries(GAME_DATA.choices)) {
            if (choiceSet.options) {
                for (const [optKey, opt] of Object.entries(choiceSet.options)) {
                    if (opt.id === choiceId) {
                        choiceData = opt;
                        break;
                    }
                }
            }
            if (choiceData) break;
        }

        if (choiceData && choiceData.consequence) {
            renderConsequencePanel(panelElement, choiceData);
        }
    }
}

/**
 * Render consequence panel content
 */
function renderConsequencePanel(panelElement, choiceData) {
    const consequence = choiceData.consequence;

    let html = `
        <div class="consequence-header">
            <span class="icon">${choiceData.icon || 'ðŸ“‹'}</span>
            <h4>You chose: ${choiceData.label}</h4>
        </div>
        <div class="consequence-immediate">${consequence.immediate}</div>
    `;

    // Add personalized narrative based on exercise responses
    const narrativeHook = getPersonalizedNarrative(choiceData);
    if (narrativeHook) {
        html += `
            <div class="consequence-personalized" style="background: #f8f4ff; border-left: 4px solid var(--primary); padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0;">
                <h5 style="color: var(--primary); margin: 0 0 8px 0; font-size: 0.95em;">ðŸŽ¯ Based on Your Priorities</h5>
                <p style="margin: 0; color: var(--text-dark); font-size: 0.95em;">${narrativeHook}</p>
            </div>
        `;
    }

    if (consequence.sociologicalLink) {
        const concept = GAME_DATA.concepts?.[consequence.sociologicalLink.concept];
        html += `
            <div class="consequence-sociology">
                <h5>Sociological Connection</h5>
                <p><strong>${concept?.term || consequence.sociologicalLink.concept}</strong>:
                   ${concept?.definition || ''}
                   <em>(${consequence.sociologicalLink.hammondRef})</em></p>
            </div>
        `;
    }

    if (consequence.futureImpacts && consequence.futureImpacts.length > 0) {
        html += `
            <div class="future-impacts">
                <h5>Future Impacts:</h5>
                <ul>
                    ${consequence.futureImpacts.map(impact => `<li>${impact}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    // Add dynamic reflection prompt based on choice context
    if (consequence.sociologicalLink && typeof GameEngine !== 'undefined') {
        const concept = GAME_DATA.concepts?.[consequence.sociologicalLink.concept];
        const conceptTerm = concept?.term || consequence.sociologicalLink.concept;

        // Generate contextual reflection question
        let reflectionQ = '';
        if (GameEngine.state.advantageScore > 2) {
            reflectionQ = `How has your accumulated advantage (+${GameEngine.state.advantageScore}) shaped your ability to make this choice freely?`;
        } else if (GameEngine.state.advantageScore < -2) {
            reflectionQ = `How have structural constraints (disadvantage score: ${GameEngine.state.advantageScore}) limited your options here?`;
        } else if (concept) {
            reflectionQ = `How does "${conceptTerm}" help explain why this choice felt available (or unavailable) to you?`;
        }

        if (reflectionQ) {
            const promptId = `reflect_${Date.now()}`;
            html += `
                <div class="reflection-prompt consequence-reflection">
                    <h5>Quick Reflection</h5>
                    <p>${reflectionQ}</p>
                    <textarea id="${promptId}" placeholder="Brief reflection (optional)..." rows="2"></textarea>
                </div>
            `;
        }
    }

    panelElement.innerHTML = html;
    panelElement.classList.add('visible');
}

/**
 * Create reflection prompt HTML
 */
function createReflectionPrompt(promptText, textareaId, isOptional = true) {
    return `
        <div class="reflection-prompt">
            <h5>Pause and Reflect</h5>
            <p>${promptText}</p>
            <textarea id="${textareaId}"
                      placeholder="Your reflection here... (${isOptional ? 'optional but encouraged' : 'required'})"></textarea>
            ${isOptional ? '<p class="reflection-optional">This reflection is optional but helps deepen your sociological understanding.</p>' : ''}
        </div>
    `;
}

/**
 * Get personalized narrative based on exercise responses
 */
function getPersonalizedNarrative(choiceData) {
    if (typeof GameEngine === 'undefined' || typeof GAME_DATA === 'undefined') return null;

    const narratives = [];

    // Check ranking exercises for top priorities
    const rankingExercises = ['m1_ex2_values_sort', 'm2_ex1_ranking', 'm3_ex1_ranking', 'm4_ex1_ranking'];
    for (const exId of rankingExercises) {
        const response = GameEngine.getExerciseResponse(exId);
        if (response?.ranking && response.ranking.length > 0) {
            const exercise = GAME_DATA.exercises?.[exId];
            const topPriority = response.ranking[0];

            // Check if this exercise has narrative hooks for the top priority
            if (exercise?.narrativeHooks?.[topPriority]) {
                narratives.push(exercise.narrativeHooks[topPriority]);
            }
        }
    }

    // Check scenario exercises for flags that connect to this choice
    const scenarioExercises = ['m1_ex5_scenario', 'm2_ex6_scenario', 'm3_ex4_scenario'];
    for (const exId of scenarioExercises) {
        const response = GameEngine.state.scenarioPaths?.[exId];
        if (response?.branchChosen) {
            const exercise = GAME_DATA.exercises?.[exId];
            const branch = exercise?.branches?.find(b => b.id === response.branchChosen);
            if (branch?.narrativeFlag) {
                // Generate contextual text based on flag
                const flagNarratives = {
                    'asserts_independence': 'Your earlier decision to assert independence shapes how you approach this choice.',
                    'keeps_peace': 'Your tendency to keep peace in family situations influences your priorities here.',
                    'bridges_difference': 'Your communication skills from earlier help you navigate this decision.',
                    'self_protective': 'Your preference for protecting your boundaries affects your options.',
                    'career_priority': 'Your career-focused decisions create path dependencies here.',
                    'relationship_priority': 'Prioritizing relationships earlier shapes what feels possible now.',
                    'balance_seeker': 'Your attempt to balance competing demands affects your current choices.'
                };
                if (flagNarratives[branch.narrativeFlag]) {
                    narratives.push(flagNarratives[branch.narrativeFlag]);
                }
            }
        }
    }

    // Return the most relevant narrative (first match)
    return narratives.length > 0 ? narratives[0] : null;
}

/**
 * Render advantage score indicator
 */
function renderAdvantageIndicator(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let score = 0;
    if (typeof GameEngine !== 'undefined') {
        score = GameEngine.state?.advantageScore || 0;
    } else if (typeof gameState !== 'undefined') {
        score = gameState.characterData?.advantageScore || 0;
    }

    let statusClass = 'neutral';
    let statusText = 'Neutral Position';
    let statusIcon = 'âš–ï¸';

    if (score > 0) {
        statusClass = 'positive';
        statusText = `+${score} Cumulative Advantage`;
        statusIcon = 'ðŸ“ˆ';
    } else if (score < 0) {
        statusClass = 'negative';
        statusText = `${score} Cumulative Disadvantage`;
        statusIcon = 'ðŸ“‰';
    }

    container.innerHTML = `
        <div class="advantage-indicator ${statusClass}">
            <span>${statusIcon}</span>
            <span>${statusText}</span>
        </div>
    `;
}

/**
 * Initialize GameEngine with current game state (bridges old and new systems)
 */
function syncGameEngineState() {
    if (typeof GameEngine !== 'undefined' && typeof gameState !== 'undefined') {
        GameEngine.init({
            lifeStage: gameState.characterData?.lifeStage,
            choices: {
                1: {
                    familyStructure: gameState.characterData?.familyValues,
                    coreValue: gameState.characterData?.parentsWork
                },
                2: {
                    educationPath: gameState.characterData?.educationPath,
                    careerField: gameState.characterData?.careerField
                }
            },
            advantageScore: gameState.characterData?.advantageScore || 0
        });
    }
}

/**
 * Map question input names to GAME_DATA choice keys
 * This bridges the HTML input names with the data layer
 */
const QUESTION_TO_DATA_KEY = {
    // Module 1
    'q0_lifestage': 'm1_lifestage',
    'q1': 'm1_family',
    'q2': 'm1_value',
    // Module 2 - traditional
    'q5_traditional': 'm2_education_traditional',
    'q6_traditional': 'm2_career_traditional',
    // Module 2 - returning
    'q5_returning': 'm2_education_returning',
    'q6_returning': 'm2_situation_returning',
    // Module 2 - midcareer
    'q5_midcareer': 'm2_career_midcareer',
    'q6_midcareer': 'm2_caregiving_midcareer',
    // Module 2 - laterlife
    'q5_laterlife': 'm2_retirement_laterlife',
    'q6_laterlife': 'm2_situation_laterlife',
    // Module 3 - traditional
    'q7_traditional': 'm3_relationship_traditional',
    'q8_traditional': 'm3_communication_traditional',
    // Module 3 - returning
    'q7_returning': 'm3_relationship_returning',
    'q8_returning': 'm3_communication_returning',
    // Module 3 - midcareer
    'q7_midcareer': 'm3_relationship_midcareer',
    'q8_midcareer': 'm3_communication_midcareer',
    // Module 3 - laterlife
    'q7_laterlife': 'm3_relationship_laterlife',
    'q8_laterlife': 'm3_communication_laterlife',
    // Module 4 - Partner Selection
    'q9_traditional': 'm4_partner_traditional',
    'q9_returning': 'm4_partner_returning',
    'q9_midcareer': 'm4_partner_midcareer',
    'q9_laterlife': 'm4_partner_laterlife',
    'q10_traditional': 'm4_priorities_traditional',
    'q10_returning': 'm4_priorities_returning',
    'q10_midcareer': 'm4_priorities_midcareer',
    'q10_laterlife': 'm4_priorities_laterlife',
    // Module 5 - Marriage/Cohabitation
    'q11_traditional': 'm5_marriage_traditional',
    'q11_returning': 'm5_marriage_returning',
    'q11_midcareer': 'm5_marriage_midcareer',
    'q11_laterlife': 'm5_marriage_laterlife',
    'q12_traditional': 'm5_finances_traditional',
    'q12_returning': 'm5_finances_returning',
    'q12_midcareer': 'm5_finances_midcareer',
    'q12_laterlife': 'm5_finances_laterlife',
    // Module 6 - Parenthood/Caregiving
    'q13_traditional': 'm6_childcare_traditional',
    'q13_returning': 'm6_childcare_returning',
    'q13_midcareer': 'm6_parenting_midcareer',
    'q13_laterlife': 'm6_grandparenting_laterlife',
    'q14_traditional': 'm6_division_traditional',
    'q14_returning': 'm6_division_returning',
    'q14_midcareer': 'm6_launching_midcareer',
    'q14_laterlife': 'm6_support_laterlife',
    // Module 7 - Crisis/Resilience
    'q15_traditional': 'm7_crisis_traditional',
    'q15_returning': 'm7_crisis_returning',
    'q15_midcareer': 'm7_crisis_midcareer',
    'q15_laterlife': 'm7_crisis_laterlife',
    'q16_traditional': 'm7_response_traditional',
    'q16_returning': 'm7_response_returning',
    'q16_midcareer': 'm7_response_midcareer',
    'q16_laterlife': 'm7_response_laterlife',
    // Module 8 - Synthesis
    'q15': 'm8_policy',
    // Module 8 q17 - Reflection (life-stage variants)
    'q17_traditional': 'm8_reflection_traditional',
    'q17_returning': 'm8_reflection_returning',
    'q17_midcareer': 'm8_reflection_midcareer',
    'q17_laterlife': 'm8_reflection_laterlife',
    // Module 8 q18 - Systems Thinking (life-stage variants)
    'q18_traditional': 'm8_systems_traditional',
    'q18_returning': 'm8_systems_returning',
    'q18_midcareer': 'm8_systems_midcareer',
    'q18_laterlife': 'm8_systems_laterlife'
};

/**
 * Initialize choice card event listeners
 * Uses event delegation for better performance
 * Includes keyboard navigation, smooth scroll, what-if, achievements
 */
function initChoiceCards() {
    // FALLBACK: Click handler to ensure radio gets checked (fixes display:none issues)
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.choice-card');
        if (card) {
            const radio = card.querySelector('input[type="radio"]');
            if (radio && !radio.checked) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    });

    // Listen for radio input changes (triggered by clicking labels)
    document.addEventListener('change', function(e) {
        if (e.target.type === 'radio' && e.target.closest('.choice-card')) {
            const card = e.target.closest('.choice-card');
            const container = card.closest('.choice-cards-container');
            const questionGroup = card.closest('.question-group');
            const choiceValue = card.dataset.value || e.target.value;

            // Remove selection from all sibling cards
            container.querySelectorAll('.choice-card').forEach(c => {
                c.classList.remove('selected');
            });

            // Add selection to clicked card
            card.classList.add('selected');

            // Show consequence panel if exists
            const consequencePanel = questionGroup?.querySelector('.consequence-panel');
            if (consequencePanel && typeof GAME_DATA !== 'undefined') {
                // Determine data key from input name
                const inputName = e.target.name;
                const dataKey = QUESTION_TO_DATA_KEY[inputName];

                if (dataKey) {
                    // Find choice data in GAME_DATA
                    const choiceSet = GAME_DATA.choices[dataKey];
                    if (choiceSet && choiceSet[choiceValue]) {
                        // Record choice with GameEngine for tracking
                        if (typeof GameEngine !== 'undefined') {
                            // Extract module and question info from dataKey
                            const match = dataKey.match(/m(\d+)_(\w+)/);
                            if (match) {
                                const moduleId = parseInt(match[1]);
                                const questionId = match[2];
                                // Apply state changes from choice
                                const choice = choiceSet[choiceValue];
                                if (choice.stateChanges) {
                                    for (const [key, value] of Object.entries(choice.stateChanges)) {
                                        if (key === 'advantageScore') {
                                            GameEngine.state.advantageScore += value;
                                        } else {
                                            GameEngine.state[key] = value;
                                        }
                                    }
                                }
                                // Store consequence (avoid duplicates)
                                const existingIdx = GameEngine.state.consequences.findIndex(
                                    c => c.moduleId === moduleId && c.questionId === questionId
                                );
                                const consequenceData = {
                                    moduleId,
                                    questionId,
                                    choiceValue,
                                    consequence: {
                                        label: choice.label,
                                        brief: choice.brief,
                                        immediate: choice.consequence?.immediate || '',
                                        sociologicalLink: choice.consequence?.sociologicalLink || null,
                                        futureImpacts: choice.consequence?.futureImpacts || [],
                                        personalizedAdditions: []
                                    },
                                    timestamp: new Date().toISOString()
                                };

                                if (existingIdx >= 0) {
                                    GameEngine.state.consequences[existingIdx] = consequenceData;
                                } else {
                                    GameEngine.state.consequences.push(consequenceData);
                                }
                            }
                        }

                        // Render consequence panel
                        renderConsequencePanel(consequencePanel, choiceSet[choiceValue]);

                        // Smooth scroll to consequence panel
                        setTimeout(() => smoothScrollTo(consequencePanel, true), 100);

                        // Update advantage displays
                        updateAdvantageDisplays();

                        // Sync state
                        StateManager.sync();

                        // Check for achievements
                        checkAchievements();

                        // Show What-If comparison (30% chance to avoid overload)
                        if (Math.random() < 0.3 && questionGroup?.id) {
                            setTimeout(() => {
                                insertWhatIfPanel(questionGroup.id, dataKey, choiceValue);
                            }, 500);
                        }
                    }
                }
            }
        }
    });

    // Keyboard navigation for choice cards
    document.addEventListener('keydown', function(e) {
        const card = e.target.closest('.choice-card');
        if (!card) return;

        const container = card.closest('.choice-cards-container');
        const cards = Array.from(container.querySelectorAll('.choice-card'));
        const currentIndex = cards.indexOf(card);

        let nextCard = null;

        switch(e.key) {
            case 'ArrowRight':
            case 'ArrowDown':
                e.preventDefault();
                nextCard = cards[(currentIndex + 1) % cards.length];
                break;
            case 'ArrowLeft':
            case 'ArrowUp':
                e.preventDefault();
                nextCard = cards[(currentIndex - 1 + cards.length) % cards.length];
                break;
            case 'Enter':
            case ' ':
                e.preventDefault();
                const radioInput = card.querySelector('input[type="radio"]');
                if (radioInput && !radioInput.checked) {
                    radioInput.checked = true;
                    radioInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
                return;
        }

        if (nextCard) {
            const nextInput = nextCard.querySelector('input[type="radio"]');
            if (nextInput) nextInput.focus();
        }
    });

    // Click handler for card selection
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.choice-card');
        if (card) {
            const radioInput = card.querySelector('input[type="radio"]');
            if (radioInput && !radioInput.checked) {
                radioInput.checked = true;
                radioInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    });
}

/**
 * Update all advantage score displays across modules
 */
let lastAdvantageScore = 0;

function updateAdvantageDisplays() {
    if (typeof GameEngine === 'undefined') return;

    const score = GameEngine.state.advantageScore || 0;
    const changed = score !== lastAdvantageScore;
    lastAdvantageScore = score;

    let statusClass = 'neutral';
    let statusText = 'Neutral';
    let statusIcon = 'âš–ï¸';

    if (score > 0) {
        statusClass = 'positive';
        statusText = `+${score} Advantage`;
        statusIcon = 'ðŸ“ˆ';
    } else if (score < 0) {
        statusClass = 'negative';
        statusText = `${score} Disadvantage`;
        statusIcon = 'ðŸ“‰';
    }

    const html = `
        <div class="advantage-indicator ${statusClass} ${changed ? 'changed' : ''}">
            <span>${statusIcon}</span>
            <span>${statusText}</span>
        </div>
    `;

    // Update all module advantage displays
    for (let i = 2; i <= 8; i++) {
        const container = document.getElementById(`advantage-m${i}`);
        if (container) {
            container.innerHTML = html;
        }
    }

    // Also sync to old gameState for backwards compatibility
    if (typeof gameState !== 'undefined') {
        gameState.characterData.advantageScore = score;
    }
}

/**
 * Smooth scroll to element with highlight effect
 */
function smoothScrollTo(element, highlight = true) {
    if (!element) return;

    element.scrollIntoView({ behavior: 'smooth', block: 'center' });

    if (highlight) {
        element.classList.add('scroll-highlight');
        setTimeout(() => element.classList.remove('scroll-highlight'), 1500);
    }
}

/**
 * Show achievement toast notification
 */
function showAchievement(icon, title, description) {
    // Remove existing toast
    const existing = document.querySelector('.achievement-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = 'achievement-toast';
    toast.innerHTML = `
        <div class="achievement-icon">${icon}</div>
        <div class="achievement-text">
            <h4>${title}</h4>
            <p>${description}</p>
        </div>
    `;

    document.body.appendChild(toast);

    // Auto-hide after 4 seconds
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

/**
 * Celebration confetti for game completion
 */
function showConfetti() {
    const colors = ['#9b59b6', '#e74c3c', '#27ae60', '#f39c12', '#3498db', '#e91e63'];
    const confettiCount = 150;

    for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.cssText = `
                position: fixed;
                width: ${Math.random() * 10 + 5}px;
                height: ${Math.random() * 10 + 5}px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                left: ${Math.random() * 100}vw;
                top: -20px;
                border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                pointer-events: none;
                z-index: 10000;
                animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
                transform: rotate(${Math.random() * 360}deg);
            `;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 5000);
        }, i * 20);
    }
}

/**
 * Show auto-save notification
 */
function showSaveNotification() {
    const existing = document.querySelector('.save-notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = 'save-notification';
    notification.innerHTML = '<span>Progress saved</span>';
    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--success, #27ae60);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9000;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

/**
 * Generate journey progress visualization
 */
function renderJourneyProgress(containerId, currentModule = 1) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const modules = [
        { id: 1, label: 'Origins' },
        { id: 2, label: 'Career' },
        { id: 3, label: 'Relate' },
        { id: 4, label: 'Partner' },
        { id: 5, label: 'Union' },
        { id: 6, label: 'Family' },
        { id: 7, label: 'Crisis' },
        { id: 8, label: 'Reflect' }
    ];

    const completedModules = typeof gameState !== 'undefined'
        ? gameState.modulesCompleted || []
        : [];

    let html = '<div class="journey-path">';

    modules.forEach(mod => {
        let nodeClass = 'journey-node';
        if (completedModules.includes(mod.id)) {
            nodeClass += ' completed';
        } else if (mod.id === currentModule) {
            nodeClass += ' current';
        } else if (mod.id > currentModule) {
            nodeClass += ' locked';
        }

        html += `
            <div class="${nodeClass}">
                ${completedModules.includes(mod.id) ? 'âœ“' : mod.id}
                <span class="journey-node-label">${mod.label}</span>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

/**
 * Generate module summary panel
 */
function generateModuleSummary(moduleId) {
    if (typeof GameEngine === 'undefined') return '';

    const moduleConsequences = GameEngine.state.consequences.filter(c => c.moduleId === moduleId);
    if (moduleConsequences.length === 0) return '';

    const module = GAME_DATA.modules[moduleId];

    let choicesHtml = moduleConsequences.map(c => `
        <div class="summary-choice">
            <div class="summary-choice-label">${c.consequence.label}</div>
            <div class="summary-choice-impact">${c.consequence.immediate}</div>
        </div>
    `).join('');

    // Calculate module-specific stats
    const conceptsEncountered = moduleConsequences
        .filter(c => c.consequence.sociologicalLink)
        .map(c => c.consequence.sociologicalLink.concept);

    const uniqueConcepts = [...new Set(conceptsEncountered)];

    return `
        <div class="module-summary">
            <h3>ðŸ“Š ${module?.title || 'Module ' + moduleId} Summary</h3>
            <div class="module-summary-choices">
                ${choicesHtml}
            </div>
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value">${moduleConsequences.length}</div>
                    <div class="summary-stat-label">Decisions Made</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${uniqueConcepts.length}</div>
                    <div class="summary-stat-label">Concepts Explored</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${GameEngine.state.advantageScore >= 0 ? '+' : ''}${GameEngine.state.advantageScore}</div>
                    <div class="summary-stat-label">Cumulative Score</div>
                </div>
            </div>
        </div>
    `;
}

/**
 * What-If Replay Mode - Show alternate path consequences
 */
function showWhatIfComparison(questionKey, originalChoice, alternateChoice) {
    if (typeof GAME_DATA === 'undefined') return null;

    const choiceSet = GAME_DATA.choices[questionKey];
    if (!choiceSet) return null;

    const original = choiceSet[originalChoice];
    const alternate = choiceSet[alternateChoice];

    if (!original || !alternate) return null;

    return `
        <div class="whatif-mode">
            <div class="whatif-header">
                <span>ðŸ”®</span>
                <h4>What If You Had Chosen Differently?</h4>
            </div>
            <div class="whatif-comparison">
                <div class="whatif-path original">
                    <h5>âœ“ Your Choice: ${original.label}</h5>
                    <p>${original.consequence?.immediate || original.brief}</p>
                </div>
                <div class="whatif-path alternate">
                    <h5>â†ª Alternate: ${alternate.label}</h5>
                    <p>${alternate.consequence?.immediate || alternate.brief}</p>
                </div>
            </div>
        </div>
    `;
}

/**
 * Insert What-If panel after a question group
 */
function insertWhatIfPanel(questionGroupId, questionKey, selectedValue) {
    const questionGroup = document.getElementById(questionGroupId);
    if (!questionGroup) return;

    // Get all available choices for this question
    const choiceSet = GAME_DATA.choices[questionKey];
    if (!choiceSet) return;

    const alternateChoices = Object.keys(choiceSet).filter(k => k !== selectedValue);
    if (alternateChoices.length === 0) return;

    // Pick a random alternate
    const alternate = alternateChoices[Math.floor(Math.random() * alternateChoices.length)];
    const whatIfHtml = showWhatIfComparison(questionKey, selectedValue, alternate);

    if (whatIfHtml) {
        // Check if what-if panel already exists
        let existingPanel = questionGroup.querySelector('.whatif-mode');
        if (existingPanel) {
            existingPanel.outerHTML = whatIfHtml;
        } else {
            questionGroup.insertAdjacentHTML('beforeend', whatIfHtml);
        }
    }
}

/**
 * Toggle What If Mode - shows/hides alternate path comparisons
 */
let whatIfModeActive = false;

function toggleWhatIfMode() {
    whatIfModeActive = !whatIfModeActive;
    const btn = document.getElementById('whatIfToggle');

    if (whatIfModeActive) {
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-secondary');
        btn.innerHTML = 'ðŸ”® What If Mode: ON';
        document.body.classList.add('whatif-active');

        // Generate what-if panels for all completed choices
        generateAllWhatIfPanels();
    } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        btn.innerHTML = 'ðŸ”® What If Mode';
        document.body.classList.remove('whatif-active');
    }
}

/**
 * Generate What If panels for all choices made
 */
function generateAllWhatIfPanels() {
    if (typeof GameEngine === 'undefined' || typeof GAME_DATA === 'undefined') return;

    const consequences = GameEngine.state.consequences || [];

    consequences.forEach(c => {
        const questionKey = `m${c.moduleId}_${c.questionId}`;
        const choiceSet = GAME_DATA.choices[questionKey];
        if (!choiceSet) return;

        // Find an alternate choice
        const allChoices = Object.keys(choiceSet);
        const alternate = allChoices.find(k => k !== c.choiceValue);
        if (!alternate) return;

        // Find the question group in the DOM
        const questionGroups = document.querySelectorAll('.question-group');
        questionGroups.forEach(group => {
            const radio = group.querySelector(`input[value="${c.choiceValue}"]`);
            if (radio) {
                const whatIfHtml = showWhatIfComparison(questionKey, c.choiceValue, alternate);
                if (whatIfHtml && !group.querySelector('.whatif-mode')) {
                    group.insertAdjacentHTML('beforeend', whatIfHtml);
                }
            }
        });
    });
}

/**
 * Update last saved timestamp display
 */
function updateLastSavedDisplay() {
    const el = document.getElementById('lastSavedTime');
    if (!el || !gameState.lastUpdated) return;

    const saved = new Date(gameState.lastUpdated);
    const now = new Date();
    const diffMs = now - saved;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);

    let timeAgo;
    if (diffMins < 1) {
        timeAgo = 'just now';
    } else if (diffMins < 60) {
        timeAgo = `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    } else if (diffHours < 24) {
        timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    } else {
        timeAgo = saved.toLocaleDateString();
    }

    el.innerHTML = `<span title="${saved.toLocaleString()}">ðŸ’¾ Saved ${timeAgo}</span>`;
}

/**
 * Consolidated state manager - bridges old gameState with GameEngine
 */
const StateManager = {
    sync: function() {
        if (typeof GameEngine === 'undefined' || typeof gameState === 'undefined') return;

        // Sync GameEngine state to gameState
        gameState.characterData.advantageScore = GameEngine.state.advantageScore;
        gameState.characterData.lifeStage = GameEngine.state.lifeStage;

        // Sync choices
        for (const [moduleId, choices] of Object.entries(GameEngine.state.choices)) {
            if (!gameState.moduleChoices) gameState.moduleChoices = {};
            gameState.moduleChoices[moduleId] = choices;
        }

        // Persist to localStorage
        saveGameState(true);
    },

    restore: function() {
        if (typeof GameEngine === 'undefined' || typeof gameState === 'undefined') return;

        // Restore GameEngine from gameState
        if (gameState.characterData?.advantageScore) {
            GameEngine.state.advantageScore = gameState.characterData.advantageScore;
        }
        if (gameState.characterData?.lifeStage) {
            GameEngine.state.lifeStage = gameState.characterData.lifeStage;
        }
        if (gameState.moduleChoices) {
            GameEngine.state.choices = { ...GameEngine.state.choices, ...gameState.moduleChoices };
        }
    },

    getAdvantageScore: function() {
        if (typeof GameEngine !== 'undefined') {
            return GameEngine.state.advantageScore || 0;
        }
        if (typeof gameState !== 'undefined') {
            return gameState.characterData?.advantageScore || 0;
        }
        return 0;
    }
};

/**
 * Check for achievements based on game progress
 */
function checkAchievements() {
    if (typeof GameEngine === 'undefined') return;

    const state = GameEngine.state;
    const totalChoices = state.consequences.length;
    const score = state.advantageScore;

    // First choice achievement
    if (totalChoices === 1) {
        showAchievement('ðŸŽ¯', 'First Steps', 'You made your first life decision!');
    }

    // Module completion achievements
    const modulesWithChoices = [...new Set(state.consequences.map(c => c.moduleId))];
    if (modulesWithChoices.length === 4 && !window.achievementM4) {
        window.achievementM4 = true;
        showAchievement('ðŸ“š', 'Halfway There', 'You\'ve completed 4 modules!');
    }

    // Advantage milestones
    if (score >= 5 && !window.achievementAdv5) {
        window.achievementAdv5 = true;
        showAchievement('ðŸŒŸ', 'Privileged Path', 'Your cumulative advantage reached +5');
    }

    if (score <= -5 && !window.achievementDis5) {
        window.achievementDis5 = true;
        showAchievement('ðŸ”ï¸', 'Against the Odds', 'You\'re experiencing cumulative disadvantage');
    }

    // Sociology explorer
    const uniqueConcepts = [...new Set(
        state.consequences
            .filter(c => c.consequence.sociologicalLink)
            .map(c => c.consequence.sociologicalLink.concept)
    )];

    if (uniqueConcepts.length >= 10 && !window.achievementConcepts) {
        window.achievementConcepts = true;
        showAchievement('ðŸŽ“', 'Sociology Scholar', 'You\'ve encountered 10+ sociological concepts!');
    }
}

// Sync on page load
window.addEventListener('DOMContentLoaded', function() {
    // Initialize choice card interactions
    initChoiceCards();

    // Listen for age input changes to update dynamic ages throughout game
    const ageInput = document.getElementById('currentAge');
    if (ageInput) {
        ageInput.addEventListener('input', function() {
            if (typeof updateReflectionAge === 'function') {
                updateReflectionAge();
            }
        });
        ageInput.addEventListener('change', function() {
            if (typeof updateReflectionAge === 'function') {
                updateReflectionAge();
            }
        });
    }

    // Delay sync to ensure gameState is loaded
    setTimeout(() => {
        syncGameEngineState();
        StateManager.restore();
        updateAdvantageDisplays();

        // Update dynamic ages from saved state
        if (typeof gameState !== 'undefined' && gameState.characterData?.currentAge) {
            document.querySelectorAll('.dynamic-age').forEach(el => {
                el.textContent = gameState.characterData.currentAge;
            });
        }

        // Initialize journey progress if container exists
        const journeyContainer = document.getElementById('journey-progress-main');
        if (journeyContainer) {
            const currentModule = getCurrentModuleNumber();
            renderJourneyProgress('journey-progress-main', currentModule);
        }
    }, 100);
});

/**
 * Generate complete journey dashboard for Module 8
 */
function generateJourneyDashboard() {
    if (typeof GameEngine === 'undefined') return '';

    const state = GameEngine.state;
    const consequences = state.consequences;

    if (consequences.length === 0) return '';

    // Calculate statistics
    const totalChoices = consequences.length;
    const modulesVisited = [...new Set(consequences.map(c => c.moduleId))].length;
    const allConcepts = consequences
        .filter(c => c.consequence.sociologicalLink)
        .map(c => c.consequence.sociologicalLink.concept);
    const uniqueConcepts = [...new Set(allConcepts)];

    // Determine path type based on advantage score
    let pathType, pathIcon, pathDescription;
    if (state.advantageScore >= 5) {
        pathType = 'Privileged Path';
        pathIcon = 'ðŸŒŸ';
        pathDescription = 'Your early advantages compounded, opening doors at each stage.';
    } else if (state.advantageScore <= -5) {
        pathType = 'Uphill Battle';
        pathIcon = 'ðŸ”ï¸';
        pathDescription = 'Structural barriers created cascading challenges. Your resilience was tested.';
    } else if (state.advantageScore > 0) {
        pathType = 'Moderate Advantage';
        pathIcon = 'ðŸ“ˆ';
        pathDescription = 'Some advantages helped, but challenges remained.';
    } else if (state.advantageScore < 0) {
        pathType = 'Facing Headwinds';
        pathIcon = 'ðŸŒ¬ï¸';
        pathDescription = 'Disadvantages created extra hurdles along your journey.';
    } else {
        pathType = 'Balanced Journey';
        pathIcon = 'âš–ï¸';
        pathDescription = 'A mix of advantages and challenges shaped your path.';
    }

    // Build choice timeline
    let timelineHtml = '';
    const moduleNames = {
        1: 'Origins', 2: 'Career', 3: 'Relationships', 4: 'Partner',
        5: 'Union', 6: 'Family', 7: 'Crisis', 8: 'Reflection'
    };

    for (let m = 1; m <= 8; m++) {
        const moduleChoices = consequences.filter(c => c.moduleId === m);
        if (moduleChoices.length > 0) {
            timelineHtml += `
                <div style="margin-bottom: 16px; padding-left: 20px; border-left: 3px solid var(--primary);">
                    <strong>Module ${m}: ${moduleNames[m]}</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        ${moduleChoices.map(c => `<li>${c.consequence.label}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
    }

    return `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; border-radius: 20px; padding: 32px; margin: 24px 0;">
            <h2 style="margin: 0 0 24px 0; text-align: center; font-size: 1.8em;">
                ðŸŽ® Your Life Journey Complete
            </h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 28px;">
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div style="font-size: 2.5em;">${totalChoices}</div>
                    <div style="opacity: 0.8; font-size: 0.9em;">Decisions Made</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div style="font-size: 2.5em;">${modulesVisited}</div>
                    <div style="opacity: 0.8; font-size: 0.9em;">Modules Explored</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div style="font-size: 2.5em;">${uniqueConcepts.length}</div>
                    <div style="opacity: 0.8; font-size: 0.9em;">Concepts Encountered</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div style="font-size: 2.5em;">${state.advantageScore >= 0 ? '+' : ''}${state.advantageScore}</div>
                    <div style="opacity: 0.8; font-size: 0.9em;">Cumulative Score</div>
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 10px;">
                    ${pathIcon} ${pathType}
                </h3>
                <p style="margin: 0; opacity: 0.9;">${pathDescription}</p>
            </div>

            <details style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px;">
                <summary style="cursor: pointer; font-weight: 600; font-size: 1.1em;">
                    ðŸ“œ View Your Complete Choice Timeline
                </summary>
                <div style="margin-top: 16px;">
                    ${timelineHtml}
                </div>
            </details>

            ${uniqueConcepts.length > 0 ? `
                <details style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-top: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 1.1em;">
                        ðŸŽ“ Sociological Concepts You Explored
                    </summary>
                    <div style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px;">
                        ${uniqueConcepts.map(concept => {
                            const conceptData = GAME_DATA.concepts[concept];
                            return `<span style="background: rgba(155, 89, 182, 0.3); padding: 6px 12px; border-radius: 16px; font-size: 0.9em;">${conceptData?.term || concept}</span>`;
                        }).join('')}
                    </div>
                </details>
            ` : ''}
        </div>
    `;
}

/**
 * Get current module number from visible section or gameState
 */
function getCurrentModuleNumber() {
    // Check which module section is visible
    for (let i = 1; i <= 8; i++) {
        const section = document.getElementById(`module${i}`);
        if (section && section.classList.contains('active')) {
            return i;
        }
    }
    // Fallback to gameState
    if (typeof gameState !== 'undefined' && gameState.currentModule) {
        return gameState.currentModule;
    }
    return 1;
}

/**
 * Update journey progress when module changes
 */
function onModuleChange(moduleNumber) {
    renderJourneyProgress('journey-progress-main', moduleNumber);
    updateAdvantageDisplays();

    // Show module summary for previous module
    if (moduleNumber > 1) {
        const summaryHtml = generateModuleSummary(moduleNumber - 1);
        const summaryContainer = document.getElementById(`module${moduleNumber}-intro-summary`);
        if (summaryContainer && summaryHtml) {
            summaryContainer.innerHTML = summaryHtml;
        }
    }

    // Prompt to save after each module
    if (moduleNumber > 1) {
        promptSaveProgress();
    }
}

// ========== SOCIAL COMPARISON SYSTEM ==========
const SocialComparison = {
    // Simulated aggregate data (in production, this would come from a backend)
    aggregateData: {
        'm1_family': { nuclear_stable: 45, extended_multigenerational: 20, single_parent_resilient: 25, blended_adaptive: 10 },
        'm2_education_traditional': { bachelor: 55, associate: 20, trade: 15, workforce: 10 },
        'm4_partner_traditional': { education_career_match: 40, emotional_connection: 35, family_values_align: 15, economic_stability: 10 },
        'm5_marriage_traditional': { marry_now_cleared_bar: 35, cohabit_pathway: 40, marry_despite_bar: 15, cohabit_alternative: 10 },
        'm7_response_traditional': { rely_savings: 30, family_support: 45, struggle_debt: 25 }
    },

    getComparison: function(dataKey, selectedValue) {
        const data = this.aggregateData[dataKey];
        if (!data) return null;

        const total = Object.values(data).reduce((a, b) => a + b, 0);
        const yourPercent = data[selectedValue] ? Math.round((data[selectedValue] / total) * 100) : null;

        if (yourPercent === null) return null;

        const othersPercent = 100 - yourPercent;

        return {
            yourPercent,
            othersPercent,
            message: yourPercent > 50
                ? `${yourPercent}% of players made this same choice`
                : `Only ${yourPercent}% chose this path - you're taking a less common route`
        };
    },

    render: function(dataKey, selectedValue) {
        const comparison = this.getComparison(dataKey, selectedValue);
        if (!comparison) return '';

        return `
            <div class="social-comparison">
                <div class="social-comparison-icon">ðŸ‘¥</div>
                <div class="social-comparison-text">${comparison.message}</div>
                <div class="social-comparison-bar">
                    <div class="social-comparison-fill" style="width: ${comparison.yourPercent}%"></div>
                </div>
            </div>
        `;
    },

    // Record choice to aggregate (stores locally for demo)
    recordChoice: function(dataKey, selectedValue) {
        const stored = JSON.parse(localStorage.getItem('lpc_aggregate') || '{}');
        if (!stored[dataKey]) stored[dataKey] = {};
        if (!stored[dataKey][selectedValue]) stored[dataKey][selectedValue] = 0;
        stored[dataKey][selectedValue]++;
        localStorage.setItem('lpc_aggregate', JSON.stringify(stored));
    }
};

// ========== HAMMOND TEXTBOOK QUOTES ==========
const TextbookQuotes = {
    quotes: {
        'educational-homogamy': {
            text: "Educational homogamy has increased dramatically... college-educated individuals increasingly marry each other, contributing to growing inequality between families.",
            page: 142,
            chapter: 7
        },
        'marriage-bar': {
            text: "The 'marriage bar' refers to the economic prerequisites that must be met before marriage is considered viableâ€”stable employment, adequate income, and often home ownership.",
            page: 198,
            chapter: 9
        },
        'second-shift': {
            text: "Women who work outside the home still perform the majority of housework and childcare... essentially working a 'second shift' after their paid employment.",
            page: 287,
            chapter: 12
        },
        'cumulative-advantage': {
            text: "Early advantages tend to accumulate over timeâ€”what sociologists call 'cumulative advantage.' Those who start ahead often pull further ahead.",
            page: 58,
            chapter: 3
        },
        'cumulative-disadvantage': {
            text: "Disadvantages compound across the life course. A single setback can trigger cascading problems in employment, health, and family stability.",
            page: 61,
            chapter: 3
        },
        'sandwich-generation': {
            text: "The 'sandwich generation' faces simultaneous demands from aging parents and dependent children, with women bearing the disproportionate burden of this care work.",
            page: 312,
            chapter: 13
        },
        'gray-divorce': {
            text: "Divorce rates among adults 50 and older have doubled since 1990... these 'gray divorces' have distinct causes and consequences compared to younger couples.",
            page: 342,
            chapter: 14
        },
        'cohabitation': {
            text: "Cohabitation has transformed from a deviant practice to a normative step in relationship formation... but its meaning varies significantly by social class.",
            page: 176,
            chapter: 8
        }
    },

    render: function(conceptKey) {
        const quote = this.quotes[conceptKey];
        if (!quote) return '';

        return `
            <div class="textbook-quote">
                <blockquote>"${quote.text}"</blockquote>
                <cite>â€” Hammond, <em>Sociology of the Family</em>, p. ${quote.page}</cite>
                <a href="#" class="read-more" onclick="alert('In a full implementation, this would link to your digital textbook or course materials.'); return false;">
                    Read more in Chapter ${quote.chapter} â†’
                </a>
            </div>
        `;
    }
};

// ========== REFLECTION JOURNAL ==========
const ReflectionJournal = {
    entries: [],

    init: function() {
        this.entries = JSON.parse(localStorage.getItem('lpc_journal') || '[]');
        this.createSidebar();
        this.createToggle();
    },

    createToggle: function() {
        if (document.querySelector('.journal-toggle')) return;

        const toggle = document.createElement('button');
        toggle.className = 'journal-toggle';
        toggle.innerHTML = 'ðŸ““ Journal';
        toggle.onclick = () => this.toggleSidebar();
        document.body.appendChild(toggle);
    },

    createSidebar: function() {
        if (document.querySelector('.journal-sidebar')) return;

        const sidebar = document.createElement('div');
        sidebar.className = 'journal-sidebar';
        sidebar.id = 'journal-sidebar';
        sidebar.innerHTML = `
            <div class="journal-header">
                <h3>ðŸ““ Reflection Journal</h3>
                <button class="journal-close" onclick="ReflectionJournal.toggleSidebar()">Ã—</button>
            </div>
            <div class="journal-content" id="journal-entries">
                ${this.entries.length === 0 ? '<p style="color: #888; text-align: center;">Your reflections will appear here.</p>' : ''}
            </div>
            <div class="journal-input-area">
                <textarea id="journal-input" placeholder="What are you thinking about this choice?"></textarea>
                <button onclick="ReflectionJournal.addEntry()">Add Reflection</button>
            </div>
        `;
        document.body.appendChild(sidebar);
        this.renderEntries();
    },

    toggleSidebar: function() {
        const sidebar = document.getElementById('journal-sidebar');
        if (sidebar) {
            sidebar.classList.toggle('open');
        }
    },

    addEntry: function() {
        const input = document.getElementById('journal-input');
        const text = input.value.trim();
        if (!text) return;

        const entry = {
            id: Date.now(),
            text: text,
            timestamp: new Date().toISOString(),
            module: getCurrentModuleNumber()
        };

        this.entries.push(entry);
        localStorage.setItem('lpc_journal', JSON.stringify(this.entries));
        input.value = '';
        this.renderEntries();

        showSaveIndicator('saved', 'Journal entry saved');
    },

    renderEntries: function() {
        const container = document.getElementById('journal-entries');
        if (!container) return;

        if (this.entries.length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">Your reflections will appear here.</p>';
            return;
        }

        container.innerHTML = this.entries.slice().reverse().map(entry => `
            <div class="journal-entry">
                <div class="journal-entry-header">
                    Module ${entry.module} â€¢ ${new Date(entry.timestamp).toLocaleDateString()}
                </div>
                <div class="journal-entry-text">${entry.text}</div>
            </div>
        `).join('');
    },

    exportEntries: function() {
        return this.entries.map(e =>
            `[Module ${e.module} - ${new Date(e.timestamp).toLocaleDateString()}]\n${e.text}`
        ).join('\n\n---\n\n');
    }
};

// ========== SAVE INDICATOR ==========
function showSaveIndicator(status, message) {
    let indicator = document.querySelector('.save-indicator');

    if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'save-indicator';
        document.body.appendChild(indicator);
    }

    const icons = {
        saving: 'â³',
        saved: 'âœ“',
        error: 'âš ï¸'
    };

    indicator.className = `save-indicator ${status}`;
    indicator.innerHTML = `
        <span class="save-indicator-icon">${icons[status]}</span>
        <span class="save-indicator-text">${message}</span>
    `;

    indicator.classList.add('visible');

    setTimeout(() => {
        indicator.classList.remove('visible');
    }, 3000);
}

// ========== SAVE SLOTS SYSTEM ==========
const SaveSlots = {
    maxSlots: 3,

    getSlots: function() {
        return JSON.parse(localStorage.getItem('lpc_save_slots') || '[]');
    },

    saveToSlot: function(slotIndex, name) {
        const slots = this.getSlots();

        const saveData = {
            name: name || `Save ${slotIndex + 1}`,
            timestamp: new Date().toISOString(),
            gameState: typeof gameState !== 'undefined' ? JSON.parse(JSON.stringify(gameState)) : null,
            engineState: typeof GameEngine !== 'undefined' ? GameEngine.exportState() : null,
            journal: ReflectionJournal.entries
        };

        slots[slotIndex] = saveData;
        localStorage.setItem('lpc_save_slots', JSON.stringify(slots));

        showSaveIndicator('saved', `Saved to Slot ${slotIndex + 1}`);
        return true;
    },

    loadFromSlot: function(slotIndex) {
        const slots = this.getSlots();
        const slot = slots[slotIndex];

        if (!slot) {
            alert('This save slot is empty.');
            return false;
        }

        if (slot.gameState && typeof gameState !== 'undefined') {
            Object.assign(gameState, slot.gameState);
            saveGameState(true);
        }

        if (slot.engineState && typeof GameEngine !== 'undefined') {
            GameEngine.init(slot.engineState);
        }

        if (slot.journal) {
            ReflectionJournal.entries = slot.journal;
            localStorage.setItem('lpc_journal', JSON.stringify(slot.journal));
            ReflectionJournal.renderEntries();
        }

        showSaveIndicator('saved', `Loaded from Slot ${slotIndex + 1}`);
        location.reload();
        return true;
    },

    deleteSlot: function(slotIndex) {
        if (!confirm('Delete this save? This cannot be undone.')) return;

        const slots = this.getSlots();
        slots[slotIndex] = null;
        localStorage.setItem('lpc_save_slots', JSON.stringify(slots));

        this.renderSlots();
    },

    renderSlots: function(containerId = 'save-slots-grid') {
        const container = document.getElementById(containerId);
        if (!container) return;

        const slots = this.getSlots();
        let html = '';

        for (let i = 0; i < this.maxSlots; i++) {
            const slot = slots[i];

            if (slot) {
                const date = new Date(slot.timestamp).toLocaleDateString();
                const modulesCompleted = slot.gameState?.modulesCompleted?.length || 0;

                html += `
                    <div class="save-slot" onclick="SaveSlots.loadFromSlot(${i})">
                        <div class="save-slot-name">${slot.name}</div>
                        <div class="save-slot-info">${date} â€¢ ${modulesCompleted}/8 modules</div>
                        <div class="save-slot-actions" onclick="event.stopPropagation()">
                            <button class="load-btn" onclick="SaveSlots.loadFromSlot(${i})">Load</button>
                            <button class="delete-btn" onclick="SaveSlots.deleteSlot(${i})">Delete</button>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="save-slot empty" onclick="SaveSlots.promptSaveToSlot(${i})">
                        <div class="save-slot-name">Empty Slot ${i + 1}</div>
                        <div class="save-slot-info">Click to save here</div>
                    </div>
                `;
            }
        }

        container.innerHTML = html;
    },

    promptSaveToSlot: function(slotIndex) {
        const name = prompt('Name this save (or leave blank for default):');
        if (name === null) return; // Cancelled
        this.saveToSlot(slotIndex, name || `Save ${slotIndex + 1}`);
        this.renderSlots();
    }
};

// ========== SAVE PROMPT MODAL ==========
function promptSaveProgress() {
    // Don't show if recently dismissed
    const lastDismissed = localStorage.getItem('lpc_save_prompt_dismissed');
    if (lastDismissed && Date.now() - parseInt(lastDismissed) < 300000) return; // 5 min cooldown

    const overlay = document.createElement('div');
    overlay.className = 'save-prompt-overlay';
    overlay.id = 'save-prompt-overlay';
    overlay.innerHTML = `
        <div class="save-prompt-modal">
            <div class="save-prompt-icon">ðŸ’¾</div>
            <div class="save-prompt-title">Save Your Progress?</div>
            <div class="save-prompt-text">
                You've made great progress! Save now to avoid losing your work.
                <br><br>
                <strong>Remember:</strong> Your data stays on this device only.
            </div>
            <div class="save-prompt-buttons">
                <button class="save-btn" onclick="doQuickSave(); closeSavePrompt();">Save Now</button>
                <button class="later-btn" onclick="closeSavePrompt(true);">Later</button>
            </div>
        </div>
    `;

    document.body.appendChild(overlay);
    setTimeout(() => overlay.classList.add('visible'), 10);
}

function closeSavePrompt(dismiss = false) {
    const overlay = document.getElementById('save-prompt-overlay');
    if (overlay) {
        overlay.classList.remove('visible');
        setTimeout(() => overlay.remove(), 300);

        if (dismiss) {
            localStorage.setItem('lpc_save_prompt_dismissed', Date.now().toString());
        }
    }
}

function doQuickSave() {
    // Save to first available slot or overwrite last
    const slots = SaveSlots.getSlots();
    let targetSlot = slots.findIndex(s => !s);
    if (targetSlot === -1) targetSlot = 0; // Overwrite first if all full

    SaveSlots.saveToSlot(targetSlot, `Auto-Save ${new Date().toLocaleTimeString()}`);
}

// ========== INSTRUCTOR DASHBOARD ==========
const InstructorDashboard = {
    // This would normally pull from a backend
    getClassData: function() {
        // Simulated class aggregate data
        return {
            totalStudents: 47,
            avgCompletion: 5.2,
            avgAdvantageScore: -0.8,
            choiceDistributions: {
                'Family Background': [
                    { label: 'Nuclear Stable', percent: 42 },
                    { label: 'Extended Family', percent: 23 },
                    { label: 'Single Parent', percent: 28 },
                    { label: 'Blended', percent: 7 }
                ],
                'Education Path': [
                    { label: "Bachelor's Degree", percent: 51 },
                    { label: 'Community College', percent: 22 },
                    { label: 'Trade/Vocational', percent: 18 },
                    { label: 'Direct to Work', percent: 9 }
                ],
                'Crisis Response': [
                    { label: 'Used Savings', percent: 28 },
                    { label: 'Family Support', percent: 47 },
                    { label: 'Struggled/Debt', percent: 25 }
                ]
            },
            discussionPrompts: [
                "47% relied on family support during crisis - what does this reveal about social safety nets?",
                "Students choosing 'direct to work' had average disadvantage score of -3.2. Why might this be?",
                "Only 7% came from blended families but national rate is ~16%. What selection bias might be at play?"
            ]
        };
    },

    render: function(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const data = this.getClassData();

        let distributionsHtml = '';
        for (const [category, choices] of Object.entries(data.choiceDistributions)) {
            distributionsHtml += `
                <div class="choice-distribution">
                    <h4>${category}</h4>
                    ${choices.map(c => `
                        <div class="distribution-bar">
                            <div class="distribution-label">${c.label}</div>
                            <div class="distribution-track">
                                <div class="distribution-fill" style="width: ${c.percent}%"></div>
                            </div>
                            <div class="distribution-percent">${c.percent}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        container.innerHTML = `
            <div class="instructor-dashboard">
                <div class="instructor-header">
                    <h2>ðŸ“Š Instructor Dashboard</h2>
                    <span style="opacity: 0.7;">Class Aggregate Data</span>
                </div>

                <div class="instructor-stats">
                    <div class="instructor-stat">
                        <div class="instructor-stat-value">${data.totalStudents}</div>
                        <div class="instructor-stat-label">Students</div>
                    </div>
                    <div class="instructor-stat">
                        <div class="instructor-stat-value">${data.avgCompletion.toFixed(1)}</div>
                        <div class="instructor-stat-label">Avg Modules</div>
                    </div>
                    <div class="instructor-stat">
                        <div class="instructor-stat-value">${data.avgAdvantageScore >= 0 ? '+' : ''}${data.avgAdvantageScore.toFixed(1)}</div>
                        <div class="instructor-stat-label">Avg Advantage</div>
                    </div>
                </div>

                ${distributionsHtml}

                <div class="discussion-prompts">
                    <h4>ðŸ’¬ Generated Discussion Prompts</h4>
                    ${data.discussionPrompts.map(p => `
                        <div class="discussion-prompt-item">${p}</div>
                    `).join('')}
                </div>
            </div>
        `;
    }
};

// ========== ENHANCED CONSEQUENCE PANEL WITH ALL FEATURES ==========
// Override renderConsequencePanel to include social comparison and textbook quotes
const originalRenderConsequencePanel = renderConsequencePanel;
renderConsequencePanel = function(panelElement, choiceData) {
    // Call original
    originalRenderConsequencePanel(panelElement, choiceData);

    // Add social comparison
    const inputName = panelElement.closest('.question-group')?.querySelector('input[type="radio"]:checked')?.name;
    const dataKey = inputName ? QUESTION_TO_DATA_KEY[inputName] : null;
    const choiceValue = panelElement.closest('.question-group')?.querySelector('input[type="radio"]:checked')?.value;

    if (dataKey && choiceValue) {
        const socialHtml = SocialComparison.render(dataKey, choiceValue);
        if (socialHtml) {
            panelElement.insertAdjacentHTML('beforeend', socialHtml);
        }

        // Record this choice
        SocialComparison.recordChoice(dataKey, choiceValue);
    }

    // Add textbook quote if there's a sociology link
    if (choiceData.consequence?.sociologicalLink?.concept) {
        const quoteHtml = TextbookQuotes.render(choiceData.consequence.sociologicalLink.concept);
        if (quoteHtml) {
            panelElement.insertAdjacentHTML('beforeend', quoteHtml);
        }
    }
};

// ========== ACCESSIBILITY ENHANCEMENTS ==========
function initAccessibility() {
    // Add ARIA attributes to all choice cards
    document.querySelectorAll('.choice-cards-container').forEach((container, groupIdx) => {
        container.setAttribute('role', 'radiogroup');
        const questionGroup = container.closest('.question-group');
        const questionTitle = questionGroup?.querySelector('h3, h4, p strong')?.textContent || `Question ${groupIdx + 1}`;
        container.setAttribute('aria-label', questionTitle);

        container.querySelectorAll('.choice-card').forEach((card, idx) => {
            const label = card.querySelector('.choice-label')?.textContent || `Option ${idx + 1}`;
            const brief = card.querySelector('.choice-brief')?.textContent || '';
            const radio = card.querySelector('input[type="radio"]');

            // Make card focusable and add descriptive label
            card.setAttribute('tabindex', '0');
            card.setAttribute('aria-label', `${label}${brief ? ': ' + brief : ''}`);

            // Sync selection state
            if (radio) {
                card.setAttribute('aria-checked', radio.checked ? 'true' : 'false');
                radio.addEventListener('change', () => {
                    container.querySelectorAll('.choice-card').forEach(c => {
                        c.setAttribute('aria-checked', 'false');
                    });
                    card.setAttribute('aria-checked', 'true');
                });
            }

            // Allow Enter/Space to select card
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const radio = card.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });
        });
    });

    // Add skip link for keyboard users
    const skipLink = document.createElement('a');
    skipLink.href = '#main-content';
    skipLink.className = 'skip-link';
    skipLink.textContent = 'Skip to main content';
    skipLink.style.cssText = 'position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:9999;';
    skipLink.addEventListener('focus', () => {
        skipLink.style.cssText = 'position:fixed;left:10px;top:10px;padding:10px 20px;background:var(--primary);color:white;border-radius:4px;z-index:9999;text-decoration:none;font-weight:600;';
    });
    skipLink.addEventListener('blur', () => {
        skipLink.style.cssText = 'position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:9999;';
    });
    document.body.insertBefore(skipLink, document.body.firstChild);

    // Add main content landmark
    const contentDiv = document.querySelector('.content');
    if (contentDiv && !contentDiv.id) {
        contentDiv.id = 'main-content';
    }

    // Add ARIA live region for announcements
    if (!document.getElementById('aria-live-region')) {
        const liveRegion = document.createElement('div');
        liveRegion.id = 'aria-live-region';
        liveRegion.setAttribute('role', 'status');
        liveRegion.setAttribute('aria-live', 'polite');
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.className = 'sr-only';
        liveRegion.style.cssText = 'position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;';
        document.body.appendChild(liveRegion);
    }
}

// Announce message to screen readers
function announceToScreenReader(message) {
    const liveRegion = document.getElementById('aria-live-region');
    if (liveRegion) {
        liveRegion.textContent = '';
        setTimeout(() => { liveRegion.textContent = message; }, 100);
    }
}

// Add accessibility to dynamically rendered exercises
function enhanceExerciseAccessibility(exerciseId) {
    const container = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
    if (!container) return;

    const exercise = GAME_DATA.exercises?.[exerciseId];
    if (!exercise) return;

    // Set role and label on container
    container.setAttribute('role', 'region');
    container.setAttribute('aria-label', exercise.title || 'Exercise');

    // Handle specific exercise types
    if (exercise.type === 'ranking') {
        const list = container.querySelector('.ranking-list');
        if (list) {
            list.setAttribute('role', 'listbox');
            list.setAttribute('aria-label', 'Drag items to reorder or use arrow buttons');
            list.querySelectorAll('.ranking-item').forEach((item, idx) => {
                item.setAttribute('role', 'option');
                item.setAttribute('aria-selected', 'false');
                item.setAttribute('tabindex', '0');
                // Keyboard navigation
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        ExerciseRenderer.moveRankingItem(exerciseId, item.dataset.id, -1);
                        setTimeout(() => item.focus(), 50);
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        ExerciseRenderer.moveRankingItem(exerciseId, item.dataset.id, 1);
                        setTimeout(() => item.focus(), 50);
                    }
                });
            });
        }
    }

    if (exercise.type === 'quiz') {
        container.querySelectorAll('.quiz-question').forEach((q, idx) => {
            q.setAttribute('role', 'group');
            q.setAttribute('aria-label', `Question ${idx + 1}`);
        });
    }

    if (exercise.type === 'scenario') {
        const branches = container.querySelector('.scenario-branches');
        if (branches) {
            branches.setAttribute('role', 'radiogroup');
            branches.setAttribute('aria-label', 'Choose your response');
            branches.querySelectorAll('.scenario-branch').forEach((branch, idx) => {
                branch.setAttribute('role', 'radio');
                branch.setAttribute('tabindex', '0');
                branch.setAttribute('aria-checked', branch.classList.contains('selected') ? 'true' : 'false');
                // Keyboard selection
                branch.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        branch.click();
                    }
                });
            });
        }
    }

    if (exercise.type === 'reflection') {
        const textarea = container.querySelector('textarea');
        if (textarea && !textarea.getAttribute('aria-describedby')) {
            const charCount = container.querySelector('.reflection-char-count');
            if (charCount) {
                charCount.id = `char-count-desc-${exerciseId}`;
                textarea.setAttribute('aria-describedby', charCount.id);
            }
        }
    }
}

// ========== EXERCISE RENDERER ==========
// Renders all 6 exercise types: ranking, calculator, quiz, reflection, mapping, scenario

const ExerciseRenderer = {
    /**
     * Render an exercise by ID
     */
    render: function(exerciseId, containerId) {
        const exercise = GAME_DATA.exercises?.[exerciseId];
        if (!exercise) {
            console.error('Exercise not found:', exerciseId);
            return;
        }

        const container = document.getElementById(containerId);
        if (!container) {
            console.error('Container not found:', containerId);
            return;
        }

        // Call appropriate renderer based on type
        const renderers = {
            'ranking': this.renderRanking,
            'calculator': this.renderCalculator,
            'quiz': this.renderQuiz,
            'reflection': this.renderReflection,
            'mapping': this.renderMapping,
            'scenario': this.renderScenario
        };

        const renderer = renderers[exercise.type];
        if (renderer) {
            container.innerHTML = renderer.call(this, exercise);
            this.attachEventListeners(exercise, containerId);
            // Enhance accessibility after rendering
            if (typeof enhanceExerciseAccessibility === 'function') {
                enhanceExerciseAccessibility(exercise.id);
            }
        } else {
            console.error('Unknown exercise type:', exercise.type);
        }
    },

    /**
     * Render ranking exercise
     */
    renderRanking: function(exercise) {
        const existingResponse = GameEngine.getExerciseResponse(exercise.id);
        // If we have saved ranking (array of IDs), map them back to full item objects
        let items = exercise.items;
        if (existingResponse?.ranking && Array.isArray(existingResponse.ranking)) {
            items = existingResponse.ranking.map(id =>
                exercise.items.find(item => item.id === id)
            ).filter(Boolean); // Remove any undefined items
        }

        let itemsHtml = items.map((item, index) => `
            <li class="ranking-item" data-id="${item.id}" draggable="true">
                <span class="ranking-handle">â˜°</span>
                <span class="ranking-number">${index + 1}</span>
                <div class="ranking-content">
                    <h4>${item.label}</h4>
                    <p>${item.description}</p>
                </div>
                <div class="ranking-move-buttons">
                    <button type="button" class="ranking-move-btn" onclick="ExerciseRenderer.moveRankingItem('${exercise.id}', '${item.id}', -1)">â–²</button>
                    <button type="button" class="ranking-move-btn" onclick="ExerciseRenderer.moveRankingItem('${exercise.id}', '${item.id}', 1)">â–¼</button>
                </div>
            </li>
        `).join('');

        let sociologyHtml = '';
        if (exercise.sociologyLink) {
            sociologyHtml = `
                <div class="sociology-link-box">
                    <h4>ðŸ“š Sociology Connection</h4>
                    <p>${exercise.sociologyLink.explanation}</p>
                    <cite>â€” Hammond ${exercise.sociologyLink.hammondRef}</cite>
                </div>
            `;
        }

        return `
            <div class="exercise-container" data-exercise-id="${exercise.id}">
                <div class="exercise-header">
                    <h3><span class="exercise-type-icon ranking">ðŸ“Š</span> ${exercise.title}</h3>
                    <p>${exercise.instructions}</p>
                </div>
                <div class="exercise-body">
                    <ul class="ranking-list" id="ranking-list-${exercise.id}">
                        ${itemsHtml}
                    </ul>
                    ${sociologyHtml}
                </div>
                <div class="exercise-footer">
                    ${exercise.skippable ? `<a href="#" class="exercise-skip-link" onclick="ExerciseRenderer.skipExercise('${exercise.id}'); return false;">Skip this exercise</a>` : '<span></span>'}
                    <button class="btn btn-primary" onclick="ExerciseRenderer.saveRanking('${exercise.id}')">Save Ranking</button>
                </div>
            </div>
        `;
    },

    /**
     * Render calculator exercise
     */
    renderCalculator: function(exercise) {
        const existingResponse = GameEngine.getExerciseResponse(exercise.id);
        const savedInputs = existingResponse?.inputs || {};

        // Handle both input types: number and select
        let inputsHtml = exercise.inputs.map(input => {
            const savedValue = savedInputs[input.id];
            const value = savedValue !== undefined ? savedValue : (input.default || '');

            if (input.type === 'select' && input.options) {
                // Render as dropdown
                const optionsHtml = input.options.map(opt => {
                    const selected = String(value) === String(opt.value) ? 'selected' : '';
                    return `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
                }).join('');

                return `
                    <div class="calculator-input-group">
                        <label for="calc-${exercise.id}-${input.id}">${input.label}</label>
                        <div class="calculator-input-wrapper">
                            <select id="calc-${exercise.id}-${input.id}"
                                    class="calculator-input calculator-select"
                                    data-input-id="${input.id}"
                                    onchange="ExerciseRenderer.calculateOutputs('${exercise.id}')">
                                <option value="">Select...</option>
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                `;
            } else {
                // Render as number input
                const wrapperClass = input.type === 'currency' ? 'calculator-input-wrapper currency' : 'calculator-input-wrapper';
                return `
                    <div class="calculator-input-group">
                        <label for="calc-${exercise.id}-${input.id}">${input.label}</label>
                        <div class="${wrapperClass}">
                            <input type="number"
                                   id="calc-${exercise.id}-${input.id}"
                                   class="calculator-input"
                                   data-input-id="${input.id}"
                                   value="${value}"
                                   min="${input.min || 0}"
                                   max="${input.max || 999999}"
                                   step="${input.step || 1}"
                                   onchange="ExerciseRenderer.calculateOutputs('${exercise.id}')">
                        </div>
                    </div>
                `;
            }
        }).join('');

        // Support both 'outputs' (Module 2) and 'calculations' (Module 4) field names
        const outputsArray = exercise.outputs || exercise.calculations || [];
        const isPercentFormat = outputsArray.some(o => o.format === 'percent');

        let outputsHtml = outputsArray.map(output => {
            const highlightClass = output.highlight ? 'highlight' : '';
            const defaultValue = output.format === 'percent' ? '0%' : '$0';
            const descriptionHtml = output.description ? `<span class="calculator-output-desc">${output.description}</span>` : '';
            return `
                <div class="calculator-output-item ${highlightClass}">
                    <div class="calculator-output-main">
                        <span class="calculator-output-label">${output.label}</span>
                        <span class="calculator-output-value" id="output-${exercise.id}-${output.id}">${defaultValue}</span>
                    </div>
                    ${descriptionHtml}
                </div>
            `;
        }).join('');

        let sociologyHtml = '';
        if (exercise.sociologyLink) {
            sociologyHtml = `
                <div class="sociology-link-box">
                    <h4>ðŸ“š Sociology Connection</h4>
                    <p>${exercise.sociologyLink.explanation}</p>
                    <cite>â€” Hammond ${exercise.sociologyLink.hammondRef}</cite>
                </div>
            `;
        }

        return `
            <div class="exercise-container" data-exercise-id="${exercise.id}">
                <div class="exercise-header">
                    <h3><span class="exercise-type-icon calculator">ðŸ§®</span> ${exercise.title}</h3>
                    <p>${exercise.instructions}</p>
                </div>
                <div class="exercise-body">
                    <div class="calculator-grid">
                        ${inputsHtml}
                    </div>
                    <div class="calculator-outputs">
                        <h4>Calculated Results</h4>
                        ${outputsHtml}
                        <div id="calc-interpretation-${exercise.id}" class="calculator-interpretation" style="display:none;"></div>
                    </div>
                    ${sociologyHtml}
                </div>
                <div class="exercise-footer">
                    ${exercise.skippable ? `<a href="#" class="exercise-skip-link" onclick="ExerciseRenderer.skipExercise('${exercise.id}'); return false;">Skip this exercise</a>` : '<span></span>'}
                    <button class="btn btn-primary" onclick="ExerciseRenderer.saveCalculator('${exercise.id}')">Save Calculations</button>
                </div>
            </div>
        `;
    },

    /**
     * Render quiz exercise
     */
    renderQuiz: function(exercise) {
        const existingResponse = GameEngine.state.comprehensionResults[exercise.id];

        let questionsHtml = exercise.questions.map((q, qIndex) => {
            let optionsHtml = q.options.map(opt => {
                const checked = existingResponse?.results?.[q.id]?.userAnswer === opt.id ? 'checked' : '';
                let optionClass = 'quiz-option';
                if (existingResponse) {
                    if (opt.correct) optionClass += ' correct';
                    else if (existingResponse.results[q.id]?.userAnswer === opt.id) optionClass += ' incorrect';
                }
                return `
                    <label class="${optionClass}">
                        <input type="radio" name="quiz-${exercise.id}-${q.id}" value="${opt.id}" ${checked} ${existingResponse ? 'disabled' : ''}>
                        <span class="quiz-option-text">${opt.text}</span>
                    </label>
                `;
            }).join('');

            let explanationHtml = '';
            if (existingResponse) {
                explanationHtml = `
                    <div class="quiz-explanation visible">
                        <h5>Explanation</h5>
                        <p>${q.explanation}</p>
                        <cite>${q.hammondRef}</cite>
                    </div>
                `;
            }

            return `
                <div class="quiz-question" data-question-id="${q.id}">
                    <div class="quiz-question-text">${qIndex + 1}. ${q.question}</div>
                    <div class="quiz-options">
                        ${optionsHtml}
                    </div>
                    ${explanationHtml}
                </div>
            `;
        }).join('');

        let resultHtml = '';
        if (existingResponse) {
            const resultClass = existingResponse.passed ? 'passed' : 'failed';
            const scorePercent = Math.round(existingResponse.score * 100);
            resultHtml = `
                <div class="quiz-result ${resultClass}">
                    <h4>${existingResponse.passed ? 'âœ… Passed!' : 'âŒ Not Passed'}</h4>
                    <p>Score: ${scorePercent}% (Attempt ${existingResponse.attempts} of ${exercise.maxAttempts})</p>
                </div>
            `;
        }

        return `
            <div class="exercise-container" data-exercise-id="${exercise.id}">
                <div class="exercise-header">
                    <h3><span class="exercise-type-icon quiz">â“</span> ${exercise.title}</h3>
                    <p>${exercise.instructions}</p>
                </div>
                <div class="exercise-body">
                    ${questionsHtml}
                    ${resultHtml}
                </div>
                <div class="exercise-footer">
                    <span class="quiz-attempts">Passing score: ${exercise.passingScore > 1 ? exercise.passingScore : Math.round((exercise.passingScore || 0.5) * 100)}%</span>
                    <button class="btn btn-primary" onclick="ExerciseRenderer.submitQuiz('${exercise.id}')" ${existingResponse?.passed ? 'disabled' : ''}>
                        ${existingResponse ? (existingResponse.passed ? 'Passed âœ“' : 'Retry Quiz') : 'Submit Answers'}
                    </button>
                </div>
            </div>
        `;
    },

    /**
     * Render reflection exercise
     */
    renderReflection: function(exercise) {
        const existingResponse = GameEngine.getExerciseResponse(exercise.id);
        const savedContent = existingResponse?.content || '';

        const tagsHtml = exercise.tags ? exercise.tags.map(tag => `<span class="reflection-tag">#${tag}</span>`).join('') : '';

        let sociologyHtml = '';
        if (exercise.sociologyLink) {
            sociologyHtml = `
                <div class="sociology-link-box">
                    <h4>ðŸ“š Sociology Connection</h4>
                    <p>${exercise.sociologyLink.explanation}</p>
                    <cite>â€” Hammond ${exercise.sociologyLink.hammondRef}</cite>
                </div>
            `;
        }

        return `
            <div class="exercise-container" data-exercise-id="${exercise.id}">
                <div class="exercise-header">
                    <h3><span class="exercise-type-icon reflection">ðŸ’­</span> ${exercise.title}</h3>
                    <p>${exercise.prompt}</p>
                </div>
                <div class="exercise-body">
                    <textarea id="reflection-${exercise.id}"
                              class="reflection-textarea"
                              placeholder="${exercise.placeholder || 'Write your reflection here...'}"
                              maxlength="${exercise.maxLength || 2000}"
                              oninput="ExerciseRenderer.updateCharCount('${exercise.id}')">${savedContent}</textarea>
                    <div class="reflection-meta">
                        <div class="reflection-tags">${tagsHtml}</div>
                        <span class="reflection-char-count" id="char-count-${exercise.id}">
                            ${savedContent.length}/${exercise.maxLength || 2000} characters
                            ${exercise.minLength ? `(min: ${exercise.minLength})` : ''}
                        </span>
                    </div>
                    ${sociologyHtml}
                </div>
                <div class="exercise-footer">
                    ${exercise.skippable ? `<a href="#" class="exercise-skip-link" onclick="ExerciseRenderer.skipExercise('${exercise.id}'); return false;">Skip this exercise</a>` : '<span></span>'}
                    <button class="btn btn-primary" onclick="ExerciseRenderer.saveReflection('${exercise.id}')">
                        ${exercise.journalEntry ? 'Save to Journal' : 'Save Reflection'}
                    </button>
                </div>
            </div>
        `;
    },

    /**
     * Render mapping exercise
     */
    renderMapping: function(exercise) {
        const existingData = GameEngine.state.mappingData[exercise.id];

        const nodeTypesHtml = exercise.nodeTypes.map(nt => `
            <div class="mapping-node-type" data-type="${nt.id}" onclick="ExerciseRenderer.selectNodeType('${exercise.id}', '${nt.id}')">
                <span class="mapping-node-icon">${nt.icon}</span>
                <span class="mapping-node-label">${nt.label}</span>
            </div>
        `).join('');

        // Connection types from exercise or defaults
        const connectionTypes = exercise.connectionTypes || [
            { id: 'close', label: 'Close/Supportive', color: '#27ae60' },
            { id: 'distant', label: 'Distant', color: '#95a5a6' },
            { id: 'conflict', label: 'Conflict/Tension', color: '#e74c3c' }
        ];
        const connectionTypesHtml = connectionTypes.map(ct => `
            <div class="mapping-connection-type" data-type="${ct.id}" onclick="ExerciseRenderer.selectConnectionType('${exercise.id}', '${ct.id}')" style="border-left: 4px solid ${ct.color};">
                <span class="mapping-conn-label">${ct.label}</span>
            </div>
        `).join('');

        const metricsHtml = exercise.metrics ? exercise.metrics.map(m => `
            <div class="mapping-metric">
                <span class="mapping-metric-label">${m.label}</span>
                <span class="mapping-metric-value" id="metric-${exercise.id}-${m.id}">0${m.format === 'percent' ? '%' : ''}</span>
            </div>
        `).join('') : '';

        let sociologyHtml = '';
        if (exercise.sociologyLink) {
            sociologyHtml = `
                <div class="sociology-link-box">
                    <h4>ðŸ“š Sociology Connection</h4>
                    <p>${exercise.sociologyLink.explanation}</p>
                    <cite>â€” Hammond ${exercise.sociologyLink.hammondRef}</cite>
                </div>
            `;
        }

        return `
            <div class="exercise-container" data-exercise-id="${exercise.id}">
                <div class="exercise-header">
                    <h3><span class="exercise-type-icon mapping">ðŸ—ºï¸</span> ${exercise.title}</h3>
                    <p>${exercise.instructions}</p>
                </div>
                <div class="exercise-body">
                    <div class="mapping-container">
                        <div class="mapping-sidebar">
                            <!-- Mode selector -->
                            <div class="mapping-mode-selector">
                                <button class="mapping-mode-btn active" data-mode="add" onclick="ExerciseRenderer.setMappingMode('${exercise.id}', 'add')">
                                    âž• Add
                                </button>
                                <button class="mapping-mode-btn" data-mode="connect" onclick="ExerciseRenderer.setMappingMode('${exercise.id}', 'connect')">
                                    ðŸ”— Connect
                                </button>
                                <button class="mapping-mode-btn" data-mode="delete" onclick="ExerciseRenderer.setMappingMode('${exercise.id}', 'delete')">
                                    ðŸ—‘ï¸ Delete
                                </button>
                            </div>

                            <!-- Status message -->
                            <div class="mapping-status add-mode" id="status-${exercise.id}">
                                Select a person type below, then click on the canvas to add them.
                            </div>

                            <!-- Add mode: node types -->
                            <div class="mapping-panel" id="panel-add-${exercise.id}">
                                <h4>Person Types</h4>
                                <div class="mapping-node-types">
                                    ${nodeTypesHtml}
                                </div>
                            </div>

                            <!-- Connect mode: connection types -->
                            <div class="mapping-panel" id="panel-connect-${exercise.id}" style="display:none;">
                                <h4>Connection Type</h4>
                                <div class="mapping-connection-types">
                                    ${connectionTypesHtml}
                                </div>
                                <p class="mapping-hint">Click first person, then click second person to connect.</p>
                            </div>

                            <!-- Delete mode: instructions -->
                            <div class="mapping-panel" id="panel-delete-${exercise.id}" style="display:none;">
                                <h4>Delete Mode</h4>
                                <p class="mapping-hint">Click a person to remove them.<br>Click a connection line to remove it.</p>
                            </div>

                            <div class="mapping-metrics">
                                <h4>Network Metrics</h4>
                                ${metricsHtml}
                            </div>
                        </div>
                        <div class="mapping-canvas-area" id="canvas-${exercise.id}" onclick="ExerciseRenderer.handleCanvasClick(event, '${exercise.id}')">
                            <svg class="mapping-canvas" id="svg-${exercise.id}"></svg>
                        </div>
                    </div>
                    ${sociologyHtml}
                </div>
                <div class="exercise-footer">
                    ${exercise.skippable ? `<a href="#" class="exercise-skip-link" onclick="ExerciseRenderer.skipExercise('${exercise.id}'); return false;">Skip this exercise</a>` : '<span></span>'}
                    <button class="btn btn-secondary" onclick="ExerciseRenderer.clearMapping('${exercise.id}')" style="margin-right:10px;">Clear All</button>
                    <button class="btn btn-primary" onclick="ExerciseRenderer.saveMapping('${exercise.id}')">Save Network</button>
                </div>
            </div>
        `;
    },

    /**
     * Render scenario exercise
     */
    renderScenario: function(exercise) {
        const existingResponse = GameEngine.state.scenarioPaths[exercise.id];

        const branchesHtml = exercise.branches.map(branch => {
            const selectedClass = existingResponse?.branchChosen === branch.id ? 'selected' : '';
            return `
                <div class="scenario-branch ${selectedClass}"
                     data-branch-id="${branch.id}"
                     onclick="ExerciseRenderer.selectBranch('${exercise.id}', '${branch.id}')">
                    <h4>${branch.label}</h4>
                    <p>${branch.description || branch.brief || ''}</p>
                </div>
            `;
        }).join('');

        let outcomeHtml = '';
        if (existingResponse) {
            const branch = exercise.branches.find(b => b.id === existingResponse.branchChosen);
            if (branch) {
                // Handle both old and new field naming conventions
                const advantageScore = branch.advantageChange ?? branch.consequences?.advantageScore ?? 0;
                const narrativeText = branch.consequence || branch.narrative || '';

                let consequenceClass = 'neutral';
                if (advantageScore > 0) consequenceClass = 'positive';
                else if (advantageScore < 0) consequenceClass = 'negative';

                outcomeHtml = `
                    <div class="scenario-outcome visible">
                        <h4>Your Choice: ${branch.label}</h4>
                        <p>${narrativeText}</p>
                        ${advantageScore !== 0 ? `
                            <div class="scenario-consequence ${consequenceClass}">
                                <strong>Advantage Impact:</strong> ${advantageScore > 0 ? '+' : ''}${advantageScore}
                            </div>
                        ` : ''}
                        <div class="sociology-link-box" style="margin-top:16px;">
                            <h4>ðŸ“š Sociology Connection</h4>
                            <p>${branch.sociologyLink?.explanation || ''}</p>
                            <cite>â€” Hammond ${branch.sociologyLink?.hammondRef || ''}</cite>
                        </div>
                    </div>
                `;
            }
        }

        return `
            <div class="exercise-container" data-exercise-id="${exercise.id}">
                <div class="exercise-header">
                    <h3><span class="exercise-type-icon scenario">ðŸ”€</span> ${exercise.title}</h3>
                </div>
                <div class="exercise-body">
                    <div class="scenario-setup">
                        <h4>âš¡ The Situation</h4>
                        <p>${exercise.setup}</p>
                    </div>
                    <div class="scenario-branches">
                        ${branchesHtml}
                    </div>
                    ${outcomeHtml}
                </div>
                <div class="exercise-footer">
                    <span></span>
                    <button class="btn btn-primary" onclick="ExerciseRenderer.confirmScenario('${exercise.id}')" ${existingResponse ? 'disabled' : ''}>
                        ${existingResponse ? 'Choice Made âœ“' : 'Confirm Choice'}
                    </button>
                </div>
            </div>
        `;
    },

    // ========== EVENT HANDLERS ==========

    attachEventListeners: function(exercise, containerId) {
        // Attach drag-and-drop for ranking
        if (exercise.type === 'ranking') {
            this.initRankingDragDrop(exercise.id);
        }
        // Calculate initial outputs for calculator
        if (exercise.type === 'calculator') {
            setTimeout(() => this.calculateOutputs(exercise.id), 100);
        }
        // Initialize mapping data
        if (exercise.type === 'mapping') {
            this.mappingState[exercise.id] = {
                mode: 'add',
                selectedType: null,
                selectedConnectionType: 'close',
                nodes: [],
                connections: [],
                selectedNode: null
            };
            // Load existing data if available
            const existingData = GameEngine.state.mappingData[exercise.id];
            if (existingData) {
                this.mappingState[exercise.id].nodes = existingData.nodes || [];
                this.mappingState[exercise.id].connections = existingData.connections || [];
                this.renderMappingNodes(exercise.id);
            }
            // Set default connection type as selected
            setTimeout(() => {
                const firstConnType = document.querySelector(`[data-exercise-id="${exercise.id}"] .mapping-connection-type`);
                if (firstConnType) firstConnType.classList.add('selected');
            }, 100);
        }
    },

    // Ranking handlers
    initRankingDragDrop: function(exerciseId) {
        const list = document.getElementById(`ranking-list-${exerciseId}`);
        if (!list) return;

        let draggedItem = null;

        list.querySelectorAll('.ranking-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                list.querySelectorAll('.ranking-item').forEach(i => i.classList.remove('drag-over'));
                this.updateRankingNumbers(exerciseId);
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (item !== draggedItem) {
                    item.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', () => {
                item.classList.remove('drag-over');
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (item !== draggedItem) {
                    const allItems = [...list.querySelectorAll('.ranking-item')];
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const targetIndex = allItems.indexOf(item);

                    if (draggedIndex < targetIndex) {
                        item.parentNode.insertBefore(draggedItem, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedItem, item);
                    }
                }
                item.classList.remove('drag-over');
            });
        });
    },

    moveRankingItem: function(exerciseId, itemId, direction) {
        const list = document.getElementById(`ranking-list-${exerciseId}`);
        const item = list.querySelector(`[data-id="${itemId}"]`);
        if (!item) return;

        const items = [...list.querySelectorAll('.ranking-item')];
        const index = items.indexOf(item);

        if (direction === -1 && index > 0) {
            item.parentNode.insertBefore(item, items[index - 1]);
        } else if (direction === 1 && index < items.length - 1) {
            item.parentNode.insertBefore(items[index + 1], item);
        }

        this.updateRankingNumbers(exerciseId);
    },

    updateRankingNumbers: function(exerciseId) {
        const list = document.getElementById(`ranking-list-${exerciseId}`);
        list.querySelectorAll('.ranking-item').forEach((item, index) => {
            item.querySelector('.ranking-number').textContent = index + 1;
        });
    },

    saveRanking: function(exerciseId) {
        const list = document.getElementById(`ranking-list-${exerciseId}`);
        const items = [...list.querySelectorAll('.ranking-item')].map(item => item.dataset.id);

        GameEngine.saveRankingResponse(exerciseId, items);
        this.showSaveConfirmation(exerciseId);
    },

    // Calculator handlers
    calculateOutputs: function(exerciseId) {
        const exercise = GAME_DATA.exercises[exerciseId];
        if (!exercise || exercise.type !== 'calculator') return;

        // Gather inputs from DOM
        const inputs = {};
        exercise.inputs.forEach(input => {
            const el = document.getElementById(`calc-${exerciseId}-${input.id}`);
            inputs[input.id] = parseFloat(el?.value) || 0;
        });

        // Support both data formats:
        // - Module 2 style: exercise.formulas (object) + exercise.outputs (array)
        // - Module 4 style: exercise.calculations (array with embedded formulas)
        const outputsArray = exercise.outputs || exercise.calculations || [];
        const formulas = exercise.formulas || {};

        // Build formulas from calculations array if no formulas object
        if (!exercise.formulas && exercise.calculations) {
            exercise.calculations.forEach(calc => {
                if (calc.formula) {
                    formulas[calc.id] = calc.formula;
                }
            });
        }

        // Calculate outputs using formulas
        const outputs = {};
        const context = { ...inputs, Math: Math }; // Include Math for formulas

        // Process formulas in order (important for dependent calculations)
        for (const output of outputsArray) {
            const formula = formulas[output.id] || output.formula;
            if (!formula) continue;

            try {
                // Create a function that evaluates the formula with context variables
                const varNames = Object.keys(context);
                const varValues = Object.values(context);
                const evalFunc = new Function(...varNames, `return ${formula}`);
                outputs[output.id] = evalFunc(...varValues);
                context[output.id] = outputs[output.id]; // Add to context for dependent calcs
            } catch (e) {
                console.error('Formula error for', output.id, ':', e);
                outputs[output.id] = 0;
            }
        }

        // Display outputs
        outputsArray.forEach(output => {
            const el = document.getElementById(`output-${exerciseId}-${output.id}`);
            if (el) {
                let value = outputs[output.id] || 0;
                if (output.format === 'currency') {
                    el.textContent = '$' + Math.round(value).toLocaleString();
                } else if (output.format === 'percent') {
                    el.textContent = Math.round(value) + '%';
                } else if (output.format === 'decimal') {
                    el.textContent = value.toFixed(output.decimals || 1);
                } else {
                    el.textContent = Math.round(value);
                }
            }
        });

        // Check interpretations (support both old and new format)
        const interpretationEl = document.getElementById(`calc-interpretation-${exerciseId}`);
        if (interpretationEl) {
            // Old format: exercise.interpretations (array with conditions)
            if (exercise.interpretations) {
                for (const interp of exercise.interpretations) {
                    try {
                        const varNames = Object.keys(outputs);
                        const varValues = Object.values(outputs);
                        const evalFunc = new Function(...varNames, `return ${interp.condition}`);
                        if (evalFunc(...varValues)) {
                            interpretationEl.innerHTML = interp.message;
                            interpretationEl.className = 'calculator-interpretation ' + interp.type;
                            interpretationEl.style.display = 'block';
                            break;
                        }
                    } catch (e) {
                        console.error('Interpretation error:', e);
                    }
                }
            }
            // New format: exercise.interpretation (object with thresholds)
            else if (exercise.interpretation) {
                const mainScore = outputs['homogamy_score'] || outputs['total'] || Object.values(outputs).pop() || 0;
                let message = '';
                let interpClass = '';

                if (mainScore >= (exercise.interpretation.high?.threshold || 75)) {
                    message = exercise.interpretation.high?.message || '';
                    interpClass = 'positive';
                } else if (mainScore >= (exercise.interpretation.medium?.threshold || 50)) {
                    message = exercise.interpretation.medium?.message || '';
                    interpClass = 'neutral';
                } else {
                    message = exercise.interpretation.low?.message || '';
                    interpClass = 'warning';
                }

                if (message) {
                    interpretationEl.innerHTML = message;
                    interpretationEl.className = 'calculator-interpretation ' + interpClass;
                    interpretationEl.style.display = 'block';
                }
            }
        }
    },

    saveCalculator: function(exerciseId) {
        const exercise = GAME_DATA.exercises[exerciseId];
        if (!exercise) return;

        const inputs = {};
        exercise.inputs.forEach(input => {
            const el = document.getElementById(`calc-${exerciseId}-${input.id}`);
            inputs[input.id] = parseFloat(el?.value) || 0;
        });

        // Support both data formats (same logic as calculateOutputs)
        const outputsArray = exercise.outputs || exercise.calculations || [];
        const formulas = exercise.formulas || {};

        // Build formulas from calculations array if no formulas object
        if (!exercise.formulas && exercise.calculations) {
            exercise.calculations.forEach(calc => {
                if (calc.formula) {
                    formulas[calc.id] = calc.formula;
                }
            });
        }

        // Calculate outputs
        const outputs = {};
        const context = { ...inputs, Math: Math };

        for (const output of outputsArray) {
            const formula = formulas[output.id] || output.formula;
            if (!formula) continue;

            try {
                const varNames = Object.keys(context);
                const varValues = Object.values(context);
                const evalFunc = new Function(...varNames, `return ${formula}`);
                outputs[output.id] = evalFunc(...varValues);
                context[output.id] = outputs[output.id];
            } catch (e) {
                outputs[output.id] = 0;
            }
        }

        GameEngine.saveCalculatorResponse(exerciseId, inputs, outputs);
        this.showSaveConfirmation(exerciseId);
    },

    // Quiz handlers
    submitQuiz: function(exerciseId) {
        const exercise = GAME_DATA.exercises[exerciseId];
        if (!exercise) return;

        const answers = {};
        exercise.questions.forEach(q => {
            const selected = document.querySelector(`input[name="quiz-${exerciseId}-${q.id}"]:checked`);
            if (selected) {
                answers[q.id] = selected.value;
            }
        });

        // Check if all questions answered
        if (Object.keys(answers).length < exercise.questions.length) {
            alert('Please answer all questions before submitting.');
            return;
        }

        const result = GameEngine.saveQuizResponse(exerciseId, answers);

        // Re-render quiz with results
        const container = document.querySelector(`[data-exercise-id="${exerciseId}"]`).parentElement;
        ExerciseRenderer.render(exerciseId, container.id);

        if (result.passed) {
            this.showSaveConfirmation(exerciseId, 'Quiz passed!');
        } else if (result.attempts >= exercise.maxAttempts) {
            alert(`Maximum attempts reached. The correct answers are now shown.`);
        } else {
            alert(`Score: ${Math.round(result.score * 100)}%. ${exercise.maxAttempts - result.attempts} attempts remaining.`);
        }
    },

    // Reflection handlers
    updateCharCount: function(exerciseId) {
        const textarea = document.getElementById(`reflection-${exerciseId}`);
        const counter = document.getElementById(`char-count-${exerciseId}`);
        const exercise = GAME_DATA.exercises[exerciseId];

        if (!textarea || !counter) return;

        const len = textarea.value.length;
        const max = exercise?.maxLength || 2000;
        const min = exercise?.minLength || 0;

        counter.textContent = `${len}/${max} characters${min ? ` (min: ${min})` : ''}`;

        if (len < min) {
            counter.className = 'reflection-char-count error';
        } else if (len > max * 0.9) {
            counter.className = 'reflection-char-count warning';
        } else if (len >= min) {
            counter.className = 'reflection-char-count success';
        } else {
            counter.className = 'reflection-char-count';
        }
    },

    saveReflection: function(exerciseId) {
        const textarea = document.getElementById(`reflection-${exerciseId}`);
        const exercise = GAME_DATA.exercises[exerciseId];

        if (!textarea) return;

        const content = textarea.value.trim();
        const minLength = exercise?.minLength || 0;

        if (content.length < minLength) {
            alert(`Please write at least ${minLength} characters.`);
            return;
        }

        // Get current module from section controller if available
        const moduleId = ModuleSectionController.currentModule || 2;

        GameEngine.saveReflectionResponse(exerciseId, content, moduleId);
        this.showSaveConfirmation(exerciseId, exercise?.journalEntry ? 'Added to journal!' : 'Reflection saved!');
    },

    // Mapping handlers
    mappingState: {},

    // Set mapping interaction mode
    setMappingMode: function(exerciseId, mode) {
        const state = this.mappingState[exerciseId];
        if (!state) return;

        state.mode = mode;
        state.selectedNode = null; // Clear selection when changing modes

        // Update mode buttons
        document.querySelectorAll(`[data-exercise-id="${exerciseId}"] .mapping-mode-btn`).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        // Show/hide appropriate panel
        ['add', 'connect', 'delete'].forEach(m => {
            const panel = document.getElementById(`panel-${m}-${exerciseId}`);
            if (panel) panel.style.display = m === mode ? 'block' : 'none';
        });

        // Update status message
        const statusMessages = {
            add: 'Select a person type below, then click on the canvas to add them.',
            connect: 'Select a connection type, then click two people to connect them.',
            delete: 'Click on a person or connection line to remove it.'
        };
        this.updateMappingStatus(exerciseId, statusMessages[mode]);

        this.renderMappingNodes(exerciseId);
    },

    // Select connection type for connect mode
    selectConnectionType: function(exerciseId, typeId) {
        const state = this.mappingState[exerciseId];
        if (!state) return;

        state.selectedConnectionType = typeId;

        // Update UI
        document.querySelectorAll(`[data-exercise-id="${exerciseId}"] .mapping-connection-type`).forEach(el => {
            el.classList.toggle('selected', el.dataset.type === typeId);
        });

        this.updateMappingStatus(exerciseId, `Connection type: ${typeId}. Click first person to start connecting.`);
    },

    selectNodeType: function(exerciseId, typeId) {
        const state = this.mappingState[exerciseId];
        if (!state) return;

        // Ensure we're in add mode
        if (state.mode !== 'add') {
            this.setMappingMode(exerciseId, 'add');
        }

        // Toggle selection
        if (state.selectedType === typeId) {
            state.selectedType = null;
            this.updateMappingStatus(exerciseId, 'Select a person type below, then click on the canvas to add them.');
        } else {
            state.selectedType = typeId;
            const exercise = GAME_DATA.exercises[exerciseId];
            const nodeType = exercise.nodeTypes.find(t => t.id === typeId);
            this.updateMappingStatus(exerciseId, `Adding: ${nodeType?.label || typeId}. Click on the canvas to place them.`);
        }

        // Update UI
        document.querySelectorAll(`[data-exercise-id="${exerciseId}"] .mapping-node-type`).forEach(el => {
            el.classList.toggle('selected', el.dataset.type === state.selectedType);
        });
    },

    updateMappingStatus: function(exerciseId, message) {
        const statusEl = document.getElementById(`status-${exerciseId}`);
        if (statusEl) {
            statusEl.textContent = message;
            // Update class based on current mode
            const state = this.mappingState[exerciseId];
            if (state) {
                statusEl.className = 'mapping-status ' + (state.mode || 'add') + '-mode';
            }
        }
    },

    handleCanvasClick: function(event, exerciseId) {
        const state = this.mappingState[exerciseId];
        if (!state) return;

        const canvas = document.getElementById(`canvas-${exerciseId}`);
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        const mode = state.mode || 'add';

        // Check if clicked on existing node
        const clickedNode = state.nodes.find(n => {
            const dx = n.x - x;
            const dy = n.y - y;
            return Math.sqrt(dx*dx + dy*dy) < 45;
        });

        if (mode === 'add') {
            // ADD MODE: Add new nodes
            if (clickedNode) {
                // Clicked on existing node - do nothing in add mode
                this.updateMappingStatus(exerciseId, 'That spot is taken. Click elsewhere to add a new person.');
                return;
            }
            if (state.selectedType) {
                const exercise = GAME_DATA.exercises[exerciseId];
                const nodeType = exercise.nodeTypes.find(t => t.id === state.selectedType);
                if (nodeType && state.nodes.length < (exercise.maxNodes || 15)) {
                    const name = prompt('Enter name for this person:');
                    if (name) {
                        state.nodes.push({
                            id: 'node_' + Date.now(),
                            type: state.selectedType,
                            name: name,
                            x: x,
                            y: y,
                            color: nodeType.color,
                            icon: nodeType.icon
                        });
                        this.updateMappingStatus(exerciseId, `Added ${name}. Click to add more or select a different type.`);
                    }
                } else if (state.nodes.length >= (exercise.maxNodes || 15)) {
                    this.updateMappingStatus(exerciseId, 'Maximum nodes reached. Delete some to add more.');
                }
            } else {
                this.updateMappingStatus(exerciseId, 'First select a person type from the list, then click here.');
            }
        } else if (mode === 'connect') {
            // CONNECT MODE: Create connections between nodes
            if (!clickedNode) {
                this.updateMappingStatus(exerciseId, 'Click on a person to start a connection.');
                return;
            }

            if (!state.selectedConnectionType) {
                this.updateMappingStatus(exerciseId, 'First select a connection type above.');
                return;
            }

            if (state.selectedNode && state.selectedNode !== clickedNode.id) {
                // Second click - create connection
                const existingConn = state.connections.find(c =>
                    (c.from === state.selectedNode && c.to === clickedNode.id) ||
                    (c.from === clickedNode.id && c.to === state.selectedNode)
                );
                if (existingConn) {
                    // Update existing connection type
                    existingConn.type = state.selectedConnectionType;
                    this.updateMappingStatus(exerciseId, 'Connection updated! Click another pair to connect.');
                } else {
                    // Create new connection
                    state.connections.push({
                        from: state.selectedNode,
                        to: clickedNode.id,
                        type: state.selectedConnectionType
                    });
                    this.updateMappingStatus(exerciseId, 'Connected! Click another pair to continue.');
                }
                state.selectedNode = null;
            } else {
                // First click - select node
                state.selectedNode = clickedNode.id;
                const node = state.nodes.find(n => n.id === clickedNode.id);
                this.updateMappingStatus(exerciseId, `Selected ${node?.name || 'person'}. Now click another person to connect.`);
            }
        } else if (mode === 'delete') {
            // DELETE MODE: Remove nodes
            if (clickedNode) {
                const node = state.nodes.find(n => n.id === clickedNode.id);
                if (confirm(`Delete ${node?.name || 'this person'}?`)) {
                    // Remove node
                    state.nodes = state.nodes.filter(n => n.id !== clickedNode.id);
                    // Remove connections involving this node
                    state.connections = state.connections.filter(c =>
                        c.from !== clickedNode.id && c.to !== clickedNode.id
                    );
                    this.updateMappingStatus(exerciseId, 'Deleted. Click another to delete more.');
                }
            }
        }

        this.renderMappingNodes(exerciseId);
        this.updateMappingMetrics(exerciseId);
    },

    // Delete a connection by index
    deleteConnection: function(exerciseId, connIndex) {
        const state = this.mappingState[exerciseId];
        if (!state || state.mode !== 'delete') return;

        if (confirm('Delete this connection?')) {
            state.connections.splice(connIndex, 1);
            this.renderMappingNodes(exerciseId);
            this.updateMappingMetrics(exerciseId);
            this.updateMappingStatus(exerciseId, 'Connection deleted.');
        }
    },

    renderMappingNodes: function(exerciseId) {
        const state = this.mappingState[exerciseId];
        const canvas = document.getElementById(`canvas-${exerciseId}`);
        const svg = document.getElementById(`svg-${exerciseId}`);

        if (!state || !canvas || !svg) return;

        const mode = state.mode || 'add';
        const isDeleteMode = mode === 'delete';

        // Clear existing
        canvas.querySelectorAll('.mapping-node').forEach(n => n.remove());
        svg.innerHTML = '';

        // Connection type colors
        const connColors = {
            'close': '#27ae60',
            'strong': '#27ae60',
            'distant': '#95a5a6',
            'weak': '#95a5a6',
            'conflict': '#e74c3c',
            'tension': '#e74c3c',
            'cutoff': '#2c3e50'
        };

        // Draw connections
        state.connections.forEach((conn, index) => {
            const fromNode = state.nodes.find(n => n.id === conn.from);
            const toNode = state.nodes.find(n => n.id === conn.to);
            if (fromNode && toNode) {
                const color = connColors[conn.type] || '#6c757d';

                // Create a group for the connection (line + clickable area)
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('mapping-connection-group');

                // Invisible wider line for easier clicking
                if (isDeleteMode) {
                    const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    hitArea.setAttribute('x1', fromNode.x);
                    hitArea.setAttribute('y1', fromNode.y);
                    hitArea.setAttribute('x2', toNode.x);
                    hitArea.setAttribute('y2', toNode.y);
                    hitArea.setAttribute('stroke', 'transparent');
                    hitArea.setAttribute('stroke-width', '20');
                    hitArea.style.cursor = 'pointer';
                    hitArea.onclick = () => this.deleteConnection(exerciseId, index);
                    g.appendChild(hitArea);
                }

                // Visible line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', fromNode.x);
                line.setAttribute('y1', fromNode.y);
                line.setAttribute('x2', toNode.x);
                line.setAttribute('y2', toNode.y);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', '3');

                // Dashed for distant/weak, dotted for conflict
                if (conn.type === 'distant' || conn.type === 'weak') {
                    line.setAttribute('stroke-dasharray', '8,4');
                } else if (conn.type === 'conflict' || conn.type === 'tension') {
                    line.setAttribute('stroke-dasharray', '4,4');
                } else if (conn.type === 'cutoff') {
                    line.setAttribute('stroke-dasharray', '2,6');
                }

                line.classList.add('mapping-connection');
                if (isDeleteMode) {
                    line.style.pointerEvents = 'none'; // Let hit area handle clicks
                    g.classList.add('deletable');
                }
                g.appendChild(line);
                svg.appendChild(g);
            }
        });

        // Draw nodes
        state.nodes.forEach(node => {
            const el = document.createElement('div');
            const isSelected = state.selectedNode === node.id;
            el.className = 'mapping-node' + (isSelected ? ' selected' : '') + (isDeleteMode ? ' deletable' : '');
            el.style.left = (node.x - 40) + 'px';
            el.style.top = (node.y - 40) + 'px';
            el.style.backgroundColor = node.color;
            el.innerHTML = `
                <span class="mapping-node-emoji">${node.icon}</span>
                <span class="mapping-node-name">${node.name}</span>
                ${isDeleteMode ? '<span class="delete-badge">âœ•</span>' : ''}
            `;
            el.onclick = (e) => {
                e.stopPropagation();
                this.handleCanvasClick({ clientX: e.clientX, clientY: e.clientY }, exerciseId);
            };
            canvas.appendChild(el);
        });
    },

    updateMappingMetrics: function(exerciseId) {
        const state = this.mappingState[exerciseId];
        const exercise = GAME_DATA.exercises[exerciseId];

        if (!state || !exercise?.metrics) return;

        exercise.metrics.forEach(m => {
            const el = document.getElementById(`metric-${exerciseId}-${m.id}`);
            if (el) {
                const value = GameEngine.evaluateMetric(m.formula, state.nodes, state.connections);
                if (m.format === 'percent') {
                    el.textContent = Math.round(value) + '%';
                } else {
                    el.textContent = Math.round(value);
                }
            }
        });
    },

    clearMapping: function(exerciseId) {
        if (confirm('Clear all nodes and connections?')) {
            this.mappingState[exerciseId] = {
                selectedType: null,
                nodes: [],
                connections: [],
                selectedNode: null
            };
            this.renderMappingNodes(exerciseId);
            this.updateMappingMetrics(exerciseId);
        }
    },

    saveMapping: function(exerciseId) {
        const state = this.mappingState[exerciseId];
        if (!state) return;

        const metrics = GameEngine.saveMappingResponse(exerciseId, state.nodes, state.connections);
        this.showSaveConfirmation(exerciseId);
    },

    // Scenario handlers
    selectBranch: function(exerciseId, branchId) {
        // Don't allow changing after confirmed
        if (GameEngine.state.scenarioPaths[exerciseId]) return;

        // Update UI
        document.querySelectorAll(`[data-exercise-id="${exerciseId}"] .scenario-branch`).forEach(el => {
            el.classList.toggle('selected', el.dataset.branchId === branchId);
        });
    },

    confirmScenario: function(exerciseId) {
        const selected = document.querySelector(`[data-exercise-id="${exerciseId}"] .scenario-branch.selected`);
        if (!selected) {
            alert('Please select an option first.');
            return;
        }

        const branchId = selected.dataset.branchId;
        const branch = GameEngine.saveScenarioResponse(exerciseId, branchId);

        // Re-render to show outcome
        const container = document.querySelector(`[data-exercise-id="${exerciseId}"]`).parentElement;
        ExerciseRenderer.render(exerciseId, container.id);
    },

    // Utility
    skipExercise: function(exerciseId) {
        const exercise = GAME_DATA.exercises[exerciseId];
        if (exercise?.skipWarning) {
            if (!confirm(exercise.skipWarning)) return;
        }

        GameEngine.saveExerciseResponse(exerciseId, { skipped: true });
        this.showSaveConfirmation(exerciseId, 'Exercise skipped');
    },

    showSaveConfirmation: function(exerciseId, message = 'Saved!') {
        // Trigger game state save to persist exercise data
        if (typeof saveGameState === 'function') {
            saveGameState(false);
        }

        // Announce to screen readers
        if (typeof announceToScreenReader === 'function') {
            announceToScreenReader(message);
        }

        const container = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
        if (!container) return;

        // Show brief confirmation
        const footer = container.querySelector('.exercise-footer');
        if (footer) {
            const existing = footer.querySelector('.save-confirmation');
            if (existing) existing.remove();

            const confirm = document.createElement('span');
            confirm.className = 'save-confirmation';
            confirm.style.cssText = 'color: var(--success); font-weight: 600; margin-right: 12px;';
            confirm.textContent = 'âœ“ ' + message;
            footer.insertBefore(confirm, footer.firstChild);

            setTimeout(() => confirm.remove(), 3000);
        }
    }
};


// ========== MODULE SECTION CONTROLLER ==========
// Manages the 10-section structure within each module

const ModuleSectionController = {
    currentModule: null,
    currentSection: null,
    sections: ['MODULE_INTRO', 'CONCEPT_INTRO', 'PRE_DECISION_EXERCISE', 'DECISION_1', 'COMPREHENSION_CHECK', 'REFLECTION_PROMPT', 'TRANSITION', 'DECISION_2', 'MODULE_SYNTHESIS', 'EXPORT_REMINDER'],

    /**
     * Initialize section controller for a module
     */
    init: function(moduleId) {
        this.currentModule = moduleId;

        // Get current section from state or start at beginning
        const savedProgress = GameEngine.state.sectionProgress[moduleId];
        this.currentSection = savedProgress?.currentSection || 'MODULE_INTRO';

        this.renderProgressBar(moduleId);
        this.renderSection(moduleId, this.currentSection);
    },

    /**
     * Render the progress bar
     */
    renderProgressBar: function(moduleId) {
        const container = document.getElementById(`module${moduleId}-section-progress`);
        if (!container) return;

        const moduleConfig = GAME_DATA.moduleSections?.[`module${moduleId}`];
        const sectionTypes = GAME_DATA.moduleSections?.sectionTypes;

        if (!moduleConfig || !sectionTypes) return;

        const completedSections = GameEngine.state.sectionProgress[moduleId]?.completedSections || [];

        let html = '<div class="section-progress-bar">';

        this.sections.forEach((sectionKey, index) => {
            const sectionType = sectionTypes[sectionKey];
            const isCompleted = completedSections.includes(sectionKey);
            const isCurrent = this.currentSection === sectionKey;
            const isLocked = index > 0 && !completedSections.includes(this.sections[index - 1]) && !isCurrent;

            let statusClass = '';
            if (isCompleted) statusClass = 'completed';
            else if (isCurrent) statusClass = 'current';
            else if (isLocked) statusClass = 'locked';

            html += `
                <div class="section-step ${statusClass}"
                     data-section="${sectionKey}"
                     onclick="ModuleSectionController.navigateToSection('${moduleId}', '${sectionKey}')">
                    <div class="section-step-indicator">
                        ${isCompleted ? 'âœ“' : index + 1}
                    </div>
                    <div class="section-step-label">${this.getSectionShortLabel(sectionKey)}</div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    },

    getSectionShortLabel: function(sectionKey) {
        const labels = {
            'MODULE_INTRO': 'Intro',
            'CONCEPT_INTRO': 'Concepts',
            'PRE_DECISION_EXERCISE': 'Activities',
            'DECISION_1': 'Decision 1',
            'COMPREHENSION_CHECK': 'Quiz',
            'REFLECTION_PROMPT': 'Reflect',
            'TRANSITION': 'Scenario',
            'DECISION_2': 'Decision 2',
            'MODULE_SYNTHESIS': 'Summary',
            'EXPORT_REMINDER': 'Export'
        };
        return labels[sectionKey] || sectionKey;
    },

    /**
     * Render section content
     */
    renderSection: function(moduleId, sectionKey) {
        const container = document.getElementById(`module${moduleId}-section-content`);
        if (!container) return;

        const moduleConfig = GAME_DATA.moduleSections?.[`module${moduleId}`];
        const sectionConfig = moduleConfig?.sections?.[sectionKey];

        if (!sectionConfig) {
            console.warn('Section config not found:', sectionKey);
            return;
        }

        // Manage visibility of existing decisions container
        const decisionsContainer = document.getElementById(`module${moduleId}-decisions-container`);
        const isDecisionSection = sectionKey === 'DECISION_1' || sectionKey === 'DECISION_2';

        if (decisionsContainer) {
            decisionsContainer.style.display = isDecisionSection ? 'block' : 'none';
        }

        let html = '';

        switch (sectionKey) {
            case 'MODULE_INTRO':
                html = this.renderModuleIntro(moduleId, moduleConfig, sectionConfig);
                break;
            case 'CONCEPT_INTRO':
                html = this.renderConceptIntro(moduleId, sectionConfig);
                break;
            case 'PRE_DECISION_EXERCISE':
                html = this.renderExercises(moduleId, sectionConfig);
                break;
            case 'COMPREHENSION_CHECK':
                html = this.renderExercises(moduleId, sectionConfig);
                break;
            case 'REFLECTION_PROMPT':
                html = this.renderExercises(moduleId, sectionConfig);
                break;
            case 'TRANSITION':
                html = this.renderExercises(moduleId, sectionConfig);
                break;
            case 'DECISION_1':
            case 'DECISION_2':
                html = this.renderDecisionPlaceholder(moduleId, sectionConfig, sectionKey);
                break;
            case 'MODULE_SYNTHESIS':
                html = this.renderSynthesis(moduleId, sectionConfig);
                break;
            case 'EXPORT_REMINDER':
                html = this.renderExportReminder(moduleId, sectionConfig);
                break;
        }

        // Add navigation
        html += this.renderNavigation(moduleId, sectionKey);

        container.innerHTML = html;

        // Render exercises after container is in DOM
        if (sectionConfig.exercises) {
            sectionConfig.exercises.forEach((exId, index) => {
                const exerciseContainer = document.getElementById(`exercise-container-${exId}`);
                if (exerciseContainer) {
                    ExerciseRenderer.render(exId, `exercise-container-${exId}`);
                }
            });
        }

        // Update state
        GameEngine.updateSectionProgress(moduleId, sectionKey);
    },

    renderModuleIntro: function(moduleId, moduleConfig, sectionConfig) {
        const objectivesHtml = sectionConfig.objectives?.map(obj => `<li>${obj}</li>`).join('') || '';

        return `
            <div class="module-intro-section">
                <h2 style="color: var(--navy); margin-bottom: 20px;">${moduleConfig.title}</h2>
                <div class="alert alert-info">
                    <strong>â±ï¸ Time:</strong> ${moduleConfig.estimatedTime} |
                    <strong>ðŸ“š Hammond:</strong> ${moduleConfig.hammondRef}
                </div>

                <div class="info-box" style="margin: 20px 0;">
                    <h3>ðŸŽ¯ Learning Objectives</h3>
                    <ul>${objectivesHtml}</ul>
                </div>

                ${sectionConfig.keyQuestion ? `
                    <div class="alert" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                        <strong>Key Question:</strong> ${sectionConfig.keyQuestion}
                    </div>
                ` : ''}
            </div>
        `;
    },

    renderConceptIntro: function(moduleId, sectionConfig) {
        let conceptsHtml = '';
        if (sectionConfig.concepts) {
            sectionConfig.concepts.forEach(conceptKey => {
                const concept = GAME_DATA.concepts?.[conceptKey];
                if (concept) {
                    conceptsHtml += `
                        <div class="concept-card" style="background: #f8f4ff; border-left: 4px solid var(--primary); padding: 16px; margin-bottom: 12px; border-radius: 0 8px 8px 0;">
                            <h4 style="color: var(--primary); margin: 0 0 8px 0;">${concept.term}</h4>
                            <p style="margin: 0; color: var(--text-dark);">${concept.definition}</p>
                            <cite style="font-size: 0.85em; color: #666;">â€” ${concept.hammondRef}</cite>
                        </div>
                    `;
                }
            });
        }

        let exampleHtml = '';
        if (sectionConfig.example) {
            exampleHtml = `
                <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; margin-top: 20px;">
                    <h4 style="color: #1565c0; margin: 0 0 8px 0;">ðŸ“Œ Example: ${sectionConfig.example.title}</h4>
                    <p style="margin: 0;">${sectionConfig.example.description}</p>
                </div>
            `;
        }

        return `
            <div class="concept-intro-section">
                <h3 style="color: var(--navy); margin-bottom: 20px;">ðŸ“š Key Concepts</h3>
                ${conceptsHtml}
                ${exampleHtml}
            </div>
        `;
    },

    renderExercises: function(moduleId, sectionConfig) {
        if (!sectionConfig.exercises?.length) {
            return '<p>No exercises configured for this section.</p>';
        }

        let html = '';
        if (sectionConfig.instruction) {
            html += `<p style="color: var(--text-dark); margin-bottom: 20px;">${sectionConfig.instruction}</p>`;
        }

        sectionConfig.exercises.forEach(exId => {
            html += `<div id="exercise-container-${exId}" class="exercise-wrapper"></div>`;
        });

        return html;
    },

    renderDecisionPlaceholder: function(moduleId, sectionConfig, sectionKey) {
        // Show the existing decisions container for this section
        const decisionsContainer = document.getElementById(`module${moduleId}-decisions-container`);
        if (decisionsContainer) {
            decisionsContainer.style.display = 'block';
        }

        // Return instruction text
        return `
            <div class="decision-section-intro">
                <p style="color: var(--text-dark); margin-bottom: 20px;">
                    <strong>${sectionKey === 'DECISION_1' ? 'First Decision Point' : 'Second Decision Point'}</strong>
                    ${sectionConfig.description ? ` â€” ${sectionConfig.description}` : ''}
                </p>
            </div>
        `;
    },

    renderSynthesis: function(moduleId, sectionConfig) {
        let conceptsHtml = '';
        if (sectionConfig.keyConcepts) {
            sectionConfig.keyConcepts.forEach(conceptKey => {
                const concept = GAME_DATA.concepts?.[conceptKey];
                if (concept) {
                    conceptsHtml += `<span class="reflection-tag" style="background: var(--primary); color: white;">${concept.term}</span> `;
                }
            });
        }

        return `
            <div class="module-synthesis-section">
                <div class="module-summary">
                    <h3>ðŸ“‹ Module Summary</h3>

                    ${conceptsHtml ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Key Concepts Covered:</strong><br>
                            ${conceptsHtml}
                        </div>
                    ` : ''}

                    <div class="summary-takeaway" style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 8px; margin: 16px 0;">
                        <strong>Key Takeaway:</strong>
                        <p style="margin: 8px 0 0 0;">${sectionConfig.takeaway || ''}</p>
                    </div>

                    ${sectionConfig.connectionToNext ? `
                        <div style="margin-top: 16px; font-style: italic; opacity: 0.9;">
                            <strong>Looking Ahead:</strong> ${sectionConfig.connectionToNext}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    },

    renderExportReminder: function(moduleId, sectionConfig) {
        return `
            <div class="export-reminder-section">
                <div class="alert" style="background: #ffe4e1; border-left: 4px solid #ff6b6b; padding: 20px;">
                    <h3 style="color: #c0392b; margin: 0 0 12px 0;">ðŸ’¾ ${sectionConfig.message || 'Export Required'}</h3>
                    <p style="margin: 0 0 20px 0;">Your progress is saved locally, but you must export your data for Canvas assignments.</p>
                    <button class="btn btn-primary" onclick="exportData('text')">Export Game Data</button>
                </div>
            </div>
        `;
    },

    renderNavigation: function(moduleId, currentSection) {
        const currentIndex = this.sections.indexOf(currentSection);
        const hasPrev = currentIndex > 0;
        const hasNext = currentIndex < this.sections.length - 1;

        return `
            <div class="section-nav">
                <div class="section-nav-left">
                    ${hasPrev ? `
                        <button class="btn btn-secondary" onclick="ModuleSectionController.prevSection('${moduleId}')">
                            â† Previous
                        </button>
                    ` : ''}
                </div>
                <div class="section-nav-right">
                    ${hasNext ? `
                        <button class="btn btn-primary" onclick="ModuleSectionController.nextSection('${moduleId}')">
                            ${currentSection === 'EXPORT_REMINDER' ? 'Complete Module' : 'Next â†’'}
                        </button>
                    ` : `
                        <button class="btn btn-success" onclick="ModuleSectionController.completeModule('${moduleId}')">
                            Complete Module âœ“
                        </button>
                    `}
                </div>
            </div>
        `;
    },

    navigateToSection: function(moduleId, sectionKey) {
        const currentIndex = this.sections.indexOf(this.currentSection);
        const targetIndex = this.sections.indexOf(sectionKey);
        const completedSections = GameEngine.state.sectionProgress[moduleId]?.completedSections || [];

        // Can navigate to completed sections or next section only
        if (completedSections.includes(sectionKey) || targetIndex <= currentIndex + 1) {
            this.currentSection = sectionKey;
            this.renderProgressBar(moduleId);
            this.renderSection(moduleId, sectionKey);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    },

    nextSection: function(moduleId) {
        const currentIndex = this.sections.indexOf(this.currentSection);
        if (currentIndex < this.sections.length - 1) {
            // Mark current as complete
            GameEngine.updateSectionProgress(moduleId, this.currentSection, true);

            // Move to next
            this.currentSection = this.sections[currentIndex + 1];
            this.renderProgressBar(moduleId);
            this.renderSection(moduleId, this.currentSection);
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Focus management for accessibility
            this.focusSectionContent(moduleId);

            // Announce section change to screen readers
            if (typeof announceToScreenReader === 'function') {
                const sectionLabel = this.getSectionShortLabel(this.currentSection);
                announceToScreenReader(`Now on ${sectionLabel} section`);
            }
        }
    },

    prevSection: function(moduleId) {
        const currentIndex = this.sections.indexOf(this.currentSection);
        if (currentIndex > 0) {
            this.currentSection = this.sections[currentIndex - 1];
            this.renderProgressBar(moduleId);
            this.renderSection(moduleId, this.currentSection);
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Focus management for accessibility
            this.focusSectionContent(moduleId);

            // Announce section change
            if (typeof announceToScreenReader === 'function') {
                const sectionLabel = this.getSectionShortLabel(this.currentSection);
                announceToScreenReader(`Back to ${sectionLabel} section`);
            }
        }
    },

    focusSectionContent: function(moduleId) {
        // Focus the first focusable element in the section content after a short delay
        setTimeout(() => {
            const container = document.getElementById(`module${moduleId}-section-content`);
            if (container) {
                const focusable = container.querySelector('h2, h3, button, input, textarea, [tabindex="0"]');
                if (focusable) {
                    focusable.focus();
                }
            }
        }, 100);
    },

    completeModule: function(moduleId) {
        // Mark all sections as complete
        this.sections.forEach(section => {
            GameEngine.updateSectionProgress(moduleId, section, true);
        });

        // Call existing module completion logic
        if (typeof window[`completeModule${moduleId}`] === 'function') {
            window[`completeModule${moduleId}`]();
        } else {
            alert('Module complete! Return to Module Hub.');
            showModuleHub();
        }
    }
};


// ========== INITIALIZE ALL NEW FEATURES ==========
document.addEventListener('DOMContentLoaded', function() {
    // Initialize accessibility features
    initAccessibility();

    // Initialize reflection journal
    setTimeout(() => {
        ReflectionJournal.init();
    }, 500);

    // Render save slots if container exists
    const slotsContainer = document.getElementById('save-slots-grid');
    if (slotsContainer) {
        SaveSlots.renderSlots();
    }
});

    </script>

    <!-- PRINT-ONLY SIGNATURE -->
    <div class="print-signature">
        <p><strong>Student Signature:</strong> ________________________________</p>
        <p><strong>Date Submitted:</strong> ________________________________</p>
        <p><strong>Canvas Assignment:</strong> Module ___ Game Reflection</p>
    </div>
</body>
</html>
